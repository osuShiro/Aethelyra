function Mash(){var t=4022871197,e=function(e){e=e.toString();for(var n=0;n<e.length;n++){t+=e.charCodeAt(n);var r=.02519603282416938*t;t=r>>>0,r-=t,r*=t,t=r>>>0,r-=t,t+=4294967296*r}return 2.3283064365386963e-10*(t>>>0)};return e.version="Mash 0.9",e}function Alea(){var t=Math.pow(2,32)-1;return this.next=function(t){var e=0,n=0,r=0,i=1;0==t.length&&(t=[+new Date]);var o=Mash();e=o(" "),n=o(" "),r=o(" ");for(var s=0;s<t.length;s++)e-=o(t[s]),0>e&&(e+=1),n-=o(t[s]),0>n&&(n+=1),r-=o(t[s]),0>r&&(r+=1);o=null;var a=function(){var t=2091639*e+2.3283064365386963e-10*i;return e=n,n=r,r=t-(i=0|t)};return a.uint32=function(){return 4294967296*a()},a.fract53=function(){return a()+1.1102230246251565e-16*(2097152*a()|0)},a.version="Alea 0.9",a.args=t,a}(Array.prototype.slice.call(arguments)),this.nextInt=function(e){return void 0==e&&(e=t),Math.floor(this.next()*e)},this}function BigInteger(t,e,n){null!=t&&("number"==typeof t?this.fromNumber(t,e,n):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}function nbi(){return new BigInteger(null)}function am1(t,e,n,r,i,o){for(;--o>=0;){var s=e*this[t++]+n[r]+i;i=Math.floor(s/67108864),n[r++]=67108863&s}return i}function am2(t,e,n,r,i,o){for(var s=32767&e,a=e>>15;--o>=0;){var l=32767&this[t],u=this[t++]>>15,c=a*l+u*s;l=s*l+((32767&c)<<15)+n[r]+(1073741823&i),i=(l>>>30)+(c>>>15)+a*u+(i>>>30),n[r++]=1073741823&l}return i}function am3(t,e,n,r,i,o){for(var s=16383&e,a=e>>14;--o>=0;){var l=16383&this[t],u=this[t++]>>14,c=a*l+u*s;l=s*l+((16383&c)<<14)+n[r]+i,i=(l>>28)+(c>>14)+a*u,n[r++]=268435455&l}return i}function int2char(t){return BI_RM.charAt(t)}function intAt(t,e){var n=BI_RC[t.charCodeAt(e)];return null==n?-1:n}function bnpCopyTo(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s}function bnpFromInt(t){this.t=1,this.s=0>t?-1:0,t>0?this[0]=t:-1>t?this[0]=t+this.DV:this.t=0}function nbv(t){var e=nbi();return e.fromInt(t),e}function bnpFromString(t,e){var n;if(16==e)n=4;else if(8==e)n=3;else if(256==e)n=8;else if(2==e)n=1;else if(32==e)n=5;else{if(4!=e)return void this.fromRadix(t,e);n=2}this.t=0,this.s=0;for(var r=t.length,i=!1,o=0;--r>=0;){var s=8==n?255&t[r]:intAt(t,r);0>s?"-"==t.charAt(r)&&(i=!0):(i=!1,0==o?this[this.t++]=s:o+n>this.DB?(this[this.t-1]|=(s&(1<<this.DB-o)-1)<<o,this[this.t++]=s>>this.DB-o):this[this.t-1]|=s<<o,o+=n,o>=this.DB&&(o-=this.DB))}8==n&&0!=(128&t[0])&&(this.s=-1,o>0&&(this[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),i&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t}function bnToString(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var n,r=(1<<e)-1,i=!1,o="",s=this.t,a=this.DB-s*this.DB%e;if(s-->0)for(a<this.DB&&(n=this[s]>>a)>0&&(i=!0,o=int2char(n));s>=0;)e>a?(n=(this[s]&(1<<a)-1)<<e-a,n|=this[--s]>>(a+=this.DB-e)):(n=this[s]>>(a-=e)&r,0>=a&&(a+=this.DB,--s)),n>0&&(i=!0),i&&(o+=int2char(n));return i?o:"0"}function bnNegate(){var t=nbi();return BigInteger.ZERO.subTo(this,t),t}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(t){var e=this.s-t.s;if(0!=e)return e;var n=this.t;if(e=n-t.t,0!=e)return this.s<0?-e:e;for(;--n>=0;)if(0!=(e=this[n]-t[n]))return e;return 0}function nbits(t){var e,n=1;return 0!=(e=t>>>16)&&(t=e,n+=16),0!=(e=t>>8)&&(t=e,n+=8),0!=(e=t>>4)&&(t=e,n+=4),0!=(e=t>>2)&&(t=e,n+=2),0!=(e=t>>1)&&(t=e,n+=1),n}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(t,e){var n;for(n=this.t-1;n>=0;--n)e[n+t]=this[n];for(n=t-1;n>=0;--n)e[n]=0;e.t=this.t+t,e.s=this.s}function bnpDRShiftTo(t,e){for(var n=t;n<this.t;++n)e[n-t]=this[n];e.t=Math.max(this.t-t,0),e.s=this.s}function bnpLShiftTo(t,e){var n,r=t%this.DB,i=this.DB-r,o=(1<<i)-1,s=Math.floor(t/this.DB),a=this.s<<r&this.DM;for(n=this.t-1;n>=0;--n)e[n+s+1]=this[n]>>i|a,a=(this[n]&o)<<r;for(n=s-1;n>=0;--n)e[n]=0;e[s]=a,e.t=this.t+s+1,e.s=this.s,e.clamp()}function bnpRShiftTo(t,e){e.s=this.s;var n=Math.floor(t/this.DB);if(n>=this.t)return void(e.t=0);var r=t%this.DB,i=this.DB-r,o=(1<<r)-1;e[0]=this[n]>>r;for(var s=n+1;s<this.t;++s)e[s-n-1]|=(this[s]&o)<<i,e[s-n]=this[s]>>r;r>0&&(e[this.t-n-1]|=(this.s&o)<<i),e.t=this.t-n,e.clamp()}function bnpSubTo(t,e){for(var n=0,r=0,i=Math.min(t.t,this.t);i>n;)r+=this[n]-t[n],e[n++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r-=t.s;n<this.t;)r+=this[n],e[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<t.t;)r-=t[n],e[n++]=r&this.DM,r>>=this.DB;r-=t.s}e.s=0>r?-1:0,-1>r?e[n++]=this.DV+r:r>0&&(e[n++]=r),e.t=n,e.clamp()}function bnpMultiplyTo(t,e){var n=this.abs(),r=t.abs(),i=n.t;for(e.t=i+r.t;--i>=0;)e[i]=0;for(i=0;i<r.t;++i)e[i+n.t]=n.am(0,r[i],e,i,0,n.t);e.s=0,e.clamp(),this.s!=t.s&&BigInteger.ZERO.subTo(e,e)}function bnpSquareTo(t){for(var e=this.abs(),n=t.t=2*e.t;--n>=0;)t[n]=0;for(n=0;n<e.t-1;++n){var r=e.am(n,e[n],t,2*n,0,1);(t[n+e.t]+=e.am(n+1,2*e[n],t,2*n+1,r,e.t-n-1))>=e.DV&&(t[n+e.t]-=e.DV,t[n+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(n,e[n],t,2*n,0,1)),t.s=0,t.clamp()}function bnpDivRemTo(t,e,n){var r=t.abs();if(!(r.t<=0)){var i=this.abs();if(i.t<r.t)return null!=e&&e.fromInt(0),void(null!=n&&this.copyTo(n));null==n&&(n=nbi());var o=nbi(),s=this.s,a=t.s,l=this.DB-nbits(r[r.t-1]);l>0?(r.lShiftTo(l,o),i.lShiftTo(l,n)):(r.copyTo(o),i.copyTo(n));var u=o.t,c=o[u-1];if(0!=c){var p=c*(1<<this.F1)+(u>1?o[u-2]>>this.F2:0),h=this.FV/p,d=(1<<this.F1)/p,f=1<<this.F2,g=n.t,m=g-u,v=null==e?nbi():e;for(o.dlShiftTo(m,v),n.compareTo(v)>=0&&(n[n.t++]=1,n.subTo(v,n)),BigInteger.ONE.dlShiftTo(u,v),v.subTo(o,o);o.t<u;)o[o.t++]=0;for(;--m>=0;){var y=n[--g]==c?this.DM:Math.floor(n[g]*h+(n[g-1]+f)*d);if((n[g]+=o.am(0,y,n,m,0,u))<y)for(o.dlShiftTo(m,v),n.subTo(v,n);n[g]<--y;)n.subTo(v,n)}null!=e&&(n.drShiftTo(u,e),s!=a&&BigInteger.ZERO.subTo(e,e)),n.t=u,n.clamp(),l>0&&n.rShiftTo(l,n),0>s&&BigInteger.ZERO.subTo(n,n)}}}function bnMod(t){var e=nbi();return this.abs().divRemTo(t,null,e),this.s<0&&e.compareTo(BigInteger.ZERO)>0&&t.subTo(e,e),e}function Classic(t){this.m=t}function cConvert(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t}function cRevert(t){return t}function cReduce(t){t.divRemTo(this.m,null,t)}function cMulTo(t,e,n){t.multiplyTo(e,n),this.reduce(n)}function cSqrTo(t,e){t.squareTo(e),this.reduce(e)}function bnpInvDigit(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return e=e*(2-(15&t)*e)&15,e=e*(2-(255&t)*e)&255,e=e*(2-((65535&t)*e&65535))&65535,e=e*(2-t*e%this.DV)%this.DV,e>0?this.DV-e:-e}function Montgomery(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}function montConvert(t){var e=nbi();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(BigInteger.ZERO)>0&&this.m.subTo(e,e),e}function montRevert(t){var e=nbi();return t.copyTo(e),this.reduce(e),e}function montReduce(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var n=32767&t[e],r=n*this.mpl+((n*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(n=e+this.m.t,t[n]+=this.m.am(0,r,t,e,0,this.m.t);t[n]>=t.DV;)t[n]-=t.DV,t[++n]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)}function montSqrTo(t,e){t.squareTo(e),this.reduce(e)}function montMulTo(t,e,n){t.multiplyTo(e,n),this.reduce(n)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(t,e){if(t>4294967295||1>t)return BigInteger.ONE;var n=nbi(),r=nbi(),i=e.convert(this),o=nbits(t)-1;for(i.copyTo(n);--o>=0;)if(e.sqrTo(n,r),(t&1<<o)>0)e.mulTo(r,i,n);else{var s=n;n=r,r=s}return e.revert(n)}function bnModPowInt(t,e){var n;return n=256>t||e.isEven()?new Classic(e):new Montgomery(e),this.exp(t,n)}function bnClone(){var t=nbi();return this.copyTo(t),t}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(t){return Math.floor(Math.LN2*this.DB/Math.log(t))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(t){if(null==t&&(t=10),0==this.signum()||2>t||t>36)return"0";var e=this.chunkSize(t),n=Math.pow(t,e),r=nbv(n),i=nbi(),o=nbi(),s="";for(this.divRemTo(r,i,o);i.signum()>0;)s=(n+o.intValue()).toString(t).substr(1)+s,i.divRemTo(r,i,o);return o.intValue().toString(t)+s}function bnpFromRadix(t,e){this.fromInt(0),null==e&&(e=10);for(var n=this.chunkSize(e),r=Math.pow(e,n),i=!1,o=0,s=0,a=0;a<t.length;++a){var l=intAt(t,a);0>l?"-"==t.charAt(a)&&0==this.signum()&&(i=!0):(s=e*s+l,++o>=n&&(this.dMultiply(r),this.dAddOffset(s,0),o=0,s=0))}o>0&&(this.dMultiply(Math.pow(e,o)),this.dAddOffset(s,0)),i&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(t,e,n){if("number"==typeof e)if(2>t)this.fromInt(1);else for(this.fromNumber(t,n),this.testBit(t-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(t-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>t&&this.subTo(BigInteger.ONE.shiftLeft(t-1),this);else{var r=new Array,i=7&t;r.length=(t>>3)+1,e.nextBytes(r),i>0?r[0]&=(1<<i)-1:r[0]=0,this.fromString(r,256)}}function bnToByteArray(){var t=this.t,e=new Array;e[0]=this.s;var n,r=this.DB-t*this.DB%8,i=0;if(t-->0)for(r<this.DB&&(n=this[t]>>r)!=(this.s&this.DM)>>r&&(e[i++]=n|this.s<<this.DB-r);t>=0;)8>r?(n=(this[t]&(1<<r)-1)<<8-r,n|=this[--t]>>(r+=this.DB-8)):(n=this[t]>>(r-=8)&255,0>=r&&(r+=this.DB,--t)),0!=(128&n)&&(n|=-256),0==i&&(128&this.s)!=(128&n)&&++i,(i>0||n!=this.s)&&(e[i++]=n);return e}function bnEquals(t){return 0==this.compareTo(t)}function bnMin(t){return this.compareTo(t)<0?this:t}function bnMax(t){return this.compareTo(t)>0?this:t}function bnpBitwiseTo(t,e,n){var r,i,o=Math.min(t.t,this.t);for(r=0;o>r;++r)n[r]=e(this[r],t[r]);if(t.t<this.t){for(i=t.s&this.DM,r=o;r<this.t;++r)n[r]=e(this[r],i);n.t=this.t}else{for(i=this.s&this.DM,r=o;r<t.t;++r)n[r]=e(i,t[r]);n.t=t.t}n.s=e(this.s,t.s),n.clamp()}function op_and(t,e){return t&e}function bnAnd(t){var e=nbi();return this.bitwiseTo(t,op_and,e),e}function op_or(t,e){return t|e}function bnOr(t){var e=nbi();return this.bitwiseTo(t,op_or,e),e}function op_xor(t,e){return t^e}function bnXor(t){var e=nbi();return this.bitwiseTo(t,op_xor,e),e}function op_andnot(t,e){return t&~e}function bnAndNot(t){var e=nbi();return this.bitwiseTo(t,op_andnot,e),e}function bnNot(){for(var t=nbi(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t}function bnShiftLeft(t){var e=nbi();return 0>t?this.rShiftTo(-t,e):this.lShiftTo(t,e),e}function bnShiftRight(t){var e=nbi();return 0>t?this.lShiftTo(-t,e):this.rShiftTo(t,e),e}function lbit(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function bnGetLowestSetBit(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+lbit(this[t]);return this.s<0?this.t*this.DB:-1}function cbit(t){for(var e=0;0!=t;)t&=t-1,++e;return e}function bnBitCount(){for(var t=0,e=this.s&this.DM,n=0;n<this.t;++n)t+=cbit(this[n]^e);return t}function bnTestBit(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)}function bnpChangeBit(t,e){var n=BigInteger.ONE.shiftLeft(t);return this.bitwiseTo(n,e,n),n}function bnSetBit(t){return this.changeBit(t,op_or)}function bnClearBit(t){return this.changeBit(t,op_andnot)}function bnFlipBit(t){return this.changeBit(t,op_xor)}function bnpAddTo(t,e){for(var n=0,r=0,i=Math.min(t.t,this.t);i>n;)r+=this[n]+t[n],e[n++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r+=t.s;n<this.t;)r+=this[n],e[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<t.t;)r+=t[n],e[n++]=r&this.DM,r>>=this.DB;r+=t.s}e.s=0>r?-1:0,r>0?e[n++]=r:-1>r&&(e[n++]=this.DV+r),e.t=n,e.clamp()}function bnAdd(t){var e=nbi();return this.addTo(t,e),e}function bnSubtract(t){var e=nbi();return this.subTo(t,e),e}function bnMultiply(t){var e=nbi();return this.multiplyTo(t,e),e}function bnSquare(){var t=nbi();return this.squareTo(t),t}function bnDivide(t){var e=nbi();return this.divRemTo(t,e,null),e}function bnRemainder(t){var e=nbi();return this.divRemTo(t,null,e),e}function bnDivideAndRemainder(t){var e=nbi(),n=nbi();return this.divRemTo(t,e,n),new Array(e,n)}function bnpDMultiply(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}}function NullExp(){}function nNop(t){return t}function nMulTo(t,e,n){t.multiplyTo(e,n)}function nSqrTo(t,e){t.squareTo(e)}function bnPow(t){return this.exp(t,new NullExp)}function bnpMultiplyLowerTo(t,e,n){var r=Math.min(this.t+t.t,e);for(n.s=0,n.t=r;r>0;)n[--r]=0;var i;for(i=n.t-this.t;i>r;++r)n[r+this.t]=this.am(0,t[r],n,r,0,this.t);for(i=Math.min(t.t,e);i>r;++r)this.am(0,t[r],n,r,0,e-r);n.clamp()}function bnpMultiplyUpperTo(t,e,n){--e;var r=n.t=this.t+t.t-e;for(n.s=0;--r>=0;)n[r]=0;for(r=Math.max(e-this.t,0);r<t.t;++r)n[this.t+r-e]=this.am(e-r,t[r],n,0,0,this.t+r-e);n.clamp(),n.drShiftTo(1,n)}function Barrett(t){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t),this.m=t}function barrettConvert(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=nbi();return t.copyTo(e),this.reduce(e),e}function barrettRevert(t){return t}function barrettReduce(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);t.compareTo(this.m)>=0;)t.subTo(this.m,t)}function barrettSqrTo(t,e){t.squareTo(e),this.reduce(e)}function barrettMulTo(t,e,n){t.multiplyTo(e,n),this.reduce(n)}function bnModPow(t,e){var n,r,i=t.bitLength(),o=nbv(1);if(0>=i)return o;n=18>i?1:48>i?3:144>i?4:768>i?5:6,r=8>i?new Classic(e):e.isEven()?new Barrett(e):new Montgomery(e);var s=new Array,a=3,l=n-1,u=(1<<n)-1;if(s[1]=r.convert(this),n>1){var c=nbi();for(r.sqrTo(s[1],c);u>=a;)s[a]=nbi(),r.mulTo(c,s[a-2],s[a]),a+=2}var p,h,d=t.t-1,f=!0,g=nbi();for(i=nbits(t[d])-1;d>=0;){for(i>=l?p=t[d]>>i-l&u:(p=(t[d]&(1<<i+1)-1)<<l-i,d>0&&(p|=t[d-1]>>this.DB+i-l)),a=n;0==(1&p);)p>>=1,--a;if((i-=a)<0&&(i+=this.DB,--d),f)s[p].copyTo(o),f=!1;else{for(;a>1;)r.sqrTo(o,g),r.sqrTo(g,o),a-=2;a>0?r.sqrTo(o,g):(h=o,o=g,g=h),r.mulTo(g,s[p],o)}for(;d>=0&&0==(t[d]&1<<i);)r.sqrTo(o,g),h=o,o=g,g=h,--i<0&&(i=this.DB-1,--d)}return r.revert(o)}function bnGCD(t){var e=this.s<0?this.negate():this.clone(),n=t.s<0?t.negate():t.clone();if(e.compareTo(n)<0){var r=e;e=n,n=r}var i=e.getLowestSetBit(),o=n.getLowestSetBit();if(0>o)return e;for(o>i&&(o=i),o>0&&(e.rShiftTo(o,e),n.rShiftTo(o,n));e.signum()>0;)(i=e.getLowestSetBit())>0&&e.rShiftTo(i,e),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),e.compareTo(n)>=0?(e.subTo(n,e),e.rShiftTo(1,e)):(n.subTo(e,n),n.rShiftTo(1,n));return o>0&&n.lShiftTo(o,n),n}function bnpModInt(t){if(0>=t)return 0;var e=this.DV%t,n=this.s<0?t-1:0;if(this.t>0)if(0==e)n=this[0]%t;else for(var r=this.t-1;r>=0;--r)n=(e*n+this[r])%t;return n}function bnModInverse(t){var e=t.isEven();if(this.isEven()&&e||0==t.signum())return BigInteger.ZERO;for(var n=t.clone(),r=this.clone(),i=nbv(1),o=nbv(0),s=nbv(0),a=nbv(1);0!=n.signum();){for(;n.isEven();)n.rShiftTo(1,n),e?(i.isEven()&&o.isEven()||(i.addTo(this,i),o.subTo(t,o)),i.rShiftTo(1,i)):o.isEven()||o.subTo(t,o),o.rShiftTo(1,o);for(;r.isEven();)r.rShiftTo(1,r),e?(s.isEven()&&a.isEven()||(s.addTo(this,s),a.subTo(t,a)),s.rShiftTo(1,s)):a.isEven()||a.subTo(t,a),a.rShiftTo(1,a);n.compareTo(r)>=0?(n.subTo(r,n),e&&i.subTo(s,i),o.subTo(a,o)):(r.subTo(n,r),e&&s.subTo(i,s),a.subTo(o,a))}return 0!=r.compareTo(BigInteger.ONE)?BigInteger.ZERO:a.compareTo(t)>=0?a.subtract(t):a.signum()<0?(a.addTo(t,a),a.signum()<0?a.add(t):a):a}function bnIsProbablePrime(t){var e,n=this.abs();if(1==n.t&&n[0]<=lowprimes[lowprimes.length-1]){for(e=0;e<lowprimes.length;++e)if(n[0]==lowprimes[e])return!0;return!1}if(n.isEven())return!1;for(e=1;e<lowprimes.length;){for(var r=lowprimes[e],i=e+1;i<lowprimes.length&&lplim>r;)r*=lowprimes[i++];for(r=n.modInt(r);i>e;)if(r%lowprimes[e++]==0)return!1}return n.millerRabin(t)}function bnpMillerRabin(t){var e=this.subtract(BigInteger.ONE),n=e.getLowestSetBit();if(0>=n)return!1;var r=e.shiftRight(n);t=t+1>>1,t>lowprimes.length&&(t=lowprimes.length);for(var i=nbi(),o=0;t>o;++o){i.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var s=i.modPow(r,this);if(0!=s.compareTo(BigInteger.ONE)&&0!=s.compareTo(e)){for(var a=1;a++<n&&0!=s.compareTo(e);)if(s=s.modPowInt(2,this),0==s.compareTo(BigInteger.ONE))return!1;if(0!=s.compareTo(e))return!1}}return!0}function parseBigInt(t,e){return new BigInteger(t,e)}function linebrk(t,e){for(var n="",r=0;r+e<t.length;)n+=t.substring(r,r+e)+"\n",r+=e;return n+t.substring(r,t.length)}function byte2Hex(t){return 16>t?"0"+t.toString(16):t.toString(16)}function pkcs1pad2(t,e){if(e<t.length+11)return alert("Message too long for RSA"),null;for(var n=new Array,r=t.length-1;r>=0&&e>0;){var i=t.charCodeAt(r--);128>i?n[--e]=i:i>127&&2048>i?(n[--e]=63&i|128,n[--e]=i>>6|192):(n[--e]=63&i|128,n[--e]=i>>6&63|128,n[--e]=i>>12|224)}n[--e]=0;for(var o=new SecureRandom,s=new Array;e>2;){for(s[0]=0;0==s[0];)o.nextBytes(s);n[--e]=s[0]}return n[--e]=2,n[--e]=0,new BigInteger(n)}function oaep_mgf1_arr(t,e,n){for(var r="",i=0;r.length<e;)r+=n(String.fromCharCode.apply(String,t.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return r}function oaep_pad(t,e,n){if(t.length+2*SHA1_SIZE+2>e)throw"Message too long for RSA";var r,i="";for(r=0;r<e-t.length-2*SHA1_SIZE-2;r+=1)i+="\x00";var o=rstr_sha1("")+i+""+t,s=new Array(SHA1_SIZE);(new SecureRandom).nextBytes(s);var a=oaep_mgf1_arr(s,o.length,n||rstr_sha1),l=[];for(r=0;r<o.length;r+=1)l[r]=o.charCodeAt(r)^a.charCodeAt(r);var u=oaep_mgf1_arr(l,s.length,rstr_sha1),c=[0];for(r=0;r<s.length;r+=1)c[r+1]=s[r]^u.charCodeAt(r);return new BigInteger(c.concat(l))}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(t,e){this.isPublic=!0,"string"!=typeof t?(this.n=t,this.e=e):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16)):alert("Invalid RSA public key")}function RSADoPublic(t){return t.modPowInt(this.e,this.n)}function RSAEncrypt(t){var e=pkcs1pad2(t,this.n.bitLength()+7>>3);if(null==e)return null;var n=this.doPublic(e);if(null==n)return null;var r=n.toString(16);return 0==(1&r.length)?r:"0"+r}function RSAEncryptOAEP(t,e){var n=oaep_pad(t,this.n.bitLength()+7>>3,e);if(null==n)return null;var r=this.doPublic(n);if(null==r)return null;var i=r.toString(16);return 0==(1&i.length)?i:"0"+i}function pkcs1unpad2(t,e){for(var n=t.toByteArray(),r=0;r<n.length&&0==n[r];)++r;if(n.length-r!=e-1||2!=n[r])return null;for(++r;0!=n[r];)if(++r>=n.length)return null;for(var i="";++r<n.length;){var o=255&n[r];128>o?i+=String.fromCharCode(o):o>191&&224>o?(i+=String.fromCharCode((31&o)<<6|63&n[r+1]),++r):(i+=String.fromCharCode((15&o)<<12|(63&n[r+1])<<6|63&n[r+2]),r+=2)}return i}function oaep_mgf1_str(t,e,n){for(var r="",i=0;r.length<e;)r+=n(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return r}function oaep_unpad(t,e,n){t=t.toByteArray();var r;for(r=0;r<t.length;r+=1)t[r]&=255;for(;t.length<e;)t.unshift(0);if(t=String.fromCharCode.apply(String,t),t.length<2*SHA1_SIZE+2)throw"Cipher too short";var r,i=t.substr(1,SHA1_SIZE),o=t.substr(SHA1_SIZE+1),s=oaep_mgf1_str(o,SHA1_SIZE,n||rstr_sha1),a=[];for(r=0;r<i.length;r+=1)a[r]=i.charCodeAt(r)^s.charCodeAt(r);var l=oaep_mgf1_str(String.fromCharCode.apply(String,a),t.length-SHA1_SIZE,rstr_sha1),u=[];for(r=0;r<o.length;r+=1)u[r]=o.charCodeAt(r)^l.charCodeAt(r);if(u=String.fromCharCode.apply(String,u),u.substr(0,SHA1_SIZE)!==rstr_sha1(""))throw"Hash mismatch";u=u.substr(SHA1_SIZE);var c=u.indexOf(""),p=-1!=c?u.substr(0,c).lastIndexOf("\x00"):-1;if(p+1!=c)throw"Malformed data";return u.substr(c+1)}function RSASetPrivate(t,e,n){this.isPrivate=!0,"string"!=typeof t?(this.n=t,this.e=e,this.d=n):null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(n,16)):alert("Invalid RSA private key")}function RSASetPrivateEx(t,e,n,r,i,o,s,a){if(this.isPrivate=!0,null==t)throw"RSASetPrivateEx N == null";if(null==e)throw"RSASetPrivateEx E == null";if(0==t.length)throw"RSASetPrivateEx N.length == 0";if(0==e.length)throw"RSASetPrivateEx E.length == 0";null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16),this.d=parseBigInt(n,16),this.p=parseBigInt(r,16),this.q=parseBigInt(i,16),this.dmp1=parseBigInt(o,16),this.dmq1=parseBigInt(s,16),this.coeff=parseBigInt(a,16)):alert("Invalid RSA private key in RSASetPrivateEx")}function RSAGenerate(t,e){var n=new SecureRandom,r=t>>1;this.e=parseInt(e,16);for(var i=new BigInteger(e,16);;){for(;this.p=new BigInteger(t-r,1,n),0!=this.p.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(r,1,n),0!=this.q.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var o=this.p;this.p=this.q,this.q=o}var s=this.p.subtract(BigInteger.ONE),a=this.q.subtract(BigInteger.ONE),l=s.multiply(a);if(0==l.gcd(i).compareTo(BigInteger.ONE)){this.n=this.p.multiply(this.q),this.d=i.modInverse(l),this.dmp1=this.d.mod(s),this.dmq1=this.d.mod(a),this.coeff=this.q.modInverse(this.p);break}}}function RSADoPrivate(t){if(null==this.p||null==this.q)return t.modPow(this.d,this.n);for(var e=t.mod(this.p).modPow(this.dmp1,this.p),n=t.mod(this.q).modPow(this.dmq1,this.q);e.compareTo(n)<0;)e=e.add(this.p);return e.subtract(n).multiply(this.coeff).mod(this.p).multiply(this.q).add(n)}function RSADecrypt(t){var e=parseBigInt(t,16),n=this.doPrivate(e);return null==n?null:pkcs1unpad2(n,this.n.bitLength()+7>>3)}function RSADecryptOAEP(t,e){var n=parseBigInt(t,16),r=this.doPrivate(n);return null==r?null:oaep_unpad(r,this.n.bitLength()+7>>3,e)}function hex2b64(t){var e,n,r="";for(e=0;e+3<=t.length;e+=3)n=parseInt(t.substring(e,e+3),16),r+=b64map.charAt(n>>6)+b64map.charAt(63&n);if(e+1==t.length?(n=parseInt(t.substring(e,e+1),16),r+=b64map.charAt(n<<2)):e+2==t.length&&(n=parseInt(t.substring(e,e+2),16),r+=b64map.charAt(n>>2)+b64map.charAt((3&n)<<4)),b64pad)for(;(3&r.length)>0;)r+=b64pad;return r}function b64tohex(t){var e,n,r,i="",o=0;for(e=0;e<t.length&&t.charAt(e)!=b64pad;++e)r=b64map.indexOf(t.charAt(e)),0>r||(0==o?(i+=int2char(r>>2),n=3&r,o=1):1==o?(i+=int2char(n<<2|r>>4),n=15&r,o=2):2==o?(i+=int2char(n),i+=int2char(r>>2),n=3&r,o=3):(i+=int2char(n<<2|r>>4),i+=int2char(15&r),o=0));return 1==o&&(i+=int2char(n<<2)),i}function b64toBA(t){var e,n=b64tohex(t),r=new Array;for(e=0;2*e<n.length;++e)r[e]=parseInt(n.substring(2*e,2*e+2),16);return r}function _rsapem_pemToBase64(t){var e=t;return e=e.replace("-----BEGIN RSA PRIVATE KEY-----",""),e=e.replace("-----END RSA PRIVATE KEY-----",""),e=e.replace(/[ \n]+/g,"")}function _rsapem_getPosArrayOfChildrenFromHex(t){var e=new Array,n=ASN1HEX.getStartPosOfV_AtObj(t,0),r=ASN1HEX.getPosOfNextSibling_AtObj(t,n),i=ASN1HEX.getPosOfNextSibling_AtObj(t,r),o=ASN1HEX.getPosOfNextSibling_AtObj(t,i),s=ASN1HEX.getPosOfNextSibling_AtObj(t,o),a=ASN1HEX.getPosOfNextSibling_AtObj(t,s),l=ASN1HEX.getPosOfNextSibling_AtObj(t,a),u=ASN1HEX.getPosOfNextSibling_AtObj(t,l),c=ASN1HEX.getPosOfNextSibling_AtObj(t,u);return e.push(n,r,i,o,s,a,l,u,c),e}function _rsapem_getHexValueArrayOfChildrenFromHex(t){var e=_rsapem_getPosArrayOfChildrenFromHex(t),n=ASN1HEX.getHexOfV_AtObj(t,e[0]),r=ASN1HEX.getHexOfV_AtObj(t,e[1]),i=ASN1HEX.getHexOfV_AtObj(t,e[2]),o=ASN1HEX.getHexOfV_AtObj(t,e[3]),s=ASN1HEX.getHexOfV_AtObj(t,e[4]),a=ASN1HEX.getHexOfV_AtObj(t,e[5]),l=ASN1HEX.getHexOfV_AtObj(t,e[6]),u=ASN1HEX.getHexOfV_AtObj(t,e[7]),c=ASN1HEX.getHexOfV_AtObj(t,e[8]),p=new Array;return p.push(n,r,i,o,s,a,l,u,c),p}function _rsapem_readPrivateKeyFromASN1HexString(t){var e=_rsapem_getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])}function _rsapem_readPrivateKeyFromPEMString(t){var e=_rsapem_pemToBase64(t),n=b64tohex(e),r=_rsapem_getHexValueArrayOfChildrenFromHex(n);this.setPrivateEx(r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])}function _rsasign_getHexPaddedDigestInfoForString(t,e,n){var r=function(t){return KJUR.crypto.Util.hashString(t,n)},i=r(t);return KJUR.crypto.Util.getPaddedDigestInfoHex(i,n,e)}function _zeroPaddingOfSignature(t,e){for(var n="",r=e/4-t.length,i=0;r>i;i++)n+="0";return n+t}function _rsasign_signString(t,e){var n=function(t){return KJUR.crypto.Util.hashString(t,e)},r=n(t);return this.signWithMessageHash(r,e)}function _rsasign_signWithMessageHash(t,e){var n=KJUR.crypto.Util.getPaddedDigestInfoHex(t,e,this.n.bitLength()),r=parseBigInt(n,16),i=this.doPrivate(r),o=i.toString(16);return _zeroPaddingOfSignature(o,this.n.bitLength())}function _rsasign_signStringWithSHA1(t){return _rsasign_signString.call(this,t,"sha1")}function _rsasign_signStringWithSHA256(t){return _rsasign_signString.call(this,t,"sha256")}function pss_mgf1_str(t,e,n){for(var r="",i=0;r.length<e;)r+=hextorstr(n(rstrtohex(t+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return r}function _rsasign_signStringPSS(t,e,n){var r=function(t){return KJUR.crypto.Util.hashHex(t,e)},i=r(rstrtohex(t));return void 0===n&&(n=-1),this.signWithMessageHashPSS(i,e,n)}function _rsasign_signWithMessageHashPSS(t,e,n){var r,i=hextorstr(t),o=i.length,s=this.n.bitLength()-1,a=Math.ceil(s/8),l=function(t){return KJUR.crypto.Util.hashHex(t,e)};if(-1===n||void 0===n)n=o;else if(-2===n)n=a-o-2;else if(-2>n)throw"invalid salt length";if(o+n+2>a)throw"data too long";var u="";n>0&&(u=new Array(n),(new SecureRandom).nextBytes(u),u=String.fromCharCode.apply(String,u));var c=hextorstr(l(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+i+u))),p=[];for(r=0;a-n-o-2>r;r+=1)p[r]=0;var h=String.fromCharCode.apply(String,p)+""+u,d=pss_mgf1_str(c,h.length,l),f=[];for(r=0;r<h.length;r+=1)f[r]=h.charCodeAt(r)^d.charCodeAt(r);var g=65280>>8*a-s&255;for(f[0]&=~g,r=0;o>r;r++)f.push(c.charCodeAt(r));return f.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(f)).toString(16),this.n.bitLength())}function _rsasign_getDecryptSignatureBI(t,e,n){var r=new RSAKey;r.setPublic(e,n);var i=r.doPublic(t);return i}function _rsasign_getHexDigestInfoFromSig(t,e,n){var r=_rsasign_getDecryptSignatureBI(t,e,n),i=r.toString(16).replace(/^1f+00/,"");return i}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(t){for(var e in KJUR.crypto.Util.DIGESTINFOHEAD){var n=KJUR.crypto.Util.DIGESTINFOHEAD[e],r=n.length;if(t.substring(0,r)==n){var i=[e,t.substring(r)];return i}}return[]}function _rsasign_verifySignatureWithArgs(t,e,n,r){var i=_rsasign_getHexDigestInfoFromSig(e,n,r),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=o[0],a=o[1],l=function(t){return KJUR.crypto.Util.hashString(t,s)},u=l(t);return a==u}function _rsasign_verifyHexSignatureForMessage(t,e){var n=parseBigInt(t,16),r=_rsasign_verifySignatureWithArgs(e,n,this.n.toString(16),this.e.toString(16));return r}function _rsasign_verifyString(t,e){e=e.replace(_RE_HEXDECONLY,""),e=e.replace(/[ \n]+/g,"");var n=parseBigInt(e,16);if(n.bitLength()>this.n.bitLength())return 0;var r=this.doPublic(n),i=r.toString(16).replace(/^1f+00/,""),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=o[0],a=o[1],l=function(t){return KJUR.crypto.Util.hashString(t,s)},u=l(t);return a==u}function _rsasign_verifyWithMessageHash(t,e){e=e.replace(_RE_HEXDECONLY,""),e=e.replace(/[ \n]+/g,"");var n=parseBigInt(e,16);if(n.bitLength()>this.n.bitLength())return 0;var r=this.doPublic(n),i=r.toString(16).replace(/^1f+00/,""),o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i);if(0==o.length)return!1;var s=(o[0],o[1]);return s==t}function _rsasign_verifyStringPSS(t,e,n,r){var i=function(t){return KJUR.crypto.Util.hashHex(t,n)},o=i(rstrtohex(t));return void 0===r&&(r=-1),this.verifyWithMessageHashPSS(o,e,n,r)}function _rsasign_verifyWithMessageHashPSS(t,e,n,r){var i=new BigInteger(e,16);if(i.bitLength()>this.n.bitLength())return!1;var o,s=function(t){return KJUR.crypto.Util.hashHex(t,n)},a=hextorstr(t),l=a.length,u=this.n.bitLength()-1,c=Math.ceil(u/8);if(-1===r||void 0===r)r=l;else if(-2===r)r=c-l-2;else if(-2>r)throw"invalid salt length";if(l+r+2>c)throw"data too long";var p=this.doPublic(i).toByteArray();for(o=0;o<p.length;o+=1)p[o]&=255;for(;p.length<c;)p.unshift(0);if(188!==p[c-1])throw"encoded message does not end in 0xbc";p=String.fromCharCode.apply(String,p);var h=p.substr(0,c-l-1),d=p.substr(h.length,l),f=65280>>8*c-u&255;if(0!==(h.charCodeAt(0)&f))throw"bits beyond keysize not zero";var g=pss_mgf1_str(d,h.length,s),m=[];for(o=0;o<h.length;o+=1)m[o]=h.charCodeAt(o)^g.charCodeAt(o);m[0]&=~f;var v=c-l-r-2;for(o=0;v>o;o+=1)if(0!==m[o])throw"leftmost octets not zero";if(1!==m[v])throw"0x01 marker not found";return d===hextorstr(s(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+a+String.fromCharCode.apply(String,m.slice(-r)))))}function X509(){this.subjectPublicKeyRSA=null,this.subjectPublicKeyRSA_hN=null,this.subjectPublicKeyRSA_hE=null,this.hex=null,this.getSerialNumberHex=function(){return ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,1])},this.getIssuerHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3])},this.getIssuerString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,3]))},this.getSubjectHex=function(){return ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5])},this.getSubjectString=function(){return X509.hex2dn(ASN1HEX.getDecendantHexTLVByNthList(this.hex,0,[0,5]))},this.getNotBefore=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,0]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.getNotAfter=function(){var t=ASN1HEX.getDecendantHexVByNthList(this.hex,0,[0,4,1]);return t=t.replace(/(..)/g,"%$1"),t=decodeURIComponent(t)},this.readCertPEM=function(t){var e=X509.pemToHex(t),n=X509.getPublicKeyHexArrayFromCertHex(e),r=new RSAKey;r.setPublic(n[0],n[1]),this.subjectPublicKeyRSA=r,this.subjectPublicKeyRSA_hN=n[0],this.subjectPublicKeyRSA_hE=n[1],this.hex=e},this.readCertPEMWithoutRSAInit=function(t){var e=X509.pemToHex(t),n=X509.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(n[0],n[1]),this.subjectPublicKeyRSA_hN=n[0],this.subjectPublicKeyRSA_hE=n[1],this.hex=e}}!function(t){function e(){a=!1}function n(){u&&(window.clearTimeout(p),u=!1,c=null)}function r(t){u||(u=!0,c=t.changedTouches[0],p=window.setTimeout("doRightClick();",800))}function i(t){var n=t.changedTouches,i=n[0],o="mouseover",u=document.createEvent("MouseEvent");u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),o="mousedown",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),a?(window.clearTimeout(l),i.target==s?(s=null,a=!1,o="click",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u),o="dblclick",u=document.createEvent("MouseEvent"),u.initMouseEvent(o,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),i.target.dispatchEvent(u)):(s=i.target,a=!0,l=window.setTimeout(function(){e()},600),r(t))):(s=i.target,a=!0,l=window.setTimeout(function(){e()},600),r(t))}function o(e){var r="",o=0;if(!(e.touches.length>1)){switch(e.type){case"touchstart":if(t(e.changedTouches[0].target).is("select"))return;return i(e),e.preventDefault(),!1;case"touchmove":n(),r="mousemove",e.preventDefault();break;case"touchend":if(h)return h=!1,e.preventDefault(),!1;n(),r="mouseup";break;default:return}var l=e.changedTouches,u=l[0],c=document.createEvent("MouseEvent");c.initMouseEvent(r,!0,!0,window,1,u.screenX,u.screenY,u.clientX,u.clientY,!1,!1,!1,!1,o,null),u.target.dispatchEvent(c),"mouseup"==r&&a&&u.target==s&&(c=document.createEvent("MouseEvent"),c.initMouseEvent("click",!0,!0,window,1,u.screenX,u.screenY,u.clientX,u.clientY,!1,!1,!1,!1,o,null),u.target.dispatchEvent(c))}}var s=null,a=!1,l=null,u=!1,c=null,p=null,h=!1;
t.extend(t.support,{touch:"ontouchend"in document}),t.fn.addTouch=function(){t.support.touch&&this.each(function(t,e){e.addEventListener("touchstart",o,!1),e.addEventListener("touchmove",o,!1),e.addEventListener("touchend",o,!1),e.addEventListener("touchcancel",o,!1)})},t.fn.addTouchLive=function(e){t.support.touch&&this.each(function(n,r){t(r).on("touchstart",e,function(t){o(t.originalEvent)}),t(r).on("touchmove",e,function(t){o(t.originalEvent)}),t(r).on("touchend",e,function(t){o(t.originalEvent)}),t(r).on("touchcancel",e,function(t){o(t.originalEvent)})})}}(jQuery),function(t,e,n,r,i,o,s){function a(t){var e,r,i=this,o=t.length,s=0,a=i.i=i.j=i.m=0;for(i.S=[],i.c=[],o||(t=[o++]);n>s;)i.S[s]=s++;for(s=0;n>s;s++)e=i.S[s],a=c(a+e+t[s%o]),r=i.S[a],i.S[s]=r,i.S[a]=e;i.g=function(t){var e=i.S,r=c(i.i+1),o=e[r],s=c(i.j+o),a=e[s];e[r]=a,e[s]=o;for(var l=e[c(o+a)];--t;)r=c(r+1),o=e[r],s=c(s+o),a=e[s],e[r]=a,e[s]=o,l=l*n+e[c(o+a)];return i.i=r,i.j=s,l},i.g(n)}function l(t,e,n,r,i){if(n=[],i=typeof t,e&&"object"==i)for(r in t)if(r.indexOf("S")<5)try{n.push(l(t[r],e-1))}catch(o){}return n.length?n:t+("string"!=i?"\x00":"")}function u(t,e,n,r){for(t+="",n=0,r=0;r<t.length;r++)e[c(r)]=c((n^=19*e[c(r)])+t.charCodeAt(r));t="";for(r in e)t+=String.fromCharCode(e[r]);return t}function c(t){return t&n-1}e.seedrandom=function(c,p){var h,d=[];c=u(l(p?[c,t]:arguments.length?c:[(new Date).getTime(),t,window],3),d),h=new a(d),u(h.S,t),e.random=function(){for(var t=h.g(r),e=s,a=0;i>t;)t=(t+a)*n,e*=n,a=h.g(1);for(;t>=o;)t/=2,e/=2,a>>>=1;return(t+a)/e};var f=function(t){if(0>t)throw"n must be non-negative";var e=Math.max(Math.ceil(Math.log(t)/Math.log(n)),1);if(e>r)throw"n cannot be greater than "+n+"^"+r;var i,o=Math.pow(n,e),s=t*Math.floor(o/t),a=0;do i=h.g(e),a++;while(i>=s&&100>a);return i%t};return Math.randomInt=f,f},s=e.pow(n,r),i=e.pow(2,i),o=2*i,u(e.random(),t)}([],Math,256,6,52);var dbits,canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr,vv;for(rr="0".charCodeAt(0),vv=0;9>=vv;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare;var SHA1_SIZE=20;RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,RSAKey.prototype.encryptOAEP=RSAEncryptOAEP,RSAKey.prototype.type="RSA";var SHA1_SIZE=20;RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,RSAKey.prototype.decrypt=RSADecrypt,RSAKey.prototype.decryptOAEP=RSADecryptOAEP;var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=",CryptoJS=CryptoJS||function(t,e){var n={},r=n.lib={},i=r.Base=function(){function t(){}return{extend:function(e){t.prototype=this;var n=new t;return e&&n.mixIn(e),n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),o=r.WordArray=i.extend({init:function(t,n){t=this.words=t||[],this.sigBytes=n!=e?n:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,n=t.words,r=this.sigBytes,i=t.sigBytes;if(this.clamp(),r%4)for(var o=0;i>o;o++){var s=n[o>>>2]>>>24-o%4*8&255;e[r+o>>>2]|=s<<24-(r+o)%4*8}else if(n.length>65535)for(var o=0;i>o;o+=4)e[r+o>>>2]=n[o>>>2];else e.push.apply(e,n);return this.sigBytes+=i,this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-n%4*8,e.length=t.ceil(n/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var n=[],r=0;e>r;r+=4)n.push(4294967296*t.random()|0);return new o.init(n,e)}}),s=n.enc={},a=s.Hex={stringify:function(t){for(var e=t.words,n=t.sigBytes,r=[],i=0;n>i;i++){var o=e[i>>>2]>>>24-i%4*8&255;r.push((o>>>4).toString(16)),r.push((15&o).toString(16))}return r.join("")},parse:function(t){for(var e=t.length,n=[],r=0;e>r;r+=2)n[r>>>3]|=parseInt(t.substr(r,2),16)<<24-r%8*4;return new o.init(n,e/2)}},l=s.Latin1={stringify:function(t){for(var e=t.words,n=t.sigBytes,r=[],i=0;n>i;i++){var o=e[i>>>2]>>>24-i%4*8&255;r.push(String.fromCharCode(o))}return r.join("")},parse:function(t){for(var e=t.length,n=[],r=0;e>r;r++)n[r>>>2]|=(255&t.charCodeAt(r))<<24-r%4*8;return new o.init(n,e)}},u=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(l.stringify(t)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(t){return l.parse(unescape(encodeURIComponent(t)))}},c=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=u.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var n=this._data,r=n.words,i=n.sigBytes,s=this.blockSize,a=4*s,l=i/a;l=e?t.ceil(l):t.max((0|l)-this._minBufferSize,0);var u=l*s,c=t.min(4*u,i);if(u){for(var p=0;u>p;p+=s)this._doProcessBlock(r,p);var h=r.splice(0,u);n.sigBytes-=c}return new o.init(h,c)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),p=(r.Hasher=c.extend({cfg:i.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){t&&this._append(t);var e=this._doFinalize();return e},blockSize:16,_createHelper:function(t){return function(e,n){return new t.init(n).finalize(e)}},_createHmacHelper:function(t){return function(e,n){return new p.HMAC.init(t,n).finalize(e)}}}),n.algo={});return n}(Math);!function(){var t=CryptoJS,e=t.lib,n=e.WordArray,r=e.Hasher,i=t.algo,o=[],s=i.SHA1=r.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],a=n[3],l=n[4],u=0;80>u;u++){if(16>u)o[u]=0|t[e+u];else{var c=o[u-3]^o[u-8]^o[u-14]^o[u-16];o[u]=c<<1|c>>>31}var p=(r<<5|r>>>27)+l+o[u];p+=20>u?(i&s|~i&a)+1518500249:40>u?(i^s^a)+1859775393:60>u?(i&s|i&a|s&a)-1894007588:(i^s^a)-899497514,l=a,a=s,s=i<<30|i>>>2,i=r,r=p}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+a|0,n[4]=n[4]+l|0},_doFinalize:function(){var t=this._data,e=t.words,n=8*this._nDataBytes,r=8*t.sigBytes;return e[r>>>5]|=128<<24-r%32,e[(r+64>>>9<<4)+14]=Math.floor(n/4294967296),e[(r+64>>>9<<4)+15]=n,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=r.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA1=r._createHelper(s),t.HmacSHA1=r._createHmacHelper(s)}(),RSAKey.prototype.readPrivateKeyFromPEMString=_rsapem_readPrivateKeyFromPEMString,RSAKey.prototype.readPrivateKeyFromASN1HexString=_rsapem_readPrivateKeyFromASN1HexString;var _RE_HEXDECONLY=new RegExp("");_RE_HEXDECONLY.compile("[^0-9a-f]","gi"),RSAKey.prototype.signWithMessageHash=_rsasign_signWithMessageHash,RSAKey.prototype.signString=_rsasign_signString,RSAKey.prototype.signStringWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signStringWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.sign=_rsasign_signString,RSAKey.prototype.signWithSHA1=_rsasign_signStringWithSHA1,RSAKey.prototype.signWithSHA256=_rsasign_signStringWithSHA256,RSAKey.prototype.signWithMessageHashPSS=_rsasign_signWithMessageHashPSS,RSAKey.prototype.signStringPSS=_rsasign_signStringPSS,RSAKey.prototype.signPSS=_rsasign_signStringPSS,RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.prototype.verifyWithMessageHash=_rsasign_verifyWithMessageHash,RSAKey.prototype.verifyString=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verify=_rsasign_verifyString,RSAKey.prototype.verifyHexSignatureForByteArrayMessage=_rsasign_verifyHexSignatureForMessage,RSAKey.prototype.verifyWithMessageHashPSS=_rsasign_verifyWithMessageHashPSS,RSAKey.prototype.verifyStringPSS=_rsasign_verifyStringPSS,RSAKey.prototype.verifyPSS=_rsasign_verifyStringPSS,RSAKey.SALT_LEN_RECOVER=-2;var ASN1HEX=new function(){this.getByteLengthOfL_AtObj=function(t,e){if("8"!=t.substring(e+2,e+3))return 1;var n=parseInt(t.substring(e+3,e+4));return 0==n?-1:n>0&&10>n?n+1:-2},this.getHexOfL_AtObj=function(t,e){var n=this.getByteLengthOfL_AtObj(t,e);return 1>n?"":t.substring(e+2,e+2+2*n)},this.getIntOfL_AtObj=function(t,e){var n=this.getHexOfL_AtObj(t,e);if(""==n)return-1;var r;return r=parseInt(n.substring(0,1))<8?new BigInteger(n,16):new BigInteger(n.substring(2),16),r.intValue()},this.getStartPosOfV_AtObj=function(t,e){var n=this.getByteLengthOfL_AtObj(t,e);return 0>n?n:e+2*(n+1)},this.getHexOfV_AtObj=function(t,e){var n=this.getStartPosOfV_AtObj(t,e),r=this.getIntOfL_AtObj(t,e);return t.substring(n,n+2*r)},this.getHexOfTLV_AtObj=function(t,e){var n=t.substr(e,2),r=this.getHexOfL_AtObj(t,e),i=this.getHexOfV_AtObj(t,e);return n+r+i},this.getPosOfNextSibling_AtObj=function(t,e){var n=this.getStartPosOfV_AtObj(t,e),r=this.getIntOfL_AtObj(t,e);return n+2*r},this.getPosArrayOfChildren_AtObj=function(t,e){var n=new Array,r=this.getStartPosOfV_AtObj(t,e);n.push(r);for(var i=this.getIntOfL_AtObj(t,e),o=r,s=0;;){var a=this.getPosOfNextSibling_AtObj(t,o);if(null==a||a-r>=2*i)break;if(s>=200)break;n.push(a),o=a,s++}return n},this.getNthChildIndex_AtObj=function(t,e,n){var r=this.getPosArrayOfChildren_AtObj(t,e);return r[n]},this.getDecendantIndexByNthList=function(t,e,n){if(0==n.length)return e;var r=n.shift(),i=this.getPosArrayOfChildren_AtObj(t,e);return this.getDecendantIndexByNthList(t,i[r],n)},this.getDecendantHexTLVByNthList=function(t,e,n){var r=this.getDecendantIndexByNthList(t,e,n);return this.getHexOfTLV_AtObj(t,r)},this.getDecendantHexVByNthList=function(t,e,n){var r=this.getDecendantIndexByNthList(t,e,n);return this.getHexOfV_AtObj(t,r)}};ASN1HEX.getVbyList=function(t,e,n,r){var i=this.getDecendantIndexByNthList(t,e,n);if(void 0===i)throw"can't find nthList object";if(void 0!==r&&t.substr(i,2)!=r)throw"checking tag doesn't match: "+t.substr(i,2)+"!="+r;return this.getHexOfV_AtObj(t,i)},X509.pemToBase64=function(t){var e=t;return e=e.replace("-----BEGIN CERTIFICATE-----",""),e=e.replace("-----END CERTIFICATE-----",""),e=e.replace(/[ \n]+/g,"")},X509.pemToHex=function(t){var e=X509.pemToBase64(t),n=b64tohex(e);return n},X509.getSubjectPublicKeyPosFromCertHex=function(t){var e=X509.getSubjectPublicKeyInfoPosFromCertHex(t);if(-1==e)return-1;var n=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=n.length)return-1;var r=n[1];if("03"!=t.substring(r,r+2))return-1;var i=ASN1HEX.getStartPosOfV_AtObj(t,r);return"00"!=t.substring(i,i+2)?-1:i+2},X509.getSubjectPublicKeyInfoPosFromCertHex=function(t){var e=ASN1HEX.getStartPosOfV_AtObj(t,0),n=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);return n.length<1?-1:"a003020102"==t.substring(n[0],n[0]+10)?n.length<6?-1:n[6]:n.length<5?-1:n[5]},X509.getPublicKeyHexArrayFromCertHex=function(t){var e=X509.getSubjectPublicKeyPosFromCertHex(t),n=ASN1HEX.getPosArrayOfChildren_AtObj(t,e);if(2!=n.length)return[];var r=ASN1HEX.getHexOfV_AtObj(t,n[0]),i=ASN1HEX.getHexOfV_AtObj(t,n[1]);return null!=r&&null!=i?[r,i]:[]},X509.getHexTbsCertificateFromCert=function(t){var e=ASN1HEX.getStartPosOfV_AtObj(t,0);return e},X509.getPublicKeyHexArrayFromCertPEM=function(t){var e=X509.pemToHex(t),n=X509.getPublicKeyHexArrayFromCertHex(e);return n},X509.hex2dn=function(t){for(var e="",n=ASN1HEX.getPosArrayOfChildren_AtObj(t,0),r=0;r<n.length;r++){var i=ASN1HEX.getHexOfTLV_AtObj(t,n[r]);e=e+"/"+X509.hex2rdn(i)}return e},X509.hex2rdn=function(t){var e=ASN1HEX.getDecendantHexTLVByNthList(t,0,[0,0]),n=ASN1HEX.getDecendantHexVByNthList(t,0,[0,1]),r="";try{r=X509.DN_ATTRHEX[e]}catch(i){r=e}n=n.replace(/(..)/g,"%$1");var o=decodeURIComponent(n);return r+"="+o},X509.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"},X509.getPublicKeyFromCertPEM=function(t){var e=X509.getPublicKeyInfoPropOfCertPEM(t);if("2a864886f70d010101"==e.algoid){var n=KEYUTIL.parsePublicRawRSAKeyHex(e.keyhex),r=new RSAKey;return r.setPublic(n.n,n.e),r}if("2a8648ce3d0201"==e.algoid){var i=KJUR.crypto.OID.oidhex2name[e.algparam],r=new KJUR.crypto.ECDSA({curve:i,info:e.keyhex});return r.setPublicKeyHex(e.keyhex),r}if("2a8648ce380401"==e.algoid){var o=ASN1HEX.getVbyList(e.algparam,0,[0],"02"),s=ASN1HEX.getVbyList(e.algparam,0,[1],"02"),a=ASN1HEX.getVbyList(e.algparam,0,[2],"02"),l=ASN1HEX.getHexOfV_AtObj(e.keyhex,0);l=l.substr(2);var r=new KJUR.crypto.DSA;return r.setPublic(new BigInteger(o,16),new BigInteger(s,16),new BigInteger(a,16),new BigInteger(l,16)),r}throw"unsupported key"},X509.getPublicKeyInfoPropOfCertPEM=function(t){var e={};e.algparam=null;var n=X509.pemToHex(t),r=ASN1HEX.getPosArrayOfChildren_AtObj(n,0);if(3!=r.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=n.substr(r[0],2))throw"malformed X.509 certificate PEM (code:002)";var i=ASN1HEX.getPosArrayOfChildren_AtObj(n,r[0]);if(i.length<7)throw"malformed X.509 certificate PEM (code:003)";var o=ASN1HEX.getPosArrayOfChildren_AtObj(n,i[6]);if(2!=o.length)throw"malformed X.509 certificate PEM (code:004)";var s=ASN1HEX.getPosArrayOfChildren_AtObj(n,o[0]);if(2!=s.length)throw"malformed X.509 certificate PEM (code:005)";if(e.algoid=ASN1HEX.getHexOfV_AtObj(n,s[0]),"06"==n.substr(s[1],2)?e.algparam=ASN1HEX.getHexOfV_AtObj(n,s[1]):"30"==n.substr(s[1],2)&&(e.algparam=ASN1HEX.getHexOfTLV_AtObj(n,s[1])),"03"!=n.substr(o[1],2))throw"malformed X.509 certificate PEM (code:006)";var a=ASN1HEX.getHexOfV_AtObj(n,o[1]);return e.keyhex=a.substr(2),e},"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"},this.getDigestInfoHex=function(t,e){if("undefined"==typeof this.DIGESTINFOHEAD[e])throw"alg not supported in Util.DIGESTINFOHEAD: "+e;return this.DIGESTINFOHEAD[e]+t},this.getPaddedDigestInfoHex=function(t,e,n){var r=this.getDigestInfoHex(t,e),i=n/4;if(r.length+22>i)throw"key is too short for SigAlg: keylen="+n+","+e;for(var o="0001",s="00"+r,a="",l=i-o.length-s.length,u=0;l>u;u+=2)a+="ff";var c=o+a+s;return c},this.hashString=function(t,e){var n=new KJUR.crypto.MessageDigest({alg:e});return n.digestString(t)},this.hashHex=function(t,e){var n=new KJUR.crypto.MessageDigest({alg:e});return n.digestHex(t)},this.sha1=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha1",prov:"cryptojs"});return e.digestString(t)},this.sha256=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});return e.digestString(t)},this.sha256Hex=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});return e.digestHex(t)},this.sha512=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"});return e.digestString(t)},this.sha512Hex=function(t){var e=new KJUR.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"});return e.digestHex(t)},this.md5=function(t){var e=new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"});return e.digestString(t)},this.ripemd160=function(t){var e=new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"});return e.digestString(t)},this.getCryptoJSMDByName=function(){}},KJUR.crypto.MessageDigest=function(params){var md=null,algName=null,provName=null;this.setAlgAndProvider=function(alg,prov){if(null!=alg&&void 0===prov&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(alg)&&"cryptojs"==prov){try{this.md=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[alg]).create()}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.md.update(e)},this.digest=function(){var t=this.md.finalize();return t.toString(CryptoJS.enc.Hex)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}if(-1!=":sha256:".indexOf(alg)&&"sjcl"==prov){try{this.md=new sjcl.hash.sha256}catch(ex){throw"setAlgAndProvider hash alg set fail alg="+alg+"/"+ex}this.updateString=function(t){this.md.update(t)},this.updateHex=function(t){var e=sjcl.codec.hex.toBits(t);this.md.update(e)},this.digest=function(){var t=this.md.finalize();return sjcl.codec.hex.fromBits(t)},this.digestString=function(t){return this.updateString(t),this.digest()},this.digestHex=function(t){return this.updateHex(t),this.digest()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==params&&void 0!==params.alg&&(this.algName=params.alg,void 0===params.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.Mac=function(params){var mac=null,pass=null,algName=null,provName=null,algProv=null;this.setAlgAndProvider=function(alg,prov){if(null==alg&&(alg="hmacsha1"),alg=alg.toLowerCase(),"hmac"!=alg.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+alg;void 0===prov&&(prov=KJUR.crypto.Util.DEFAULTPROVIDER[alg]),this.algProv=alg+"/"+prov;var hashAlg=alg.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(hashAlg)&&"cryptojs"==prov){try{var mdObj=eval(KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[hashAlg]);this.mac=CryptoJS.algo.HMAC.create(mdObj,this.pass)}catch(ex){throw"setAlgAndProvider hash alg set fail hashAlg="+hashAlg+"/"+ex}this.updateString=function(t){this.mac.update(t)},this.updateHex=function(t){var e=CryptoJS.enc.Hex.parse(t);this.mac.update(e)},this.doFinal=function(){var t=this.mac.finalize();return t.toString(CryptoJS.enc.Hex)},this.doFinalString=function(t){return this.updateString(t),this.doFinal()},this.doFinalHex=function(t){return this.updateHex(t),this.doFinal()}}},this.updateString=function(){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},void 0!==params&&(void 0!==params.pass&&(this.pass=params.pass),void 0!==params.alg&&(this.algName=params.alg,void 0===params.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(t){var e=null;if(this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())},this._zeroPaddingOfSignature=function(t,e){for(var n="",r=e/4-t.length,i=0;r>i;i++)n+="0";return n+t},this.setAlgAndProvider=function(t,e){if(this._setAlgNames(),"cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(n){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+n}this.init=function(t,e){var n=null;try{n=void 0===e?KEYUTIL.getKey(t):KEYUTIL.getKey(t,e)}catch(r){throw"init failed:"+r}if(n.isPrivate===!0)this.prvKey=n,this.state="SIGN";else{if(n.isPublic!==!0)throw"init failed.:"+n;this.pubKey=n,this.state="VERIFY"}},this.initSign=function(t){"string"==typeof t.ecprvhex&&"string"==typeof t.eccurvename?(this.ecprvhex=t.ecprvhex,this.eccurvename=t.eccurvename):this.prvKey=t,this.state="SIGN"},this.initVerifyByPublicKey=function(t){"string"==typeof t.ecpubhex&&"string"==typeof t.eccurvename?(this.ecpubhex=t.ecpubhex,this.eccurvename=t.eccurvename):t instanceof KJUR.crypto.ECDSA?this.pubKey=t:t instanceof RSAKey&&(this.pubKey=t),this.state="VERIFY"},this.initVerifyByCertificatePEM=function(t){var e=new X509;e.readCertPEM(t),this.pubKey=e.subjectPublicKeyRSA,this.state="VERIFY"},this.updateString=function(t){this.md.updateString(t)},this.updateHex=function(t){this.md.updateHex(t)},this.sign=function(){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename){var t=new KJUR.crypto.ECDSA({curve:this.eccurvename});this.hSign=t.signHex(this.sHashHex,this.ecprvhex)}else if("rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if("rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(t){this.updateString(t),this.sign()},this.signHex=function(t){this.updateHex(t),this.sign()},this.verify=function(t){if(this.sHashHex=this.md.digest(),"undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename){var e=new KJUR.crypto.ECDSA({curve:this.eccurvename});return e.verifyHex(this.sHashHex,t,this.ecpubhex)}if("rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,t,this.mdAlgName,this.pssSaltLen);if("rsa"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);if(this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,t);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.initVerifyByPublicKey=function(){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName},this.initVerifyByCertificatePEM=function(){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+this.algProvName},this.initSign=function(){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName},this.updateString=function(){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=t,void 0!==t&&(void 0!==t.alg&&(this.algName=t.alg,this.provName=void 0===t.prov?KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:t.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==t.psssaltlen&&(this.pssSaltLen=t.psssaltlen),void 0!==t.prvkeypem)){if(void 0!==t.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{var e=new RSAKey;e.readPrivateKeyFromPEMString(t.prvkeypem),this.initSign(e)}catch(n){throw"fatal error to load pem private key: "+n}}},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},function(){function t(e,n,r){if(e===n)return 0!==e||1/e==1/n;if(null==e||null==n)return e===n;if(e._chain&&(e=e._wrapped),n._chain&&(n=n._wrapped),e.isEqual&&S.isFunction(e.isEqual))return e.isEqual(n);if(n.isEqual&&S.isFunction(n.isEqual))return n.isEqual(e);var i=u.call(e);if(i!=u.call(n))return!1;switch(i){case"[object String]":return e==String(n);case"[object Number]":return e!=+e?n!=+n:0==e?1/e==1/n:e==+n;case"[object Date]":case"[object Boolean]":return+e==+n;case"[object RegExp]":return e.source==n.source&&e.global==n.global&&e.multiline==n.multiline&&e.ignoreCase==n.ignoreCase}if("object"!=typeof e||"object"!=typeof n)return!1;for(var o=r.length;o--;)if(r[o]==e)return!0;r.push(e);var s=0,a=!0;if("[object Array]"==i){if(s=e.length,a=s==n.length)for(;s--&&(a=s in e==s in n&&t(e[s],n[s],r)););}else{if("constructor"in e!="constructor"in n||e.constructor!=n.constructor)return!1;for(var l in e)if(S.has(e,l)&&(s++,!(a=S.has(n,l)&&t(e[l],n[l],r))))break;if(a){for(l in n)if(S.has(n,l)&&!s--)break;a=!s}}return r.pop(),a}var e=this,n=e._,r={},i=Array.prototype,o=Object.prototype,s=Function.prototype,a=i.slice,l=i.unshift,u=o.toString,c=o.hasOwnProperty,p=i.forEach,h=i.map,d=i.reduce,f=i.reduceRight,g=i.filter,m=i.every,v=i.some,y=i.indexOf,b=i.lastIndexOf,w=Array.isArray,x=Object.keys,_=s.bind,S=function(t){return new L(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.3.1";var E=S.each=S.forEach=function(t,e,n){if(null!=t)if(p&&t.forEach===p)t.forEach(e,n);else if(t.length===+t.length){for(var i=0,o=t.length;o>i;i++)if(i in t&&e.call(n,t[i],i,t)===r)return}else for(var s in t)if(S.has(t,s)&&e.call(n,t[s],s,t)===r)return};S.map=S.collect=function(t,e,n){var r=[];return null==t?r:h&&t.map===h?t.map(e,n):(E(t,function(t,i,o){r[r.length]=e.call(n,t,i,o)
}),t.length===+t.length&&(r.length=t.length),r)},S.reduce=S.foldl=S.inject=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),d&&t.reduce===d)return r&&(e=S.bind(e,r)),i?t.reduce(e,n):t.reduce(e);if(E(t,function(t,o,s){i?n=e.call(r,n,t,o,s):(n=t,i=!0)}),!i)throw new TypeError("Reduce of empty array with no initial value");return n},S.reduceRight=S.foldr=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),f&&t.reduceRight===f)return r&&(e=S.bind(e,r)),i?t.reduceRight(e,n):t.reduceRight(e);var o=S.toArray(t).reverse();return r&&!i&&(e=S.bind(e,r)),i?S.reduce(o,e,n,r):S.reduce(o,e)},S.find=S.detect=function(t,e,n){var r;return T(t,function(t,i,o){return e.call(n,t,i,o)?(r=t,!0):void 0}),r},S.filter=S.select=function(t,e,n){var r=[];return null==t?r:g&&t.filter===g?t.filter(e,n):(E(t,function(t,i,o){e.call(n,t,i,o)&&(r[r.length]=t)}),r)},S.reject=function(t,e,n){var r=[];return null==t?r:(E(t,function(t,i,o){e.call(n,t,i,o)||(r[r.length]=t)}),r)},S.every=S.all=function(t,e,n){var i=!0;return null==t?i:m&&t.every===m?t.every(e,n):(E(t,function(t,o,s){return(i=i&&e.call(n,t,o,s))?void 0:r}),i)};var T=S.some=S.any=function(t,e,n){e||(e=S.identity);var i=!1;return null==t?i:v&&t.some===v?t.some(e,n):(E(t,function(t,o,s){return i||(i=e.call(n,t,o,s))?r:void 0}),!!i)};S.include=S.contains=function(t,e){var n=!1;return null==t?n:y&&t.indexOf===y?-1!=t.indexOf(e):n=T(t,function(t){return t===e})},S.invoke=function(t,e){var n=a.call(arguments,2);return S.map(t,function(t){return(S.isFunction(e)?e||t:t[e]).apply(t,n)})},S.pluck=function(t,e){return S.map(t,function(t){return t[e]})},S.max=function(t,e,n){if(!e&&S.isArray(t))return Math.max.apply(Math,t);if(!e&&S.isEmpty(t))return-1/0;var r={computed:-1/0};return E(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s>=r.computed&&(r={value:t,computed:s})}),r.value},S.min=function(t,e,n){if(!e&&S.isArray(t))return Math.min.apply(Math,t);if(!e&&S.isEmpty(t))return 1/0;var r={computed:1/0};return E(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s<r.computed&&(r={value:t,computed:s})}),r.value},S.shuffle=function(t){var e,n=[];return E(t,function(t,r){0==r?n[0]=t:(e=Math.floor(Math.random()*(r+1)),n[r]=n[e],n[e]=t)}),n},S.sortBy=function(t,e,n){return S.pluck(S.map(t,function(t,r,i){return{value:t,criteria:e.call(n,t,r,i)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;return r>n?-1:n>r?1:0}),"value")},S.groupBy=function(t,e){var n={},r=S.isFunction(e)?e:function(t){return t[e]};return E(t,function(t,e){var i=r(t,e);(n[i]||(n[i]=[])).push(t)}),n},S.sortedIndex=function(t,e,n){n||(n=S.identity);for(var r=0,i=t.length;i>r;){var o=r+i>>1;n(t[o])<n(e)?r=o+1:i=o}return r},S.toArray=function(t){return t?t.toArray?t.toArray():S.isArray(t)?a.call(t):S.isArguments(t)?a.call(t):S.values(t):[]},S.size=function(t){return S.toArray(t).length},S.first=S.head=function(t,e,n){return null==e||n?t[0]:a.call(t,0,e)},S.initial=function(t,e,n){return a.call(t,0,t.length-(null==e||n?1:e))},S.last=function(t,e,n){return null==e||n?t[t.length-1]:a.call(t,Math.max(t.length-e,0))},S.rest=S.tail=function(t,e,n){return a.call(t,null==e||n?1:e)},S.compact=function(t){return S.filter(t,function(t){return!!t})},S.flatten=function(t,e){return S.reduce(t,function(t,n){return S.isArray(n)?t.concat(e?n:S.flatten(n)):(t[t.length]=n,t)},[])},S.without=function(t){return S.difference(t,a.call(arguments,1))},S.uniq=S.unique=function(t,e,n){var r=n?S.map(t,n):t,i=[];return S.reduce(r,function(n,r,o){return 0!=o&&(e===!0?S.last(n)==r:S.include(n,r))||(n[n.length]=r,i[i.length]=t[o]),n},[]),i},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=S.intersect=function(t){var e=a.call(arguments,1);return S.filter(S.uniq(t),function(t){return S.every(e,function(e){return S.indexOf(e,t)>=0})})},S.difference=function(t){var e=S.flatten(a.call(arguments,1));return S.filter(t,function(t){return!S.include(e,t)})},S.zip=function(){for(var t=a.call(arguments),e=S.max(S.pluck(t,"length")),n=new Array(e),r=0;e>r;r++)n[r]=S.pluck(t,""+r);return n},S.indexOf=function(t,e,n){if(null==t)return-1;var r,i;if(n)return r=S.sortedIndex(t,e),t[r]===e?r:-1;if(y&&t.indexOf===y)return t.indexOf(e);for(r=0,i=t.length;i>r;r++)if(r in t&&t[r]===e)return r;return-1},S.lastIndexOf=function(t,e){if(null==t)return-1;if(b&&t.lastIndexOf===b)return t.lastIndexOf(e);for(var n=t.length;n--;)if(n in t&&t[n]===e)return n;return-1},S.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=0,o=new Array(r);r>i;)o[i++]=t,t+=n;return o};var A=function(){};S.bind=function(t,e){if(t){var n,r;if(t.bind===_&&_)return _.apply(t,a.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return r=a.call(arguments,2),n=function(){if(!(this instanceof n))return t.apply(e,r.concat(a.call(arguments)));A.prototype=t.prototype;var i=new A,o=t.apply(i,r.concat(a.call(arguments)));return Object(o)===o?o:i}}},S.bindAll=function(t){var e=a.call(arguments,1);return 0==e.length&&(e=S.functions(t)),E(e,function(e){t[e]=S.bind(t[e],t)}),t},S.memoize=function(t,e){var n={};return e||(e=S.identity),function(){var r=e.apply(this,arguments);return S.has(n,r)?n[r]:n[r]=t.apply(this,arguments)}},S.delay=function(t,e){var n=a.call(arguments,2);return setTimeout(function(){return t.apply(t,n)},e)},S.defer=function(t){return S.delay.apply(S,[t,1].concat(a.call(arguments,1)))},S.throttle=function(t,e){var n,r,i,o,s,a=S.debounce(function(){s=o=!1},e);return function(){n=this,r=arguments;var l=function(){i=null,s&&t.apply(n,r),a()};i||(i=setTimeout(l,e)),o?s=!0:t.apply(n,r),a(),o=!0}},S.debounce=function(t,e){var n;return function(){var r=this,i=arguments,o=function(){n=null,t.apply(r,i)};clearTimeout(n),n=setTimeout(o,e)}},S.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments))}},S.wrap=function(t,e){return function(){var n=[t].concat(a.call(arguments,0));return e.apply(this,n)}},S.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},S.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},S.keys=x||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)S.has(t,n)&&(e[e.length]=n);return e},S.values=function(t){return S.map(t,S.identity)},S.functions=S.methods=function(t){var e=[];for(var n in t)S.isFunction(t[n])&&e.push(n);return e.sort()},S.extend=function(t){return E(a.call(arguments,1),function(e){for(var n in e)t[n]=e[n]}),t},S.defaults=function(t){return E(a.call(arguments,1),function(e){for(var n in e)null==t[n]&&(t[n]=e[n])}),t},S.clone=function(t){return S.isObject(t)?S.isArray(t)?t.slice():S.extend({},t):t},S.tap=function(t,e){return e(t),t},S.isEqual=function(e,n){return t(e,n,[])},S.isEmpty=function(t){if(S.isArray(t)||S.isString(t))return 0===t.length;for(var e in t)if(S.has(t,e))return!1;return!0},S.isElement=function(t){return!(!t||1!=t.nodeType)},S.isArray=w||function(t){return"[object Array]"==u.call(t)},S.isObject=function(t){return t===Object(t)},S.isArguments=function(t){return"[object Arguments]"==u.call(t)},S.isArguments(arguments)||(S.isArguments=function(t){return!(!t||!S.has(t,"callee"))}),S.isFunction=function(t){return"[object Function]"==u.call(t)},S.isString=function(t){return"[object String]"==u.call(t)},S.isNumber=function(t){return"[object Number]"==u.call(t)},S.isFinite=function(t){return S.isNumber(t)&&isFinite(t)},S.isNaN=function(t){return t!==t},S.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==u.call(t)},S.isDate=function(t){return"[object Date]"==u.call(t)},S.isRegExp=function(t){return"[object RegExp]"==u.call(t)},S.isNull=function(t){return null===t},S.isUndefined=function(t){return void 0===t},S.has=function(t,e){return c.call(t,e)},S.noConflict=function(){return e._=n,this},S.identity=function(t){return t},S.times=function(t,e,n){for(var r=0;t>r;r++)e.call(n,r)},S.escape=function(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},S.mixin=function(t){E(S.functions(t),function(e){k(e,S[e]=t[e])})};var C=0;S.uniqueId=function(t){var e=C++;return t?t+e:e},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/.^/,R=function(t){return t.replace(/\\\\/g,"\\").replace(/\\'/g,"'")};S.template=function(t,e){var n=S.templateSettings,r="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(n.escape||P,function(t,e){return"',_.escape("+R(e)+"),'"}).replace(n.interpolate||P,function(t,e){return"',"+R(e)+",'"}).replace(n.evaluate||P,function(t,e){return"');"+R(e).replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",i=new Function("obj","_",r);return e?i(e,S):function(t){return i.call(this,t,S)}},S.chain=function(t){return S(t).chain()};var L=function(t){this._wrapped=t};S.prototype=L.prototype;var M=function(t,e){return e?S(t).chain():t},k=function(t,e){L.prototype[t]=function(){var t=a.call(arguments);return l.call(t,this._wrapped),M(e.apply(S,t),this._chain)}};S.mixin(S),E(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=i[t];L.prototype[t]=function(){var n=this._wrapped;e.apply(n,arguments);var r=n.length;return"shift"!=t&&"splice"!=t||0!==r||delete n[0],M(n,this._chain)}}),E(["concat","join","slice"],function(t){var e=i[t];L.prototype[t]=function(){return M(e.apply(this._wrapped,arguments),this._chain)}}),L.prototype.chain=function(){return this._chain=!0,this},L.prototype.value=function(){return this._wrapped}}.call(this),function(t){function e(e,n){throw t.extend(e,n),e}function n(t){var e=[];if(d.call(t)!==a)return!1;for(var n=0,r=t.length;r>n;n++)e[n]=t[n].jqote_id;return e.length?e.sort().join(".").replace(/(\b\d+\b)\.(?:\1(\.|$))+/g,"$1$2"):!1}function r(e,n){var i,o=[],n=n||p,s=d.call(e);if(s===u)return e.jqote_id?[e]:!1;if(s!==a)return[t.jqotec(e,n)];if(s===a)for(var l=0,c=e.length;c>l;l++)(i=r(e[l],n))&&o.push(i[0]);return o.length?o:!1}var i="UndefinedTemplateError",o="TemplateCompilationError",s="TemplateExecutionError",a="[object Array]",l="[object String]",u="[object Function]",c=1,p="%",h=/^[^<]*(<[\w\W]+>)[^>]*$/,d=Object.prototype.toString;t.fn.extend({jqote:function(e,n){var e=d.call(e)===a?e:[e],r="";return this.each(function(i){for(var o=t.jqotec(this,n),s=0;s<e.length;s++)r+=o.call(e[s],i,s,e,o)}),r}}),t.each({app:"append",pre:"prepend",sub:"html"},function(e,i){t.fn["jqote"+e]=function(o,s,a){var l,u,c=t.jqote(o,s,a),p=h.test(c)?t:function(e){return t(document.createTextNode(e))};return(l=n(r(o)))&&(u=new RegExp("(^|\\.)"+l.split(".").join("\\.(.*)?")+"(\\.|$)")),this.each(function(){var n=p(c);t(this)[i](n),(3===n[0].nodeType?t(this):n).trigger("jqote."+e,[n,u])})}}),t.extend({jqote:function(t,n,o){var s="",l=r(t);l===!1&&e(new Error("Empty or undefined template passed to $.jqote "+t),{type:i}),n=d.call(n)!==a?[n]:n;for(var u=0,c=l.length;c>u;u++)for(var p=0;p<n.length;p++)s+=l[u].call(n[p],u,p,n,l[u]);return s},jqotec:function(n,r){var a,u,f,r=r||p,g=d.call(n);if(g===l&&h.test(n)){if(u=f=n,a=t.jqotecache[n])return a}else if(u=g===l||n.nodeType?t(n):n instanceof jQuery?n:null,u[0]&&((f=u[0].innerHTML)||(f=u.text()))||(console.log("Error finding template "+n),e(new Error("Empty or undefined template passed to $.jqotec"),{type:i})),a=t.jqotecache[t.data(u[0],"jqote_id")])return a;for(var m,v="",y=f.replace(/\s*<!\[CDATA\[\s*|\s*\]\]>\s*|[\r\n\t]/g,"").split("<"+r).join(r+">").split(r+">"),b=0,w=y.length;w>b;b++)v+=""!==y[b].charAt(0)?"out+='"+y[b].replace(/(\\|["'])/g,"\\$1")+"'":"="===y[b].charAt(1)?";out+=("+y[b].substr(2)+");":"!"===y[b].charAt(1)?";out+=$.jqotenc(("+y[b].substr(2)+"));":";"+y[b].substr(1);v="try{"+('var out="";'+v+";return out;").split("out+='';").join("").split('var out="";out+=').join("var out=")+'}catch(e){e.type="'+s+'";e.args=arguments;e.template=arguments.callee.toString();throw e;}';try{var x=new Function("i, j, data, fn",v)}catch(_){e(_,{type:o})}return m=u instanceof jQuery?t.data(u[0],"jqote_id",c):u,t.jqotecache[m]=(x.jqote_id=c++,x)},jqotefn:function(e){var n=d.call(e),r=n===l&&h.test(e)?e:t.data(t(e)[0],"jqote_id");return t.jqotecache[r]||!1},jqotetag:function(t){d.call(t)===l&&(p=t)},jqotenc:function(t){return t.toString().replace(/&(?!\w+;)/g,"&#38;").split("<").join("&#60;").split(">").join("&#62;").split('"').join("&#34;").split("'").join("&#39;")},jqotecache:{}}),t.event.special.jqote={add:function(t){var e,i=t.handler,o=t.data?d.call(t.data)!==a?[t.data]:t.data:[];t.namespace||(t.namespace="app.pre.sub"),o.length&&(e=n(r(o)))&&(t.handler=function(t,n,r){return!r||r.test(e)?i.apply(this,[t,n]):null})}}}(jQuery),$(function(){$.jqotetag("$")}),function(){var t,e=[].slice;t=function(){var t,n,r,i,o,s;return i=1<=arguments.length?e.call(arguments,0):[],o=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,i.length>0?(r=i[0],n=function(){var e;e=[];for(t in r)s=r[t],"callback"!==t&&e.push(" "+t+"='"+s+"'");return e}().join(""),this.replace(o,function(t,e,i){var o;return o=("function"==typeof r.callback?r.callback(i):void 0)||"<a href='"+i+"'"+n+">"+i+"</a>",""+e+o})):this.replace(o,"$1<a href='$2'>$2</a>")},String.prototype.autoLink=t}.call(this);var CSS_PROP_BIT_QUANTITY=1,CSS_PROP_BIT_HASH_VALUE=2,CSS_PROP_BIT_NEGATIVE_QUANTITY=4,CSS_PROP_BIT_QSTRING_CONTENT=8,CSS_PROP_BIT_QSTRING_URL=16,CSS_PROP_BIT_HISTORY_INSENSITIVE=32,CSS_PROP_BIT_Z_INDEX=64,CSS_PROP_BIT_ALLOWED_IN_LINK=128,cssSchema=function(){var t=["rgb(?:\\(\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)|a\\(\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0|\\d+(?:\\.\\d+)?%)\\s*,\\s*(?:\\d+|0(?:\\.\\d+)?|\\.\\d+|1(?:\\.0+)?|0|\\d+(?:\\.\\d+)?%)) *\\)"],e=[/^ *$/i,RegExp("^ *\\s*"+t[0]+" *$","i"),RegExp("^ *(?:\\s*"+t[0]+"|(?:\\s*"+t[0]+")?)+ *$","i")],n=[["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgreen","lightgrey","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"],["all-scroll","col-resize","crosshair","default","e-resize","hand","help","move","n-resize","ne-resize","no-drop","not-allowed","nw-resize","pointer","progress","row-resize","s-resize","se-resize","sw-resize","text","vertical-text","w-resize","wait"],["-moz-inline-box","-moz-inline-stack","block","inline","inline-block","inline-table","list-item","run-in","table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row","table-row-group"],["armenian","circle","decimal","decimal-leading-zero","disc","georgian","lower-alpha","lower-greek","lower-latin","lower-roman","square","upper-alpha","upper-latin","upper-roman"],["100","200","300","400","500","600","700","800","900","bold","bolder","lighter"],["condensed","expanded","extra-condensed","extra-expanded","narrower","semi-condensed","semi-expanded","ultra-condensed","ultra-expanded","wider"],["behind","center-left","center-right","far-left","far-right","left-side","leftwards","right-side","rightwards"],["large","larger","small","smaller","x-large","x-small","xx-large","xx-small"],["-moz-pre-wrap","-o-pre-wrap","-pre-wrap","nowrap","pre","pre-line","pre-wrap"],["dashed","dotted","double","groove","outset","ridge","solid"],["baseline","middle","sub","super","text-bottom","text-top"],["caption","icon","menu","message-box","small-caption","status-bar"],["fast","faster","slow","slower","x-fast","x-slow"],["above","below","higher","level","lower"],["border-box","contain","content-box","cover","padding-box"],["cursive","fantasy","monospace","sans-serif","serif"],["loud","silent","soft","x-loud","x-soft"],["no-repeat","repeat-x","repeat-y","round","space"],["blink","line-through","overline","underline"],["high","low","x-high","x-low"],["absolute","relative","static"],["capitalize","lowercase","uppercase"],["child","female","male"],["bidi-override","embed"],["bottom","top"],["clip","ellipsis"],["continuous","digits"],["hide","show"],["inside","outside"],["italic","oblique"],["left","right"],["ltr","rtl"],["no-content","no-display"],["suppress","unrestricted"],["thick","thin"],[","],["/"],["always"],["auto"],["avoid"],["both"],["break-word"],["center"],["code"],["collapse"],["fixed"],["hidden"],["inherit"],["inset"],["invert"],["justify"],["local"],["medium"],["mix"],["none"],["normal"],["once"],["repeat"],["scroll"],["separate"],["small-caps"],["spell-out"],["transparent"],["visible"]];return{"-moz-border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[36]]},"-moz-border-radius-bottomleft":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-bottomright":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-topleft":{cssExtra:e[0],cssPropBits:5},"-moz-border-radius-topright":{cssExtra:e[0],cssPropBits:5},"-moz-box-shadow":{cssExtra:e[2],cssAlternates:["boxShadow"],cssPropBits:7,cssLitGroup:[n[0],n[35],n[48],n[54]]},"-moz-opacity":{cssPropBits:1,cssLitGroup:[n[47]]},"-moz-outline":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[49],n[52],n[54]]},"-moz-outline-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[49]]},"-moz-outline-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"-moz-outline-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},"-o-text-overflow":{cssPropBits:0,cssLitGroup:[n[25]]},"-webkit-border-bottom-left-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-bottom-right-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[36]]},"-webkit-border-radius-bottom-left":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-bottom-right":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-top-left":{cssExtra:e[0],cssPropBits:5},"-webkit-border-radius-top-right":{cssExtra:e[0],cssPropBits:5},"-webkit-border-top-left-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-border-top-right-radius":{cssExtra:e[0],cssPropBits:5},"-webkit-box-shadow":{cssExtra:e[2],cssAlternates:["boxShadow"],cssPropBits:7,cssLitGroup:[n[0],n[35],n[48],n[54]]},azimuth:{cssPropBits:5,cssLitGroup:[n[6],n[30],n[42],n[47]]},background:{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){0,2} *$","i"),cssPropBits:23,cssLitGroup:[n[0],n[14],n[17],n[24],n[30],n[35],n[36],n[38],n[42],n[45],n[47],n[51],n[54],n[57],n[58],n[62]]},"background-size":{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){0,2} *$","i"),cssPropBits:23,cssLitGroup:[n[0],n[14],n[17],n[24],n[30],n[35],n[36],n[38],n[42],n[45],n[47],n[51],n[54],n[57],n[58],n[62]]},"background-attachment":{cssExtra:e[0],cssPropBits:0,cssLitGroup:[n[35],n[45],n[51],n[58]]},"background-color":{cssExtra:e[1],cssPropBits:130,cssLitGroup:[n[0],n[47],n[62]]},"background-image":{cssExtra:RegExp(".*","i"),cssPropBits:16,cssLitGroup:[n[35],n[54]]},"background-position":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[24],n[30],n[35],n[42]]},"background-repeat":{cssExtra:e[0],cssPropBits:0,cssLitGroup:[n[17],n[35],n[57]]},border:{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[52],n[54],n[62]]},"border-bottom":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[52],n[54],n[62]]},"border-bottom-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[62]]},"border-bottom-left-radius":{cssExtra:e[0],cssPropBits:5},"border-bottom-right-radius":{cssExtra:e[0],cssPropBits:5},"border-bottom-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"border-bottom-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},"border-collapse":{cssPropBits:0,cssLitGroup:[n[44],n[47],n[59]]},"border-color":{cssExtra:RegExp("^ *(?:\\s*"+t[0]+"){1,4} *$","i"),cssPropBits:2,cssLitGroup:[n[0],n[47],n[62]]},"border-left":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[52],n[54],n[62]]},"border-left-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[62]]},"border-left-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"border-left-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},"border-radius":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[36]]},"border-right":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[52],n[54],n[62]]},"border-right-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[62]]},"border-right-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"border-right-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},"border-spacing":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[47]]},"border-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"border-top":{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[52],n[54],n[62]]},"border-top-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[62]]},"border-top-left-radius":{cssExtra:e[0],cssPropBits:5},"border-top-right-radius":{cssExtra:e[0],cssPropBits:5},"border-top-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"border-top-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},"border-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},bottom:{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"box-shadow":{cssExtra:e[2],cssPropBits:7,cssLitGroup:[n[0],n[35],n[48],n[54]]},"caption-side":{cssPropBits:0,cssLitGroup:[n[24],n[47]]},clear:{cssPropBits:0,cssLitGroup:[n[30],n[40],n[47],n[54]]},clip:{cssExtra:/^ *\s*rect\(\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto)\s*,\s*(?:0|[+\-]?\d+(?:\.\d+)?(?:[cem]m|ex|in|p[ctx])|auto) *\) *$/i,cssPropBits:0,cssLitGroup:[n[38],n[47]]},color:{cssExtra:e[1],cssPropBits:130,cssLitGroup:[n[0],n[47]]},content:{cssPropBits:8,cssLitGroup:[n[54],n[55]]},"counter-increment":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[47],n[54]]},"counter-reset":{cssExtra:e[0],cssPropBits:5,cssLitGroup:[n[47],n[54]]},cue:{cssPropBits:16,cssLitGroup:[n[47],n[54]]},"cue-after":{cssPropBits:16,cssLitGroup:[n[47],n[54]]},"cue-before":{cssPropBits:16,cssLitGroup:[n[47],n[54]]},cursor:{cssExtra:e[0],cssPropBits:144,cssLitGroup:[n[1],n[35],n[38],n[47]]},direction:{cssPropBits:0,cssLitGroup:[n[31],n[47]]},display:{cssPropBits:32,cssLitGroup:[n[2],n[47],n[54]]},elevation:{cssPropBits:5,cssLitGroup:[n[13],n[47]]},"empty-cells":{cssPropBits:0,cssLitGroup:[n[27],n[47]]},filter:{cssExtra:/^ *(?:\s*alpha\(\s*opacity\s*=\s*(?:0|\d+(?:\.\d+)?%|[+\-]?\d+(?:\.\d+)?) *\))+ *$/i,cssPropBits:32},"float":{cssAlternates:["cssFloat","styleFloat"],cssPropBits:32,cssLitGroup:[n[30],n[47],n[54]]},font:{cssExtra:e[0],cssPropBits:9,cssLitGroup:[n[4],n[7],n[11],n[15],n[29],n[35],n[36],n[47],n[52],n[55],n[60]]},"font-family":{cssExtra:e[0],cssPropBits:8,cssLitGroup:[n[15],n[35],n[47]]},"font-size":{cssPropBits:1,cssLitGroup:[n[7],n[47],n[52]]},"font-stretch":{cssPropBits:0,cssLitGroup:[n[5],n[55]]},"font-style":{cssPropBits:0,cssLitGroup:[n[29],n[47],n[55]]},"font-variant":{cssPropBits:0,cssLitGroup:[n[47],n[55],n[60]]},"font-weight":{cssPropBits:0,cssLitGroup:[n[4],n[47],n[55]]},height:{cssPropBits:37,cssLitGroup:[n[38],n[47]]},left:{cssPropBits:37,cssLitGroup:[n[38],n[47]]},"letter-spacing":{cssPropBits:5,cssLitGroup:[n[47],n[55]]},"line-height":{cssPropBits:1,cssLitGroup:[n[47],n[55]]},"list-style":{cssPropBits:16,cssLitGroup:[n[3],n[28],n[47],n[54]]},"list-style-image":{cssPropBits:16,cssLitGroup:[n[47],n[54]]},"list-style-position":{cssPropBits:0,cssLitGroup:[n[28],n[47]]},"list-style-type":{cssPropBits:0,cssLitGroup:[n[3],n[47],n[54]]},margin:{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"margin-bottom":{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"margin-left":{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"margin-right":{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"margin-top":{cssPropBits:5,cssLitGroup:[n[38],n[47]]},"max-height":{cssPropBits:1,cssLitGroup:[n[38],n[47],n[54]]},"max-width":{cssPropBits:1,cssLitGroup:[n[38],n[47],n[54]]},"min-height":{cssPropBits:1,cssLitGroup:[n[38],n[47]]},"min-width":{cssPropBits:1,cssLitGroup:[n[38],n[47]]},opacity:{cssPropBits:33,cssLitGroup:[n[47]]},outline:{cssExtra:e[1],cssPropBits:7,cssLitGroup:[n[0],n[9],n[34],n[46],n[47],n[48],n[49],n[52],n[54]]},"outline-color":{cssExtra:e[1],cssPropBits:2,cssLitGroup:[n[0],n[47],n[49]]},"outline-style":{cssPropBits:0,cssLitGroup:[n[9],n[46],n[47],n[48],n[54]]},"outline-width":{cssPropBits:5,cssLitGroup:[n[34],n[47],n[52]]},overflow:{cssPropBits:32,cssLitGroup:[n[38],n[46],n[47],n[58],n[63]]},"overflow-x":{cssPropBits:0,cssLitGroup:[n[32],n[38],n[46],n[58],n[63]]},"overflow-y":{cssPropBits:0,cssLitGroup:[n[32],n[38],n[46],n[58],n[63]]},padding:{cssPropBits:1,cssLitGroup:[n[47]]},"padding-bottom":{cssPropBits:33,cssLitGroup:[n[47]]},"padding-left":{cssPropBits:33,cssLitGroup:[n[47]]},"padding-right":{cssPropBits:33,cssLitGroup:[n[47]]},"padding-top":{cssPropBits:33,cssLitGroup:[n[47]]},"page-break-after":{cssPropBits:0,cssLitGroup:[n[30],n[37],n[38],n[39],n[47]]},"page-break-before":{cssPropBits:0,cssLitGroup:[n[30],n[37],n[38],n[39],n[47]]},"page-break-inside":{cssPropBits:0,cssLitGroup:[n[38],n[39],n[47]]},pause:{cssPropBits:5,cssLitGroup:[n[47]]},"pause-after":{cssPropBits:5,cssLitGroup:[n[47]]},"pause-before":{cssPropBits:5,cssLitGroup:[n[47]]},pitch:{cssPropBits:5,cssLitGroup:[n[19],n[47],n[52]]},"pitch-range":{cssPropBits:5,cssLitGroup:[n[47]]},"play-during":{cssExtra:e[0],cssPropBits:16,cssLitGroup:[n[38],n[47],n[53],n[54],n[57]]},position:{cssPropBits:32,cssLitGroup:[n[20],n[47]]},quotes:{cssExtra:e[0],cssPropBits:8,cssLitGroup:[n[47],n[54]]},richness:{cssPropBits:5,cssLitGroup:[n[47]]},right:{cssPropBits:37,cssLitGroup:[n[38],n[47]]},speak:{cssPropBits:0,cssLitGroup:[n[47],n[54],n[55],n[61]]},"speak-header":{cssPropBits:0,cssLitGroup:[n[37],n[47],n[56]]},"speak-numeral":{cssPropBits:0,cssLitGroup:[n[26],n[47]]},"speak-punctuation":{cssPropBits:0,cssLitGroup:[n[43],n[47],n[54]]},"speech-rate":{cssPropBits:5,cssLitGroup:[n[12],n[47],n[52]]},stress:{cssPropBits:5,cssLitGroup:[n[47]]},"table-layout":{cssPropBits:0,cssLitGroup:[n[38],n[45],n[47]]},"text-align":{cssPropBits:0,cssLitGroup:[n[30],n[42],n[47],n[50]]},"text-decoration":{cssPropBits:0,cssLitGroup:[n[18],n[47],n[54]]},"text-indent":{cssPropBits:5,cssLitGroup:[n[47]]},"text-overflow":{cssPropBits:0,cssLitGroup:[n[25]]},"text-shadow":{cssExtra:e[2],cssPropBits:7,cssLitGroup:[n[0],n[35],n[48],n[54]]},"text-transform":{cssPropBits:0,cssLitGroup:[n[21],n[47],n[54]]},"text-wrap":{cssPropBits:0,cssLitGroup:[n[33],n[54],n[55]]},top:{cssPropBits:37,cssLitGroup:[n[38],n[47]]},"unicode-bidi":{cssPropBits:0,cssLitGroup:[n[23],n[47],n[55]]},"vertical-align":{cssPropBits:5,cssLitGroup:[n[10],n[24],n[47]]},visibility:{cssPropBits:32,cssLitGroup:[n[44],n[46],n[47],n[63]]},"voice-family":{cssExtra:e[0],cssPropBits:8,cssLitGroup:[n[22],n[35],n[47]]},volume:{cssPropBits:1,cssLitGroup:[n[16],n[47],n[52]]},"white-space":{cssPropBits:0,cssLitGroup:[n[8],n[47],n[55]]},width:{cssPropBits:33,cssLitGroup:[n[38],n[47]]},"word-spacing":{cssPropBits:5,cssLitGroup:[n[47],n[55]]},"word-wrap":{cssPropBits:0,cssLitGroup:[n[41],n[55]]},"z-index":{cssPropBits:69,cssLitGroup:[n[38],n[47]]},zoom:{cssPropBits:1,cssLitGroup:[n[55]]}}}(),URI,decodeCss,html,html4,html_sanitize,lexCss,parseCssDeclarations,parseCssStylesheet,sanitizeCssProperty,sanitizeCssSelectors,sanitizeStylesheet,sanitizeStylesheetWithExternals;if("undefined"!=typeof window&&(window.cssSchema=cssSchema),function(){function t(t){var e=parseInt(t.substring(1),16);return e>65535?(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e))):e==e?String.fromCharCode(e):t[1]<" "?"":t[1]}function e(t,e){return'"'+t.replace(/[\u0000-\u001f\\\"\x3c\x3e]/g,e)+'"'}function n(t){return z[t]||(z[t]="\\"+t.charCodeAt(0).toString(16)+" ")}function r(t){return q[t]||(q[t]=("">t?"%0":"%")+t.charCodeAt(0).toString(16))}var i,o,s,a,l,u,c,p,h,d,f,g,m,v,y,b,w,x,_,S,E,T,A,C,P,R,L,M,k,B,I,O,H,F,N,D,j,$,G,U,z,q;z={"\\":"\\\\"},q={"\\":"%5c"},G="[\\t\\n\\f ]",$=G+"*",x="[\\n\\f]",O="[\\ud800-\\udbff][\\udc00-\\udfff]",E="[\\u0080-\\ud7ff\\ue000-\\ufffd]|"+O,N="[0-9a-fA-F]{1,6}"+G+"?",H="\\\\"+N,g="(?:"+N+"|[\\u0020-\\u007e\\u0080-\\ud7ff\\ue000\\ufffd]|"+O+")",f="\\\\"+g,j="(?:[\\t\\x21\\x23-\\x26\\x28-\\x5b\\x5d-\\x7e]|"+E+"|"+f+")",k="[^'\"\\n\\f\\\\]|\\\\[\\s\\S]",M="\"(?:'|"+k+')*"|\'(?:"|'+k+")*'",T="[-+]?(?:[0-9]+(?:[.][0-9]+)?|[.][0-9]+)",S="(?:[a-zA-Z_]|"+E+"|"+f+")",_="(?:[a-zA-Z0-9_-]|"+E+"|"+f+")",w=_+"+",y="-?"+S+_+"*",i="@"+y,v="#"+w,A=T,U="(?:@?-?"+S+"|#)"+_+"*",P=T+"%",d=T+y,C=T+"(?:%|"+y+")?",D="url[(]"+$+"(?:"+M+"|"+j+"*)"+$+"[)]",F="U[+][0-9A-F?]{1,6}(?:-[0-9A-F]{1,6})?",a="<!--",s="-->",L=G+"+",c="/(?:[*][^*]*[*]+(?:[^/][^*]*[*]+)*/|/[^\\n\\f]*)",m="(?!url[(])"+y+"[(]",b="~=",h="[|]=",R="[^]=",I="[$]=",B="[*]=",u="[~|^$*]=",l="[^\"'\\\\/]|/(?![/*])",o="\\uFEFF",p=new RegExp([o,F,D,m,U,M,C,a,s,L,c,u,l].join("|"),"gi"),decodeCss=function(e){return e.replace(new RegExp("\\\\(?:"+g+"|"+x+")","g"),t)},lexCss=function(t){var i,o,l,u,c,h,d,f;for(t=""+t,f=t.replace(/\r\n?/g,"\n").match(p)||[],l=0,u=" ",o=0,h=f.length;h>o;++o)d=decodeCss(f[o]),c=d.length,i=d.charCodeAt(0),d=i=='"'.charCodeAt(0)||i=="'".charCodeAt(0)?e(d.substring(1,c-1),n):i=="/".charCodeAt(0)&&c>1||"\\"==d||d==s||d==a||"\ufeff"==d||i<=" ".charCodeAt(0)?" ":/url\(/i.test(d)?"url("+e(d.replace(new RegExp("^url\\("+$+"[\"']?|[\"']?"+$+"\\)$","gi"),""),r)+")":d,(u!=d||" "!=d)&&(f[l++]=u=d);return f.length=l,f}}(),"undefined"!=typeof window&&(window.lexCss=lexCss,window.decodeCss=decodeCss),URI=function(){function t(t){var e=(""+t).match(g);return e?new l(u(e[1]),u(e[2]),u(e[3]),u(e[4]),u(e[5]),u(e[6]),u(e[7])):null}function e(t,e,o,s,a,u,c){var p=new l(r(t,f),r(e,f),n(o),s>0?s.toString():null,r(a,d),null,n(c));return u&&("string"==typeof u?p.setRawQuery(u.replace(/[^?\x26=0-9A-Za-z_\-~.%]/g,i)):p.setAllParameters(u)),p}function n(t){return"string"==typeof t?encodeURIComponent(t):null}function r(t,e){return"string"==typeof t?encodeURI(t).replace(e,i):null}function i(t){var e=t.charCodeAt(0);return"%"+"0123456789ABCDEF".charAt(e>>4&15)+"0123456789ABCDEF".charAt(15&e)}function o(t){return t.replace(/(^|\/)\.(?:\/|$)/g,"$1").replace(/\/{2,}/g,"/")}function s(t){var e,n,r;if(null===t)return null;for(e=o(t),r=h;(n=e.replace(r,"$1"))!=e;e=n);return e}function a(t,e){var n,r,i,o,a=t.clone(),l=e.hasScheme();return l?a.setRawScheme(e.getRawScheme()):l=e.hasCredentials(),l?a.setRawCredentials(e.getRawCredentials()):l=e.hasDomain(),l?a.setRawDomain(e.getRawDomain()):l=e.hasPort(),r=e.getRawPath(),i=s(r),l?(a.setPort(e.getPort()),i=i&&i.replace(c,"")):(l=!!r,l?47!==i.charCodeAt(0)&&(n=s(a.getRawPath()||"").replace(c,""),o=n.lastIndexOf("/")+1,i=s((o?n.substring(0,o):"")+s(r)).replace(c,"")):(i=i&&i.replace(c,""),i!==r&&a.setRawPath(i))),l?a.setRawPath(i):l=e.hasQuery(),l?a.setRawQuery(e.getRawQuery()):l=e.hasFragment(),l&&a.setRawFragment(e.getRawFragment()),a}function l(t,e,n,r,i,o,s){this.scheme_=t,this.credentials_=e,this.domain_=n,this.port_=r,this.path_=i,this.query_=o,this.fragment_=s,this.paramCache_=null
}function u(t){return"string"==typeof t&&t.length>0?t:null}var c,p,h,d,f,g;return p=new RegExp("(/|^)(?:[^./][^/]*|\\.{2,}(?:[^./][^/]*)|\\.{3,}[^/]*)/\\.\\.(?:/|$)"),h=new RegExp(p),c=/^(?:\.\.\/)*(?:\.\.$)?/,l.prototype.toString=function(){var t=[];return null!==this.scheme_&&t.push(this.scheme_,":"),null!==this.domain_&&(t.push("//"),null!==this.credentials_&&t.push(this.credentials_,"@"),t.push(this.domain_),null!==this.port_&&t.push(":",this.port_.toString())),null!==this.path_&&t.push(this.path_),null!==this.query_&&t.push("?",this.query_),null!==this.fragment_&&t.push("#",this.fragment_),t.join("")},l.prototype.clone=function(){return new l(this.scheme_,this.credentials_,this.domain_,this.port_,this.path_,this.query_,this.fragment_)},l.prototype.getScheme=function(){return this.scheme_&&decodeURIComponent(this.scheme_).toLowerCase()},l.prototype.getRawScheme=function(){return this.scheme_},l.prototype.setScheme=function(t){return this.scheme_=r(t,f),this},l.prototype.setRawScheme=function(t){return this.scheme_=t?t:null,this},l.prototype.hasScheme=function(){return null!==this.scheme_},l.prototype.getCredentials=function(){return this.credentials_&&decodeURIComponent(this.credentials_)},l.prototype.getRawCredentials=function(){return this.credentials_},l.prototype.setCredentials=function(t){return this.credentials_=r(t,f),this},l.prototype.setRawCredentials=function(t){return this.credentials_=t?t:null,this},l.prototype.hasCredentials=function(){return null!==this.credentials_},l.prototype.getDomain=function(){return this.domain_&&decodeURIComponent(this.domain_)},l.prototype.getRawDomain=function(){return this.domain_},l.prototype.setDomain=function(t){return this.setRawDomain(t&&encodeURIComponent(t))},l.prototype.setRawDomain=function(t){return this.domain_=t?t:null,this.setRawPath(this.path_)},l.prototype.hasDomain=function(){return null!==this.domain_},l.prototype.getPort=function(){return this.port_&&decodeURIComponent(this.port_)},l.prototype.setPort=function(t){if(t){if(t=Number(t),t!==(65535&t))throw new Error("Bad port number "+t);this.port_=""+t}else this.port_=null;return this},l.prototype.hasPort=function(){return null!==this.port_},l.prototype.getPath=function(){return this.path_&&decodeURIComponent(this.path_)},l.prototype.getRawPath=function(){return this.path_},l.prototype.setPath=function(t){return this.setRawPath(r(t,d))},l.prototype.setRawPath=function(t){return t?(t=String(t),this.path_=!this.domain_||/^\//.test(t)?t:"/"+t):this.path_=null,this},l.prototype.hasPath=function(){return null!==this.path_},l.prototype.getQuery=function(){return this.query_&&decodeURIComponent(this.query_).replace(/\+/g," ")},l.prototype.getRawQuery=function(){return this.query_},l.prototype.setQuery=function(t){return this.paramCache_=null,this.query_=n(t),this},l.prototype.setRawQuery=function(t){return this.paramCache_=null,this.query_=t?t:null,this},l.prototype.hasQuery=function(){return null!==this.query_},l.prototype.setAllParameters=function(t){var e,n,r,i,o,s,a;if("object"==typeof t&&!(t instanceof Array)&&(t instanceof Object||"[object Array]"!==Object.prototype.toString.call(t))){i=[],e=-1;for(r in t)a=t[r],"string"==typeof a&&(i[++e]=r,i[++e]=a);t=i}for(this.paramCache_=null,o=[],s="",n=0;n<t.length;)r=t[n++],a=t[n++],o.push(s,encodeURIComponent(r.toString())),s="&",a&&o.push("=",encodeURIComponent(a.toString()));return this.query_=o.join(""),this},l.prototype.checkParameterCache_=function(){var t,e,n,r,i,o;if(!this.paramCache_)if(o=this.query_){for(t=o.split(/[\x26\?]/),i=[],n=-1,e=0;e<t.length;++e)r=t[e].match(/^([^=]*)(?:=(.*))?$/),i[++n]=decodeURIComponent(r[1]).replace(/\+/g," "),i[++n]=decodeURIComponent(r[2]||"").replace(/\+/g," ");this.paramCache_=i}else this.paramCache_=[]},l.prototype.setParameterValues=function(t,e){var n,r,i,o,s;for("string"==typeof e&&(e=[e]),this.checkParameterCache_(),i=0,s=this.paramCache_,o=[],n=0,r=0;n<s.length;n+=2)t===s[n]?i<e.length&&o.push(t,e[i++]):o.push(s[n],s[n+1]);for(;i<e.length;)o.push(t,e[i++]);return this.setAllParameters(o),this},l.prototype.removeParameter=function(t){return this.setParameterValues(t,[])},l.prototype.getAllParameters=function(){return this.checkParameterCache_(),this.paramCache_.slice(0,this.paramCache_.length)},l.prototype.getParameterValues=function(t){var e,n;for(this.checkParameterCache_(),n=[],e=0;e<this.paramCache_.length;e+=2)t===this.paramCache_[e]&&n.push(this.paramCache_[e+1]);return n},l.prototype.getParameterMap=function(){var t,e,n,r;for(this.checkParameterCache_(),n={},t=0;t<this.paramCache_.length;t+=2)e=this.paramCache_[t++],r=this.paramCache_[t++],e in n?n[e].push(r):n[e]=[r];return n},l.prototype.getParameterValue=function(t){var e;for(this.checkParameterCache_(),e=0;e<this.paramCache_.length;e+=2)if(t===this.paramCache_[e])return this.paramCache_[e+1];return null},l.prototype.getFragment=function(){return this.fragment_&&decodeURIComponent(this.fragment_)},l.prototype.getRawFragment=function(){return this.fragment_},l.prototype.setFragment=function(t){return this.fragment_=t?encodeURIComponent(t):null,this},l.prototype.setRawFragment=function(t){return this.fragment_=t?t:null,this},l.prototype.hasFragment=function(){return null!==this.fragment_},g=new RegExp("^(?:([^:/?#]+):)?(?://(?:([^/?#]*)@)?([^/?#:@]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$"),f=/[#\/\?@]/g,d=/[\#\?]/g,l.parse=t,l.create=e,l.resolve=a,l.collapse_dots=s,l.utils={mimeTypeOf:function(e){var n=t(e);return/\.html$/.test(n.getPath())?"text/html":"application/javascript"},resolve:function(e,n){return e?a(t(e),t(n)).toString():""+n}},l}(),"undefined"!=typeof window&&(window.URI=URI),sanitizeCssProperty=void 0,sanitizeCssSelectors=void 0,sanitizeStylesheet=void 0,sanitizeStylesheetWithExternals=void 0,function(){function t(t){return"string"==typeof t?'url("'+t.replace(a,e)+'")':s}function e(t){return l[t]}function n(t,e){return t?URI.utils.resolve(t,e):e}function r(t,e,n){var r;return n?(r=(""+t).match(o),!r||r[1]&&!i.test(r[1])?null:n(t,e)):null}var i,o,s='url("about:blank")',a=/[\n\f\r\"\'()*\x3c\x3e]/g,l={"\n":"%0a","\f":"%0c","\r":"%0d",'"':"%22","'":"%27","(":"%28",")":"%29","*":"%2a","<":"%3c",">":"%3e"};o=new RegExp("^(?:([^:/?# ]+):)?"),i=/^(?:https?|mailto)$/i,sanitizeCssProperty=function(){function e(t){var e,n,r,i={};for(n=t.length;--n>=0;)for(e=t[n],r=e.length;--r>=0;)i[e[r]]=o;return i}function i(t,e){for(var n,r=1,i=e+1,o=t.length;o>i&&r;)n=t[i++],r+="("===n?1:")"===n?-1:0;return i}var o;return o={},function(a,l,u,c,p){for(var h,d,f,g,m,v,y,b,w,x=l.cssPropBits,_=x&(CSS_PROP_BIT_QSTRING_CONTENT|CSS_PROP_BIT_QSTRING_URL),S=0/0,E=0,T=0;E<u.length;++E)w=u[E].toLowerCase(),h=w.charCodeAt(0),w=h===" ".charCodeAt(0)?"":h==='"'.charCodeAt(0)?_===CSS_PROP_BIT_QSTRING_URL&&c?t(r(n(p,decodeCss(u[E].substring(1,w.length-1))),a,c)):_===CSS_PROP_BIT_QSTRING_CONTENT?w:"":h==="#".charCodeAt(0)&&/^#(?:[0-9a-f]{3}){1,2}$/.test(w)?x&CSS_PROP_BIT_HASH_VALUE?w:"":"0".charCodeAt(0)<=h&&h<="9".charCodeAt(0)?x&CSS_PROP_BIT_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\d{1,7}$/)?w:"":w:"":(d=w.charCodeAt(1),f=w.charCodeAt(2),m="0".charCodeAt(0)<=d&&d<="9".charCodeAt(0),v="0".charCodeAt(0)<=f&&f<="9".charCodeAt(0),h==="+".charCodeAt(0)&&(m||d===".".charCodeAt(0)&&v)?x&CSS_PROP_BIT_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\+\d{1,7}$/)?w:"":(m?"":"0")+w.substring(1):"":h==="-".charCodeAt(0)&&(m||d===".".charCodeAt(0)&&v)?x&CSS_PROP_BIT_NEGATIVE_QUANTITY?x&CSS_PROP_BIT_Z_INDEX?w.match(/^\-\d{1,7}$/)?w:"":(m?"-":"-0")+w.substring(1):x&CSS_PROP_BIT_QUANTITY?"0":"":h===".".charCodeAt(0)&&m?x&CSS_PROP_BIT_QUANTITY?"0"+w:"":"url("===w.substring(0,4)?c&&_&CSS_PROP_BIT_QSTRING_URL?t(r(n(p,u[E].substring(5,w.length-2)),a,c)):"":("("===w.charAt(w.length-1)&&(g=i(u,E),u.splice(E,g-E,w=u.slice(E,g).join(" "))),y=l.cssLitGroup,b=y?l.cssLitMap||(l.cssLitMap=e(y)):o,b[w]===o||l.cssExtra&&l.cssExtra.test(w)?w:/^\w+$/.test(w)&&_===CSS_PROP_BIT_QSTRING_CONTENT?S+1===T?(u[S]=u[S].substring(0,u[S].length-1)+" "+w+'"',w=""):(S=T,'"'+w+'"'):"")),w&&(u[T++]=w);1===T&&u[0]===s&&(T=0),u.length=T}}(),sanitizeCssSelectors=function(t,e,n){function r(r,i){function o(r,i){var o,s,a,l,u,h,d,f,g,m="";i>r&&(f=t[r],"*"===f?(++r,m=f):/^[a-zA-Z]/.test(f)&&(u=n(f.toLowerCase(),[]),u&&("tagName"in u&&(f=u.tagName),++r,m=f))),l="";for(;i>r;){if(f=t[r],"#"===f.charAt(0)){if(/^#_|__$|[^#0-9A-Za-z:_\-]/.test(f))return null;l+=f+"-"+e}else{if("."!==f)break;if(!(++r<i&&/^[0-9A-Za-z:_\-]+$/.test(f=t[r]))||/^_|__$/.test(f))return null;l+="."+f}++r}for(s="";i>r&&"["===t[r];){if(++r,o=t[r++],a=html4.ATTRIBS[m+"::"+o],a!==+a&&(a=html4.ATTRIBS["*::"+o]),a!==+a)return null;if(h="",g="",/^[~^$*|]?=$/.test(t[r])&&(h=t[r++],g=t[r++]),"]"!==t[r++])return null;switch(a){case html4.atype.NONE:case html4.atype.URI:case html4.atype.URI_FRAGMENT:case html4.atype.ID:case html4.atype.IDREF:case html4.atype.IDREFS:case html4.atype.GLOBAL_NAME:case html4.atype.LOCAL_NAME:case html4.atype.CLASSES:if(h&&a!==html4.atype.NONE)return null;s+="["+o+h+g+"]"}}if(d="",i>r&&":"===t[r])if(f=t[++r],p.test(f)){if(!/^[a*]?$/.test(m))return null;v=!0,d=":"+f,++r,m="a"}else c.test(f)&&(v=!1,d=":"+f,++r);return r===i?(m+l).replace(/[^ .*#\w-]/g,"\\$&")+s+d:null}var s,a,h,d,f,g,m,v=!1;for(" "===t[r]&&++r,i-1!==r&&" "===t[i]&&--i,f=[],d=r,s="",a=r;i>a;++a)if(m=t[a],h=">"===m,h||" "===m){if(s=o(d,a,!1),!s||h&&/^html/i.test(s))return;d=a+1,f.push(s,h?" > ":" ")}s=o(d,i,!0),s&&(f.push(s),g=f.join(""),g="."+e+" "+g,(v?l:u).push(g))}var i,o,s,a,l=[],u=[],c=/^(active|after|before|first-child|first-letter|focus|hover)$/,p=/^(link|visited)$/,h=0,d=0;for(i=0;i<t.length;++i)a=t[i],!(("("==a||"["==a?(++d,0):")"==a||"]"==a?(d&&--d,0):" "==t[i]&&(d||">"==t[i-1]||">"==t[i+1]))||!(t[h++]=t[i]));for(t.length=h,o=t.length,s=0,i=0;o>i;++i)","===t[i]&&(r(s,i),s=i+1);return r(s,o),[u,l]},function(){function t(t){var e,n,r,i=!1;for(e=0,n=t.length;n-1>e;++e)r=t[e],":"===t[e+1]&&(i=!(cssSchema[r].cssPropBits&CSS_PROP_BIT_ALLOWED_IN_LINK)),i&&(t[e]=""),";"===r&&(i=!1);return t.join("")}function e(t){var e,n=/^\s*["]([^"]*)["]\s*$/,r=/^\s*[']([^']*)[']\s*$/,i=/^\s*url\s*[(]["]([^"]*)["][)]\s*$/,o=/^\s*url\s*[(][']([^']*)['][)]\s*$/,s=/^\s*url\s*[(]([^)]*)[)]\s*$/;return(e=n.exec(t))?e[1]:(e=r.exec(t))?e[1]:(e=i.exec(t))?e[1]:(e=o.exec(t))?e[1]:(e=s.exec(t))?e[1]:null}function i(a,l,u,c,p,h,d){function f(){y=0!==v.length&&null!==v[v.length-1]&&"@"!==v[v.length-1][0]}var g=void 0,m=!1,v=[],y=!1;return parseCssStylesheet(l,{startStylesheet:function(){g=[]},endStylesheet:function(){},startAtrule:function(t,l){var f;y?t=null:"@media"===t?(l=l.filter(function(t){return s[t]==o}),l.length?g.push(t," ",l.join(",")):t=null):"@import"===t&&l.length>0&&("function"==typeof d?(m=!0,f=r(n(a,e(l[0])),function(t){var e=i(f,t.html,u,c,p,h,d);d(e.result,e.moreToCome)},p)):window.console&&window.console.log("@import "+l.join(" ")+" elided"),t=null),y=!t,v.push(t)},endAtrule:function(){v.pop();y||g.push(";"),f()},startBlock:function(){y||g.push("{")},endBlock:function(){y||(g.push("}"),y=!0)},startRuleset:function(t){var e,n,r,i=void 0,o=!1;y||(r=sanitizeCssSelectors(t,u,h),e=r[0],i=r[1],e.length||i.length?(n=e.join(", "),n||(n="head > html",o=!0),g.push(n,"{")):y=!0),v.push(y?null:{historySensitiveSelectors:i,endOfSelectors:g.length-1,removeHistoryInsensitiveSelectors:o})},endRuleset:function(){var e,n,r=v.pop(),i=g.length;y||(g.push("}"),r&&(e=r.historySensitiveSelectors,e.length&&(n=g.slice(r.endOfSelectors),g.push(e.join(", "),t(n))))),r&&r.removeHistoryInsensitiveSelectors&&g.splice(r.endOfSelectors-1,i+1),f()},declaration:function(t,e){var n;y||(n=cssSchema[t],n&&(sanitizeCssProperty(t,n,e,c,a),e.length&&g.push(t,":",e.join(" "),";")))}}),{result:g.join(""),moreToCome:m}}var o={},s={braille:o,embossed:o,handheld:o,print:o,projection:o,screen:o,speech:o,tty:o,tv:o};sanitizeStylesheet=function(t,e,n,r,o){return i(t,e,n,r,void 0,o,void 0).result},sanitizeStylesheetWithExternals=function(t,e,n,r,o,s,a){return i(t,e,n,r,o,s,a)}}()}(),"undefined"!=typeof window&&(window.sanitizeCssProperty=sanitizeCssProperty,window.sanitizeCssSelectors=sanitizeCssSelectors,window.sanitizeStylesheet=sanitizeStylesheet),"i"!=="I".toLowerCase())throw"I/i problem";if(function(){function t(t,n,i,o){var s;return i>n?(s=t[n],"@"===s.charAt(0)?e(t,n,i,o,!0):r(t,n,i,o)):n}function e(t,e,r,i,o){for(var s,a,l=e++;r>e&&"{"!==t[e]&&";"!==t[e];)++e;return r>e&&(o||";"===t[e])&&(a=l+1,s=e,r>a&&" "===t[a]&&++a,s>a&&" "===t[s-1]&&--s,i.startAtrule&&i.startAtrule(t[l].toLowerCase(),t.slice(a,s)),e="{"===t[e]?n(t,e,r,i):e+1,i.endAtrule&&i.endAtrule()),e}function n(t,i,o,s){var a;for(++i,s.startBlock&&s.startBlock();o>i;){if(a=t[i].charAt(0),"}"==a){++i;break}" "===a||";"===a?i+=1:i="@"===a?e(t,i,o,s,!1):"{"===a?n(t,i,o,s):r(t,i,o,s)}return s.endBlock&&s.endBlock(),i}function r(t,e,n,r){var s,a=e,l=i(t,e,n,!0);if(0>l)return l=~l,e===l?l+1:l;if(e=l,l>a&&" "===t[l-1]&&--l,s=t[e],++e,"{"!==s)return e;for(r.startRuleset&&r.startRuleset(t.slice(a,l));n>e;){if(s=t[e],"}"===s){++e;break}" "===s?e+=1:e=o(t,e,n,r)}return r.endRuleset&&r.endRuleset(),n>e?e+1:e}function i(t,e,n,r){for(var i,o=[],s=-1;n>e;++e)if(i=t[e].charAt(0),"["===i||"("===i)o[++s]=i;else if("]"===i&&"["===o[s]||")"===i&&"("===o[s])--s;else if("{"===i||"}"===i||";"===i||"@"===i||":"===i&&!r)break;return s>=0&&(e=~(e+1)),e}function o(t,e,n,r){var o,a,l,u,c,p,h=t[e++];if(!s.test(h))return e+1;if(n>e&&" "===t[e]&&++e,e==n||":"!==t[e]){for(;n>e&&";"!==(u=t[e])&&"}"!==u;)++e;return e}if(++e,n>e&&" "===t[e]&&++e,l=e,o=i(t,e,n,!1),0>o)o=~o;else{for(c=[],p=0,a=l;o>a;++a)u=t[a]," "!==u&&(c[p++]=u);if(n>o){do{if(u=t[o],";"===u||"}"===u)break;p=0}while(++o<n);";"===u&&++o}p&&r.declaration&&r.declaration(h.toLowerCase(),c)}return o}var s;parseCssStylesheet=function(e,n){var r,i,o=lexCss(e);for(n.startStylesheet&&n.startStylesheet(),r=0,i=o.length;i>r;)r=" "===o[r]?r+1:t(o,r,i,n);n.endStylesheet&&n.endStylesheet()},s=/^-?[a-z]/i,parseCssDeclarations=function(t,e){var n,r,i=lexCss(t);for(n=0,r=i.length;r>n;)n=" "!==i[n]?o(i,n,r,e):n+1}}(),"undefined"!=typeof window&&(window.parseCssStylesheet=parseCssStylesheet,window.parseCssDeclarations=parseCssDeclarations),html4={},html4.atype={NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,HTML:12,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10,MEDIA_QUERY:13},html4.atype=html4.atype,html4.ATTRIBS={"*::class":9,"*::dir":0,"*::draggable":0,"*::hidden":0,"*::id":4,"*::inert":0,"*::itemprop":0,"*::itemref":6,"*::itemscope":0,"*::lang":0,"*::onblur":2,"*::onchange":2,"*::onclick":2,"*::ondblclick":2,"*::onfocus":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::onreset":2,"*::onscroll":2,"*::onselect":2,"*::onsubmit":2,"*::onunload":2,"*::spellcheck":0,"*::style":3,"*::title":0,"*::accept":0,"span::name":7,"*::translate":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::shape":0,"a::tabindex":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::tabindex":0,"area::target":10,"audio::controls":0,"audio::loop":0,"audio::mediagroup":5,"audio::muted":0,"audio::preload":0,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::tabindex":0,"button::type":0,"button::value":0,"canvas::height":0,"canvas::width":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"command::checked":0,"command::command":5,"command::disabled":0,"command::icon":1,"command::label":0,"command::radiogroup":0,"command::type":0,"*::data-i18n":0,"*::data-i18n-list":0,"*::data-i18n-list-item":0,"*::data-i18n-list-item-num":0,"*::data-i18n-error":0,"*::data-i18n-dynamic":0,"*::data-i18n-vars":0,"*::data-i18n-placeholder":0,"*::data-i18n-title":0,"*::data-i18n-alt":0,"*::data-i18n-aria-label":0,"*::data-i18n-label":0,"data::value":0,"del::cite":1,"del::datetime":0,"details::open":0,"dir::compact":0,"div::align":0,"dl::compact":0,"fieldset::disabled":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::novalidate":0,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::inputmode":0,"input::ismap":0,"input::list":5,"input::max":0,"input::maxlength":0,"input::min":0,"input::multiple":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::placeholder":0,"input::readonly":0,"input::required":0,"input::size":0,"input::src":1,"input::step":0,"input::tabindex":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"menu::label":0,"menu::type":0,"meter::high":0,"meter::low":0,"meter::max":0,"meter::min":0,"meter::value":0,"ol::compact":0,"ol::reversed":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"output::for":6,"output::name":8,"p::align":0,"pre::width":0,"progress::max":0,"progress::min":0,"progress::value":0,"q::cite":1,"select::autocomplete":0,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::required":0,"select::size":0,"select::tabindex":0,"source::type":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::autocomplete":0,"textarea::cols":0,"textarea::disabled":0,"textarea::inputmode":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::placeholder":0,"textarea::readonly":0,"textarea::required":0,"textarea::rows":0,"textarea::tabindex":0,"textarea::wrap":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"track::default":0,"track::kind":0,"track::label":0,"track::srclang":0,"ul::compact":0,"ul::type":0,"video::controls":0,"video::height":0,"video::loop":0,"video::mediagroup":5,"video::muted":0,"video::poster":1,"video::preload":0,"video::width":0},html4.ATTRIBS=html4.ATTRIBS,html4.eflags={OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128,VIRTUALIZED:256},html4.eflags=html4.eflags,html4.ELEMENTS={a:0,abbr:0,acronym:0,address:0,applet:272,area:2,article:0,aside:0,audio:0,b:0,base:274,basefont:274,bdi:0,bdo:0,big:0,blockquote:0,body:305,br:2,button:0,canvas:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,command:2,data:0,datalist:0,dd:1,del:0,details:0,dfn:0,dialog:272,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,figcaption:0,figure:0,font:0,footer:0,form:0,frame:274,frameset:272,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:305,header:0,hgroup:0,hr:2,html:305,i:0,iframe:4,img:2,input:2,ins:0,isindex:274,kbd:0,keygen:274,label:0,legend:0,li:1,link:274,map:0,mark:0,menu:0,meta:274,meter:0,nav:0,nobr:0,noembed:276,noframes:276,noscript:276,object:272,ol:0,optgroup:0,option:1,output:0,p:1,param:274,pre:0,progress:0,q:0,s:0,samp:0,script:84,section:0,select:0,small:0,source:2,span:0,strike:0,strong:0,style:148,sub:0,summary:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,time:0,title:280,tr:1,track:2,tt:0,u:0,ul:0,"var":0,video:0,wbr:2},html4.ELEMENTS=html4.ELEMENTS,html4.ELEMENT_DOM_INTERFACES={a:"HTMLAnchorElement",abbr:"HTMLElement",acronym:"HTMLElement",address:"HTMLElement",applet:"HTMLAppletElement",area:"HTMLAreaElement",article:"HTMLElement",aside:"HTMLElement",audio:"HTMLAudioElement",b:"HTMLElement",base:"HTMLBaseElement",basefont:"HTMLBaseFontElement",bdi:"HTMLElement",bdo:"HTMLElement",big:"HTMLElement",blockquote:"HTMLQuoteElement",body:"HTMLBodyElement",br:"HTMLBRElement",button:"HTMLButtonElement",canvas:"HTMLCanvasElement",caption:"HTMLTableCaptionElement",center:"HTMLElement",cite:"HTMLElement",code:"HTMLElement",col:"HTMLTableColElement",colgroup:"HTMLTableColElement",command:"HTMLCommandElement",data:"HTMLElement",datalist:"HTMLDataListElement",dd:"HTMLElement",del:"HTMLModElement",details:"HTMLDetailsElement",dfn:"HTMLElement",dialog:"HTMLDialogElement",dir:"HTMLDirectoryElement",div:"HTMLDivElement",dl:"HTMLDListElement",dt:"HTMLElement",em:"HTMLElement",fieldset:"HTMLFieldSetElement",figcaption:"HTMLElement",figure:"HTMLElement",font:"HTMLFontElement",footer:"HTMLElement",form:"HTMLFormElement",frame:"HTMLFrameElement",frameset:"HTMLFrameSetElement",h1:"HTMLHeadingElement",h2:"HTMLHeadingElement",h3:"HTMLHeadingElement",h4:"HTMLHeadingElement",h5:"HTMLHeadingElement",h6:"HTMLHeadingElement",head:"HTMLHeadElement",header:"HTMLElement",hgroup:"HTMLElement",hr:"HTMLHRElement",html:"HTMLHtmlElement",i:"HTMLElement",iframe:"HTMLIFrameElement",img:"HTMLImageElement",input:"HTMLInputElement",ins:"HTMLModElement",isindex:"HTMLUnknownElement",kbd:"HTMLElement",keygen:"HTMLKeygenElement",label:"HTMLLabelElement",legend:"HTMLLegendElement",li:"HTMLLIElement",link:"HTMLLinkElement",map:"HTMLMapElement",mark:"HTMLElement",menu:"HTMLMenuElement",meta:"HTMLMetaElement",meter:"HTMLMeterElement",nav:"HTMLElement",nobr:"HTMLElement",noembed:"HTMLElement",noframes:"HTMLElement",noscript:"HTMLElement",object:"HTMLObjectElement",ol:"HTMLOListElement",optgroup:"HTMLOptGroupElement",option:"HTMLOptionElement",output:"HTMLOutputElement",p:"HTMLParagraphElement",param:"HTMLParamElement",pre:"HTMLPreElement",progress:"HTMLProgressElement",q:"HTMLQuoteElement",s:"HTMLElement",samp:"HTMLElement",script:"HTMLScriptElement",section:"HTMLElement",select:"HTMLSelectElement",small:"HTMLElement",source:"HTMLSourceElement",span:"HTMLSpanElement",strike:"HTMLElement",strong:"HTMLElement",style:"HTMLStyleElement",sub:"HTMLElement",summary:"HTMLElement",sup:"HTMLElement",table:"HTMLTableElement",tbody:"HTMLTableSectionElement",td:"HTMLTableDataCellElement",textarea:"HTMLTextAreaElement",tfoot:"HTMLTableSectionElement",th:"HTMLTableHeaderCellElement",thead:"HTMLTableSectionElement",time:"HTMLTimeElement",title:"HTMLTitleElement",tr:"HTMLTableRowElement",track:"HTMLTrackElement",tt:"HTMLElement",u:"HTMLElement",ul:"HTMLUListElement","var":"HTMLElement",video:"HTMLVideoElement",wbr:"HTMLElement"},html4.ELEMENT_DOM_INTERFACES=html4.ELEMENT_DOM_INTERFACES,html4.ueffects={NOT_LOADED:0,SAME_DOCUMENT:1,NEW_DOCUMENT:2},html4.ueffects=html4.ueffects,html4.URIEFFECTS={"a::href":2,"area::href":2,"blockquote::cite":0,"command::icon":1,"del::cite":0,"form::action":2,"img::src":1,"input::src":1,"ins::cite":0,"q::cite":0,"video::poster":1},html4.URIEFFECTS=html4.URIEFFECTS,html4.ltypes={UNSANDBOXED:2,SANDBOXED:1,DATA:0},html4.ltypes=html4.ltypes,html4.LOADERTYPES={"a::href":2,"area::href":2,"blockquote::cite":2,"command::icon":1,"del::cite":2,"form::action":2,"img::src":1,"input::src":1,"ins::cite":2,"q::cite":2,"video::poster":1},html4.LOADERTYPES=html4.LOADERTYPES,"undefined"!=typeof window&&(window.html4=html4),"i"!=="I".toLowerCase())throw"I/i problem";html=function(t){function e(t){var e,n;return L.hasOwnProperty(t)?L[t]:(e=t.match(H),e?String.fromCharCode(parseInt(e[1],10)):(e=t.match(j))?String.fromCharCode(parseInt(e[1],16)):N&&K.test(t)?(N.innerHTML="&"+t+";",n=N.textContent,L[t]=n,n):"&"+t+";")}function n(t,n){return e(n)}function r(t){return t.replace(z,"")}function i(t){return t.replace(M,n)}function o(t){return(""+t).replace(B,"&amp;").replace(U,"&lt;").replace(D,"&gt;").replace(X,"&#34;")}function s(t){return t.replace(G,"&amp;$1").replace(U,"&lt;").replace(D,"&gt;")}function a(t){var e={cdata:t.cdata||t.cdata,comment:t.comment||t.comment,endDoc:t.endDoc||t.endDoc,endTag:t.endTag||t.endTag,pcdata:t.pcdata||t.pcdata,rcdata:t.rcdata||t.rcdata,startDoc:t.startDoc||t.startDoc,startTag:t.startTag||t.startTag};return function(t,n){return l(t,e,n)}}function l(t,e,n){var r=p(t),i={noMoreGT:!1,noMoreEndComments:!1};c(e,r,0,i,n)}function u(t,e,n,r,i){return function(){c(t,e,n,r,i)}}function c(e,n,r,i,o){var s,a,l,c,p,g,m,v,y,b;try{for(e.startDoc&&0==r&&e.startDoc(o),v=r,c=n.length;c>v;)switch(a=n[v++],g=n[v],a){case"&":k.test(g)?(e.pcdata&&e.pcdata("&"+g,o,I,u(e,n,v,i,o)),++v):e.pcdata&&e.pcdata("&amp;",o,I,u(e,n,v,i,o));break;case"</":(p=/^([-\w:]+)[^\'\"]*/.exec(g))?p[0].length===g.length&&">"===n[v+1]?(v+=2,b=p[1].toLowerCase(),e.endTag&&e.endTag(b,o,I,u(e,n,v,i,o))):v=h(n,v,e,o,I,i):e.pcdata&&e.pcdata("&lt;/",o,I,u(e,n,v,i,o));break;case"<":(p=/^([-\w:]+)\s*\/?/.exec(g))?p[0].length===g.length&&">"===n[v+1]?(v+=2,b=p[1].toLowerCase(),e.startTag&&e.startTag(b,[],o,I,u(e,n,v,i,o)),l=t.ELEMENTS[b],l&R&&(y={name:b,next:v,eflags:l},v=f(n,y,e,o,I,i))):v=d(n,v,e,o,I,i):e.pcdata&&e.pcdata("&lt;",o,I,u(e,n,v,i,o));break;case"<!--":if(!i.noMoreEndComments){for(m=v+1;c>m&&(">"!==n[m]||!/--$/.test(n[m-1]));++m);c>m?(e.comment&&(s=n.slice(v,m).join(""),e.comment(s.substr(0,s.length-2),o,I,u(e,n,m+1,i,o))),v=m+1):i.noMoreEndComments=!0}i.noMoreEndComments&&e.pcdata&&e.pcdata("&lt;!--",o,I,u(e,n,v,i,o));break;case"<!":if(/^\w/.test(g)){if(!i.noMoreGT){for(m=v+1;c>m&&">"!==n[m];++m);c>m?v=m+1:i.noMoreGT=!0}i.noMoreGT&&e.pcdata&&e.pcdata("&lt;!",o,I,u(e,n,v,i,o))}else e.pcdata&&e.pcdata("&lt;!",o,I,u(e,n,v,i,o));break;case"<?":if(!i.noMoreGT){for(m=v+1;c>m&&">"!==n[m];++m);c>m?v=m+1:i.noMoreGT=!0}i.noMoreGT&&e.pcdata&&e.pcdata("&lt;?",o,I,u(e,n,v,i,o));break;case">":e.pcdata&&e.pcdata("&gt;",o,I,u(e,n,v,i,o));break;case"":break;default:e.pcdata&&e.pcdata(a,o,I,u(e,n,v,i,o))}e.endDoc&&e.endDoc(o)}catch(w){if(w!==I)throw w}}function p(t){var e,n,r,i=/(\x3c\/|\x3c\!--|\x3c[!?]|[\x26\x3c\x3e])/g;if(t+="",Y)return t.split(i);for(r=[],e=0;null!==(n=i.exec(t));)r.push(t.substring(e,n.index)),r.push(n[0]),e=n.index+n[0].length;return r.push(t.substring(e)),r}function h(t,e,n,r,i,o){var s=g(t,e);return s?(n.endTag&&n.endTag(s.name,r,i,u(n,t,e,o,r)),s.next):t.length}function d(t,e,n,r,i,o){var s=g(t,e);return s?(n.startTag&&n.startTag(s.name,s.attrs,r,i,u(n,t,s.next,o,r)),s.eflags&R?f(t,s,n,r,i,o):s.next):t.length}function f(e,n,r,i,o,a){var l,c,p,h,d=e.length;for(F.hasOwnProperty(n.name)||(F[n.name]=new RegExp("^"+n.name+"(?:[\\s\\/]|$)","i")),h=F[n.name],c=n.next,p=n.next+1;d>p&&("</"!==e[p-1]||!h.test(e[p]));++p);if(d>p&&(p-=1),l=e.slice(c,p).join(""),n.eflags&t.eflags.CDATA)r.cdata&&r.cdata(l,i,o,u(r,e,p,a,i));else{if(!(n.eflags&t.eflags.RCDATA))throw new Error("bug");r.rcdata&&r.rcdata(s(l),i,o,u(r,e,p,a,i))}return p}function g(e,n){var r,i,o,s,a,l,u,c,p,h=/^([-\w:]+)/.exec(e[n]),d={};for(d.name=h[1].toLowerCase(),d.eflags=t.ELEMENTS[d.name],a=e[n].substr(h[0].length),u=n+1,l=e.length;l>u&&">"!==e[u];++u)a+=e[u];if(!(u>=l)){for(s=[];""!==a;)if(h=P.exec(a)){if(h[4]&&!h[5]||h[6]&&!h[7]){for(c=h[4]||h[6],p=!1,o=[a,e[u++]];l>u;++u){if(p){if(">"===e[u])break}else 0<=e[u].indexOf(c)&&(p=!0);o.push(e[u])}if(u>=l)break;a=o.join("");continue}r=h[1].toLowerCase(),i=h[2]?m(h[3]):"",s.push(r,i),a=a.substr(h[0].length)}else a=a.replace(/^[\s\S][^a-z\s]*/,"");return d.attrs=s,d.next=u+1,d}}function m(t){var e=t.charCodeAt(0);return(34===e||39===e)&&(t=t.substr(1,t.length-2)),i(r(t))}function v(e){var n,r,i=function(t,e){n||e.push(t)};return a({startDoc:function(){r=[],n=!1},startTag:function(i,s,a){var l,u,c,p,h,d,f,g,m;if(!n&&t.ELEMENTS.hasOwnProperty(i)&&(c=t.ELEMENTS[i],!(c&t.eflags.FOLDABLE))){if(u=e(i,s),!u)return void(n=!(c&t.eflags.EMPTY));if("object"!=typeof u)throw new Error("tagPolicy did not return object (old API?)");if(!("attribs"in u))throw new Error("tagPolicy gave no attribs");s=u.attribs,"tagName"in u?(g=u.tagName,p=t.ELEMENTS[g]):(g=i,p=c),c&t.eflags.OPTIONAL_ENDTAG&&(f=r[r.length-1],f&&f.orig===i&&(f.rep!==g||i!==g)&&a.push("</",f.rep,">")),c&t.eflags.EMPTY||r.push({orig:i,rep:g}),a.push("<",g);for(h=0,d=s.length;d>h;h+=2)l=s[h],m=s[h+1],null!==m&&void 0!==m&&a.push(" ",l,'="',o(m),'"');a.push(">"),c&t.eflags.EMPTY&&!(p&t.eflags.EMPTY)&&a.push("</",g,">")}},endTag:function(e,i){var o,s,a,l,u;if(n)return void(n=!1);if(t.ELEMENTS.hasOwnProperty(e)&&(o=t.ELEMENTS[e],!(o&(t.eflags.EMPTY|t.eflags.FOLDABLE)))){if(o&t.eflags.OPTIONAL_ENDTAG){for(a=r.length;--a>=0&&(l=r[a].orig,l!==e);)if(!(t.ELEMENTS[l]&t.eflags.OPTIONAL_ENDTAG))return}else for(a=r.length;--a>=0&&r[a].orig!==e;);if(0>a)return;for(s=r.length;--s>a;)u=r[s].rep,t.ELEMENTS[u]&t.eflags.OPTIONAL_ENDTAG||i.push("</",u,">");a<r.length&&(e=r[a].rep),r.length=a,i.push("</",e,">")}},pcdata:i,rcdata:i,cdata:i,endDoc:function(t){for(;r.length;--r.length)t.push("</",r[r.length-1].rep,">")}})}function y(t,e,n,r,i){var o,s;if(!i)return null;try{if(o=URI.parse(""+t),o&&(!o.hasScheme()||C.test(o.getScheme())))return s=i(o,e,n,r),s?s.toString():null}catch(a){return null}return null}function b(t,e,n,r,i){var o;n||t(e+" removed",{change:"removed",tagName:e}),r!==i&&(o="changed",r&&!i?o="removed":!r&&i&&(o="added"),t(e+"."+n+" "+o,{change:o,tagName:e,attribName:n,oldValue:r,newValue:i}))}function w(t,e,n){var r=e+"::"+n;return t.hasOwnProperty(r)?t[r]:(r="*::"+n,t.hasOwnProperty(r)?t[r]:void 0)}function x(e,n){return w(t.LOADERTYPES,e,n)}function _(e,n){return w(t.URIEFFECTS,e,n)}function S(e,n,r,i,o){var s,a,l,u,c,p,h;for(u=0;u<n.length;u+=2){if(a=n[u],h=n[u+1],c=h,l=null,s=e+"::"+a,(t.ATTRIBS.hasOwnProperty(s)||(s="*::"+a,t.ATTRIBS.hasOwnProperty(s)))&&(l=t.ATTRIBS[s]),null!==l)switch(l){case t.atype.NONE:break;case t.atype.SCRIPT:h=null,o&&b(o,e,a,c,h);break;case t.atype.STYLE:if("undefined"==typeof q){h=null,o&&b(o,e,a,c,h);break}p=[],q(h,{declaration:function(e,n){var i=e.toLowerCase(),o=O[i];o&&(V(i,o,n,r?function(e){return y(e,t.ueffects.SAME_DOCUMENT,t.ltypes.SANDBOXED,{TYPE:"CSS",CSS_PROP:i},r)}:null),p.push(e+": "+n.join(" ")))}}),h=p.length>0?p.join(" ; "):null,o&&b(o,e,a,c,h);break;case t.atype.ID:case t.atype.IDREF:case t.atype.IDREFS:case t.atype.GLOBAL_NAME:case t.atype.LOCAL_NAME:case t.atype.CLASSES:h=i?i(h):h,o&&b(o,e,a,c,h);break;case t.atype.URI:h=y(h,_(e,a),x(e,a),{TYPE:"MARKUP",XML_ATTR:a,XML_TAG:e},r),o&&b(o,e,a,c,h);break;case t.atype.URI_FRAGMENT:h&&"#"===h.charAt(0)?(h=h.substring(1),h=i?i(h):h,null!==h&&void 0!==h&&(h="#"+h)):h=null,o&&b(o,e,a,c,h);break;default:h=null,o&&b(o,e,a,c,h)}else h=null,o&&b(o,e,a,c,h);n[u+1]=h}return n}function E(e,n,r){return function(i,o){return t.ELEMENTS[i]&t.eflags.UNSAFE?void(r&&b(r,i,void 0,void 0,void 0)):{attribs:S(i,o,e,n,r)}}}function T(t,e){var n=[];return v(e)(t,n),n.join("")}function A(t,e,n,r){var i=E(e,n,r);return T(t,i)}var C,P,R,L,M,k,B,I,O,H,F,N,D,j,$,G,U,z,q,X,K,V,Y;return"undefined"!=typeof window&&(q=window.parseCssDeclarations,V=window.sanitizeCssProperty,O=window.cssSchema),L={lt:"<",LT:"<",gt:">",GT:">",amp:"&",AMP:"&",quot:'"',apos:"'",nbsp:"\xa0"},H=/^#(\d+)$/,j=/^#x([0-9A-Fa-f]+)$/,K=/^[A-Za-z][A-za-z0-9]+$/,N="undefined"!=typeof window&&window.document?window.document.createElement("textarea"):null,z=/\0/g,M=/\x26(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/g,k=/^(#[0-9]+|#[xX][0-9A-Fa-f]+|\w+);/,B=/\x26/g,G=/\x26([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi,U=/[\x3c]/g,D=/\x3e/g,X=/\"/g,P=new RegExp("^\\s*([-.:\\w]+)(?:\\s*(=)\\s*((\")[^\"]*(\"|$)|(')[^']*('|$)|(?=[a-z][-\\w]*\\s*=)|[^\"'\\s]*))?","i"),Y=3==="a,b".split(/(,)/).length,R=t.eflags.CDATA|t.eflags.RCDATA,I={},F={},C=/^(?:https?|mailto)$/i,$={},$.escapeAttrib=$.escapeAttrib=o,$.makeHtmlSanitizer=$.makeHtmlSanitizer=v,$.makeSaxParser=$.makeSaxParser=a,$.makeTagPolicy=$.makeTagPolicy=E,$.normalizeRCData=$.normalizeRCData=s,$.sanitize=$.sanitize=A,$.sanitizeAttribs=$.sanitizeAttribs=S,$.sanitizeWithPolicy=$.sanitizeWithPolicy=T,$.unescapeEntities=$.unescapeEntities=i,$
}(html4),html_sanitize=html.sanitize,"undefined"!=typeof window&&(window.html=html,window.html_sanitize=html_sanitize);var UTF8={};UTF8.encode=function(t){for(var e=[],n=0;n<t.length;++n){var r=t.charCodeAt(n);128>r?e.push(r):2048>r?(e.push(192|r>>6),e.push(128|63&r)):65536>r?(e.push(224|r>>12),e.push(128|63&r>>6),e.push(128|63&r)):(e.push(240|r>>18),e.push(128|63&r>>12),e.push(128|63&r>>6),e.push(128|63&r))}return e},UTF8.decode=function(t){for(var e=[],n=0;n<t.length;){var r=t[n++];128>r||(224>r?(r=(31&r)<<6,r|=63&t[n++]):240>r?(r=(15&r)<<12,r|=(63&t[n++])<<6,r|=63&t[n++]):(r=(7&r)<<18,r|=(63&t[n++])<<12,r|=(63&t[n++])<<6,r|=63&t[n++])),e.push(String.fromCharCode(r))}return e.join("")};var BASE64={};if(function(t){var e=function(e){for(var n=0,r=[],i=0|e.length/3;0<i--;){var o=(e[n]<<16)+(e[n+1]<<8)+e[n+2];n+=3,r.push(t.charAt(63&o>>18)),r.push(t.charAt(63&o>>12)),r.push(t.charAt(63&o>>6)),r.push(t.charAt(63&o))}if(2==e.length-n){var o=(e[n]<<16)+(e[n+1]<<8);r.push(t.charAt(63&o>>18)),r.push(t.charAt(63&o>>12)),r.push(t.charAt(63&o>>6)),r.push("=")}else if(1==e.length-n){var o=e[n]<<16;r.push(t.charAt(63&o>>18)),r.push(t.charAt(63&o>>12)),r.push("==")}return r.join("")},n=function(){for(var e=[],n=0;n<t.length;++n)e[t.charCodeAt(n)]=n;return e["=".charCodeAt(0)]=0,e}(),r=function(t){for(var e=0,r=[],i=0|t.length/4;0<i--;){var o=(n[t.charCodeAt(e)]<<18)+(n[t.charCodeAt(e+1)]<<12)+(n[t.charCodeAt(e+2)]<<6)+n[t.charCodeAt(e+3)];e+=4,r.push(255&o>>16),r.push(255&o>>8),r.push(255&o)}return r&&("="==t.charAt(e-2)?(r.pop(),r.pop()):"="==t.charAt(e-1)&&r.pop()),r},i={};i.encode=function(t){for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e},i.decode=function(){for(var t=0;t<s.length;++t)a[t]=String.fromCharCode(a[t]);return a.join("")},BASE64.encodeASCII=function(t){var n=i.encode(t);return e(n)},BASE64.decodeASCII=function(t){var e=r(t);return i.decode(e)},BASE64.encode=function(t){var n=UTF8.encode(t);return e(n)},BASE64.decode=function(t){var e=r(t);return UTF8.decode(e)}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),void 0===btoa)var btoa=BASE64.encode;if(void 0===atob)var atob=BASE64.decode;(function(){var t,e,n,r=function(t,e){return function(){return t.apply(e,arguments)}};t=function(){function t(){this.translate=r(this.translate,this),this.data={values:{},contexts:[]},this.globalContext={}}return t.prototype.translate=function(t,e,n,r,i){var o,s,a,l;return null==i&&(i=this.globalContext),a=function(t){var e;return e=typeof t,"function"===e||"object"===e&&!!t},a(e)?(o=null,l=null,s=e,i=n||this.globalContext):"number"==typeof e?(o=null,l=e,s=n,i=r||this.globalContext):(o=e,"number"==typeof n?(l=n,s=r,i=i):(l=null,s=n,i=r||this.globalContext)),a(t)?(a(t.i18n)&&(t=t.i18n),this.translateHash(t,i)):this.translateText(t,l,s,i,o)},t.prototype.add=function(t){var e,n,r,i,o,s,a,l;if(null!=t.values){s=t.values;for(n in s)r=s[n],this.data.values[n]=r}if(null!=t.contexts){for(a=t.contexts,l=[],i=0,o=a.length;o>i;i++)e=a[i],l.push(this.data.contexts.push(e));return l}},t.prototype.setContext=function(t,e){return this.globalContext[t]=e},t.prototype.clearContext=function(t){return this.lobalContext[t]=null},t.prototype.reset=function(){return this.data={values:{},contexts:[]},this.globalContext={}},t.prototype.resetData=function(){return this.data={values:{},contexts:[]}},t.prototype.resetContext=function(){return this.globalContext={}},t.prototype.translateHash=function(t,e){var n,r;for(n in t)r=t[n],"string"==typeof r&&(t[n]=this.translateText(r,null,null,e));return t},t.prototype.translateText=function(t,e,n,r,i){var o,s;return null==r&&(r=this.globalContext),null==this.data?this.useOriginalText(i||t,e,n):(o=this.getContextData(this.data,r),null!=o&&(s=this.findTranslation(t,e,n,o.values,i)),null==s&&(s=this.findTranslation(t,e,n,this.data.values,i)),null==s?this.useOriginalText(i||t,e,n):s)},t.prototype.findTranslation=function(t,e,n,r){var i,o,s,a,l;if(s=r[t],null==s)return null;if(null==e){if("string"==typeof s)return this.applyFormatting(s,e,n)}else if(s instanceof Array||s.length)for(a=0,l=s.length;l>a;a++)if(o=s[a],(e>=o[0]||null===o[0])&&(e<=o[1]||null===o[1]))return i=this.applyFormatting(o[2].replace("-%n",String(-e)),e,n),this.applyFormatting(i.replace("%n",String(e)),e,n);return null},t.prototype.getContextData=function(t,e){var n,r,i,o,s,a,l,u;if(null==t.contexts)return null;for(l=t.contexts,s=0,a=l.length;a>s;s++){n=l[s],r=!0,u=n.matches;for(i in u)o=u[i],r=r&&o===e[i];if(r)return n}return null},t.prototype.useOriginalText=function(t,e,n){return null==e?this.applyFormatting(t,e,n):this.applyFormatting(t.replace("%n",String(e)),e,n)},t.prototype.applyFormatting=function(t,e,n){var r,i;for(r in n)i=new RegExp("%{"+r+"}","g"),t=t.replace(i,n[r]);return t},t}(),n=new t,e=n.translate,e.translator=n,e.create=function(n){var r;return r=new t,null!=n&&r.add(n),r.translate.create=e.create,r.translate},("undefined"!=typeof module&&null!==module?module.exports=e:void 0)||(this.i18n=e)}).call(this),d20.utils={stattracker:{}},window.d20ext=window.d20ext||{},window.d20ext.utils=d20.utils,function(){void 0!==window.customcharsheet_translation&&(i18n.translator.add(JSON.parse(BASE64.decode(window.customcharsheet_translation))),console.log("Custom Sheet Translation")),"undefined"!=typeof JS_TRANSLATIONS&&i18n.translator.add({values:JS_TRANSLATIONS});var t={};d20.utils.htmlTranslator=function(e,n){if(""===e)return"";"undefined"==typeof n&&(n=!1);var r="jQuery";"string"==typeof e?(r="string",e=$(e)):e instanceof jQuery||(r="html",e=$(e));var i="[data-i18n],[data-i18n-placeholder],[data-i18n-title],[data-i18n-alt],[data-i18n-aria-label],[data-i18n-label]";n&&(i+=",[data-i18n-dynamic]");var o=function(t){var e=[];return"error"===t&&e.push("Missing list key."),""===t&&e.push("Empty list entry."),e.length>0?e.join(" "):!1};switch(e.find(i).each(function(){var e=$(this),r=["-placeholder","-title","-alt","-aria-label","-label",""];n&&r.push("-dynamic"),$.each(r,function(){try{if("undefined"==typeof e.attr("data-i18n"+this))return;var r=""!==this?this.substr(1):!1,i=n&&"dynamic"===r,o=i?e.text():e.attr("data-i18n"+this),s=(e.attr("data-i18n-vars")||"").split("|"),a=r?"["+o+"]":'<span style="color: red;">['+o+"]</span>",l=i18n(o,a);if(t[o]=r?e.attr(r):e.html(),l=0===s.length?l:l.replace(/{{([0-9]+)}}/g,function(t,e){return s[e]?s[e]:"{{"+e+"}}"}),!r||i)return e.html(l),!1;e.attr(r,l)}catch(u){console.log("Translation Error:",u),console.log(e)}})}),e.find("[data-i18n-list]").each(function(){var t=$(this),e=t.attr("data-i18n-list"),n=i18n(e,"error"),r=o(n);if(r)return void t.attr("data-i18n-error",r);var i=$.map(n.split(","),function(t){return $.trim(t)}),s=(t.find("[data-i18n-list-item]").length,t.clone()),r=!1;t.find("[data-i18n-list-item-num]").length>0?$.each(i,function(e,n){return 0===t.find('[data-i18n-list-item="'+i[e]+'"]').length?(t.attr("data-i18n-error","List does not contain the key: "+i[e]+"."),void(r=!0)):void s.find('[data-i18n-list-item-num="'+(e+1)+'"]').replaceWith(t.find('[data-i18n-list-item="'+n+'"]').clone().removeAttr("data-i18n-list-item-num"))}):s.find("[data-i18n-list-item]").each(function(e){return 0===t.find('[data-i18n-list-item="'+i[e]+'"]').length?(t.attr("data-i18n-error","List does not contain the key: "+i[e]+"."),void(r=!0)):void $(this).replaceWith(t.find('[data-i18n-list-item="'+i[e]+'"]').clone().removeAttr("data-i18n-list-item"))}),r||t.replaceWith(s)}),window.i18nOutput=JSON.stringify(t),r){case"string":return e.prop("outerHTML");case"html":return e[0];default:return e}},d20.utils.handleURL=function(t){if(!($(this).hasClass("lightly")||$(this).parents(".redactor_box").length>0)){var e=$(this).attr("href");if(void 0!==e){if(-1!==e.indexOf("journal.roll20.net")||-1!==e.indexOf("wiki.roll20.net")){var n=e.split("/")[3],r=e.split("/")[4],i=d20.Campaign[n+"s"].get(r);if(i){var o=i.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(o,"all")||window.currentPlayer&&-1!==_.indexOf(o,window.currentPlayer.id))&&i.view.showDialog()}return $("#existing"+n+"s").find("tr[data-"+n+"id="+r+"]").trigger("click"),!1}var s=/(?:(?:http(?:s?):\/\/(?:app\.)?roll20\.(?:net|local:5000)\/|^\/?)compendium\/)([^\/]+)\/([^\/#?]+)/i,a=e.match(s);if(a)return d20.utils.openCompendiumPage(a[1],a[2]),t.stopPropagation(),void t.preventDefault();if(-1!==e.indexOf("javascript:"))return!1;if("!"===e.substring(0,1))return d20.textchat.doChatInput(e),!1;if("~"===e.substring(0,1))return d20.textchat.doChatInput("%{"+e.substring(1,e.length)+"}"),!1;if(void 0!==e&&("external"===$(this).attr("rel")||-1===e.indexOf("javascript:")&&-1!==e.indexOf("://"))){t.stopPropagation(),t.preventDefault();var l=$('<div class="dialog dialog-danger">'+e+"<br /><br />This link will open up a new window (or tab) to an external site. Just close the new window/tab to return to the editor.</div>");l.dialog({modal:!0,title:"Confirm External Link",buttons:{Continue:function(){$(this).dialog("destroy").remove(),window.open(e)},Cancel:function(){$(this).dialog("destroy").remove()}},beforeClose:function(){$(this).dialog("destroy").remove()}})}}}},d20.utils.openCompendiumPage=function(t,e,n){"undefined"==typeof n&&(n=null),console.log("Opening compendium window for "+n),console.log("compendiumPageName",e);var r=750,i=800,o=$(window).height()-100;o>i&&(o=i);var s=$(window).width()-50;s>r&&(s=r);var a=$("<div class='compendiumpopup'><iframe src=\""+d20.compendium.compendiumBase+"compendium/"+t+"/"+(n||e)+"\" style='width: 100%; height: calc(100% - 5px);' frameborder='0'></iframe></div>");a.dialog({modal:!1,title:"<button class='showpopout btn pictos' style='margin-right: 15px;'>|</button>"+e.split(":")[0],beforeClose:function(){a.dialog("destroy").remove()},width:s+40,height:o,zIndex:11e3});var l=function(){var t=a,r=900,i=750;r=t.width(),i=t.height(),t.dialog("close");var o=window.open("/editor/popout","Popout"+(n||e),"menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width="+r+",height="+i);window.allChildWindows.push(o),o.onload=function(){t.appendTo(o.document.getElementById("containerdiv")),t.show(),o.document.title=e},o.onbeforeunload=function(){window.allChildWindows=_.without(window.allChildWindows,othis.childWindow),o=null,t.html(""),t=null}};a.parent().on("click",".showpopout",function(){l()})},d20.utils.playerZoneHeight=function(){var t=$("#playerzone .player").height()+65;return $("#macrobar").is(":visible")&&(t+=$("#macrobar").height()),console.log(t),t},d20.utils.strip_tags=function(t,e,n){n||void 0===e||(t=html_sanitize(t,function(t,e,n,r){var i=t.toString();if(r&&"a"===r.XML_TAG)return i;var o="https://s3.amazonaws.com/files.d20.io",s="http://imgsrv.roll20.net",a="https://imgsrv.roll20.net";return i.substring(0,o.length)===o||i.substring(0,s.length)===s||i.substring(0,a.length)===a?i:/^https?:\/\//.test(i)?"http://imgsrv.roll20.net/?src="+escape(i.replace("http://","").replace("https://","")):""},function(t){var e=t.split(" ");return _.each(e,function(t,n){e[n]="userscript-"===t.substring(0,11)||"sheet-"===t.substring(0,6)?t:"userscript-"+t}),e.join(" ")})),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var r=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(i,"").replace(r,function(t,n){return e.indexOf("<"+n.toLowerCase()+">")>-1?t:""})},d20.utils.htmlAllowed="<code><span><div><label><a><br><br /><p><b><i><del><strike><u><img><video><audio><param><blockquote><mark><cite><small><ul><ol><li><hr><dl><dt><dd><sup><sub><big><pre><code><figure><figcaption><strong><em><table><tr><td><th><tbody><thead><tfoot><caption><h1><h2><h3><h4><h5><h6>",d20.utils.handleHTMLInput=function(t){return escape(d20.utils.strip_tags(d20.utils.autoLink(t),d20.utils.htmlAllowed))},d20.utils.handleHTMLOutput=function(t){return d20.utils.strip_tags(unescape(t),d20.utils.htmlAllowed)},d20.utils.showOverQuota=function(){var t=$("<div><p>We're sorry, but it looks like you've uploaded more than your allotted quota of storage space on Roll20. You can increase your quota by <a href='/account/supporter/?quotainapp' target='_blank'>becoming a Plus user</a> (or upgrading your Plus account if you already have one), or by <a href='http://help.roll20.net/sidebar-art-library/' target='_blank'>deleting items from your Art Library</a>.</div>");t.dialog({modal:!0,title:"Quota Exceeded",buttons:{"Upgrade Account":function(){window.open("/account/supporter/?quotainapp"),t.dialog("destroy")},"No Thanks":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.showBadConvert=function(){var t=$("<div><p>There was an error trying to convert the PDF. Be sure you didn't specify an invalid page number. It's also possible the PDF is corrupted or isn't supported by our conversion software.</div>");t.dialog({modal:!0,title:"PDF Conversion Error",buttons:{"Drat!":function(){t.dialog("destroy")}},beforeClose:function(){t.dialog("destroy")}})},d20.utils.setupAvatar=function(t,e){t.bind("uploadcomplete",function(t,n){return t.stopPropagation(),"overquota"==n?(d20.utils.showOverQuota(),!1):(e.updateModel(),void e.model.save({avatar:n.base.replace("/original.","/med.")+(-1===n.base.indexOf("?")?"?"+Math.floor((new Date).getTime()/1e3):"")}))}),t.dndUploader({url:"/image_library/newupload",method:"POST",allowMultiple:!1}),t.bind("removeimage",function(){e.updateModel(),e.model.save({avatar:""})}),t.on("click",".remove",function(){t.trigger("removeimage")}),t.droppable({drop:function(e,n){console.log("Dropped onto avatar!"),e.originalEvent.dropHandled=!0,t.trigger("uploadcomplete",[{base:n.draggable.attr("data-fullsizeurl")},!0]),e.preventDefault(),e.stopPropagation()},greedy:!0,accept:".resultimage, .library-item"})};d20.utils.defaultRedactorSettings={minHeight:50,maxHeight:300,plugins:["fontcolor"],buttons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","table","link","|","alignment","|","horizontalrule","|"],convertDivs:!0,linebreaks:!0,tidyHtml:!1,dragUpload:!1},d20.utils.addCSSRules=function(t){var e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),window.createPopup||e.appendChild(document.createTextNode(""));var n=document.styleSheets[document.styleSheets.length-1];for(selector in t)if(n.insertRule)try{n.insertRule(selector+t[selector],n.cssRules.length)}catch(r){}else try{n.addRule(selector,t[selector])}catch(r){console.log("Error addding rule!"),console.log(r)}},d20.utils.defaultDiceTokens={d4:["https://s3.amazonaws.com/files.d20.io/images/779542/DEYaBdP8w9B1CUSK26im0A/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779540/P7yKde5fyGZCB1ud70UOzA/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779539/AO4m-45bGw5yOcnZXUAn9g/thumb.png?1363050056","https://s3.amazonaws.com/files.d20.io/images/779541/oWA-hmBAHNAijceHr8k-3A/thumb.png?1363050056"],d6:["https://s3.amazonaws.com/files.d20.io/images/779533/-gS85HUaXIvmE5SjGpoH4w/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779535/vkc_PT4z-d_ON1MvfHaCiA/thumb.png?1363049999","https://s3.amazonaws.com/files.d20.io/images/779534/mHDadFirie4L12_ii-HYqQ/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779531/nXqp2BhdwVsQn7cDR3cMlg/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779532/nQD5_IXYLWN7YCjnd5zugA/thumb.png?1363049998","https://s3.amazonaws.com/files.d20.io/images/779536/ttiwwiWE2PVkhD2d7fV3GA/thumb.png?1363049999"],d8:["https://s3.amazonaws.com/files.d20.io/images/779514/GPCh5vqdSwvt_ANka3yhaw/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779517/nnuf1Pe2Fq70BIs9FGI7mQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779516/WnwuwT7yb5VM3-KiJY3GOg/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779515/Gx21buVd6d6onPsALrGFWQ/thumb.png?1363049802","https://s3.amazonaws.com/files.d20.io/images/779518/4LqfUGiX8sBXrX9b5gUnLw/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779519/YOR5Wav0-3-L1fm4vD-LFQ/thumb.png?1363049803","https://s3.amazonaws.com/files.d20.io/images/779522/dGFXXsEJz0EPA8dRpZvOzA/thumb.png?1363049804","https://s3.amazonaws.com/files.d20.io/images/779521/QXm6GcIhK6zTdMvJZVS8Og/thumb.png?1363049804"],d10:["https://s3.amazonaws.com/files.d20.io/images/779498/fjup5Fz4iV-TFKxV9z1Qtg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779500/ug7m7g1rII05ZFzyTrkRmw/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779499/QNZR5kGieM1x00yQvSYYbg/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779497/tkz2552-MqV8a_woAD8S4A/thumb.png?1363049717","https://s3.amazonaws.com/files.d20.io/images/779501/xKjqIxXzibpcx3Lp7UH6qg/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779502/Bpc1QATzO293LvGS3neBsQ/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779504/Bpw24T8na0nJNFdTKZX5aw/thumb.png?1363049718","https://s3.amazonaws.com/files.d20.io/images/779503/ukQbc7uDKfl62ng2EO6h6g/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779505/23948Y6_O0Bc0RuIve3BbA/thumb.png?1363049719","https://s3.amazonaws.com/files.d20.io/images/779506/VhwbFVDm2KOte5h2p97n7w/thumb.png?1363049719"],d12:["https://s3.amazonaws.com/files.d20.io/images/779476/FRkaR6XvyzUuZb0ZB7ysCA/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779474/UyTKDHxf-fU1zC3w6udl0w/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779475/kUK2UmBaD2No00Gp4Q_OCQ/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779477/OVnJDjAkMPLk29hjpFjUvw/thumb.png?1363049489","https://s3.amazonaws.com/files.d20.io/images/779478/2la9taZk_vqdKItYZ6JEfA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779479/fa8f9OVIBt79oETji8C8Lg/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779480/CTuw9Yiijq24ra3G9YMuPA/thumb.png?1363049490","https://s3.amazonaws.com/files.d20.io/images/779481/d4onnc7NOAbNG5JbiL9mbg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779482/Oy2dTkB3-NlxiMsTRj78nw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779483/mO_KU8nlO7GDQKc2J_aNeg/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779484/3MYG5dYJhiKXsRZtSUpHZw/thumb.png?1363049491","https://s3.amazonaws.com/files.d20.io/images/779485/VxA3umVDmYrH5A_VBecUIQ/thumb.png?1363049492"],d20:["https://s3.amazonaws.com/files.d20.io/images/779445/OfLXGnbkNr2qKg1Qqk4cPg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779447/br4TdShbuMIZ-D-lyeXsKA/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779454/2ARsJLoP4tExbCWrRaaxQg/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779444/3pryVOKRxMCBisEHpH3LWg/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779446/Yk4sSF3eWfnpeJd4DQpV2A/thumb.png?1363049314","https://s3.amazonaws.com/files.d20.io/images/779450/tdvjVviFHhM_KxjFRQomhA/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779456/twbHlPq0CFjFCpAyS59CTQ/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779449/PPHDirZfEowhjBHxQdxJiw/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779448/1SpNrrunpHwrNbsKcqpCzQ/thumb.png?1363049315","https://s3.amazonaws.com/files.d20.io/images/779458/VsueBYqaDlvp9BjlXl9wMQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779451/nWqhH9iMimUAJh_9jOFEog/thumb.png?1363049316","https://s3.amazonaws.com/files.d20.io/images/779452/TvksvU6AZm2wmpEQ2HkBlQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779459/L4pwmqIbQk0TfaCMExrYxQ/thumb.png?1363049320","https://s3.amazonaws.com/files.d20.io/images/779453/MDmeMWOQ_lARfvFoT1n3KQ/thumb.png?1363049317","https://s3.amazonaws.com/files.d20.io/images/779460/my8VEGyYcJIHZN2uXP6QXQ/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779455/nuz5AefdQSB6H4mvUXoqhw/thumb.png?1363049318","https://s3.amazonaws.com/files.d20.io/images/779457/kQBunq7iXGmHNqZQCa5MCA/thumb.png?1363049319","https://s3.amazonaws.com/files.d20.io/images/779463/6n_z7Gwd7eacm3-HC-f-mg/thumb.png?1363049322","https://s3.amazonaws.com/files.d20.io/images/779462/aVz3qCe2QM2nWhn3BoT9rg/thumb.png?1363049321","https://s3.amazonaws.com/files.d20.io/images/779461/4PuFJYddJWJjj4uL5S3mxQ/thumb.png?1363049321"]};for(var e in d20.utils.defaultDiceTokens)d20.utils.defaultDiceTokens[e]=_.map(d20.utils.defaultDiceTokens[e],function(t){return escape(t+"")});d20.utils.hexToRgb=function(t){return t[4]||(t=t.replace(/./g,"$&$&").slice(1)),["0x"+t[1]+t[2]|0,"0x"+t[3]+t[4]|0,"0x"+t[5]+t[6]|0]};var n={},r=function(){console.log("Do refresh link cache!");var t={};d20.Campaign.characters.each(function(e){var n=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(n,"all")||window.currentPlayer&&-1!==_.indexOf(n,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"character",id:e.id})}),d20.Campaign.handouts.each(function(e){var n=e.get("inplayerjournals").split(",");(window.is_gm||-1!==_.indexOf(n,"all")||window.currentPlayer&&-1!==_.indexOf(n,window.currentPlayer.id))&&(t[e.get("name").toLowerCase()]={type:"handout",id:e.id})}),n=t};d20.utils.refreshLinkCache=_.debounce(r,100),d20.utils.autoLink=function(t){var e=/\[[^\]]+\]/g;return t=t.replace(e,function(t){t=t.substring(1,t.length-1);var e=n[t.toLowerCase()];return e?"<a href='http://journal.roll20.net/"+e.type+"/"+e.id+"'>"+t+"</a>":"["+t+"]"})};var i=$("#textchat-notifier"),o=!1;d20.utils.textchatNotify=function(t,e){(o!==!0||e===!0)&&(t===!1?i.hide():i.show().text(t),e===!0&&(o=t!==!1?!0:!1))},d20.utils.getParentsUntil=function(t,e,n){var r=[];if(n)var i=n.charAt(0);for(;t&&t!==document&&(!e||e!==t);t=t.parentNode)n?("."===i&&t.classList.contains(n.substr(1))&&r.push(t),"#"===i&&t.id===n.substr(1)&&r.push(t),"["===i&&t.hasAttribute(n.substr(1,n.length-1))&&r.push(t),t.tagName.toLowerCase()===n&&r.push(t)):r.push(t);return r}}(),window.ucfirst=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},function(t,e,n){function r(e,n){this.element=e,this.options=t.extend({},o,n),this._defaults=o,this._name=i,this.init()}var i="addClear",o={closeSymbol:"&#10006;",color:"#CCC",top:-1,right:8,returnFocus:!0,showOnLoad:!1,onClear:null,hideOnBlur:!1,tabbable:!0};r.prototype={init:function(){var e,r=t(this.element),i=this,o=this.options;r.wrap("<span style='position:relative;' class='add-clear-span'></span>");var s=o.tabbable?"":" tabindex='-1'";e=t("<a href='#clear' style='display: none;'"+s+">"+o.closeSymbol+"</a>"),r.after(e),r.next().css({color:o.color,"text-decoration":"none",display:"none","line-height":1,overflow:"hidden",position:"absolute",right:o.right,top:o.top},this),r.val().length>=1&&o.showOnLoad===!0&&e.css({display:"block"}),r.focus(function(){t(this).val().length>=1&&e.css({display:"block"})}),r.blur(function(t){o.hideOnBlur&&setTimeout(function(){var r=t.relatedTarget||t.explicitOriginalTarget||n.activeElement;r!==e[0]&&e.css({display:"none"})},0)});var a=function(){e.css(t(this).val().length>=1?{display:"block"}:{display:"none"})},l=function(){r.off("keyup",a),r.off("cut",a),l=a,a.call(this)};r.on("keyup",a),r.on("cut",function(){var t=this;setTimeout(function(){a.call(t)},0)}),r.on("input",function(){l.call(this)}),o.hideOnBlur&&e.blur(function(){e.css({display:"none"})}),e.click(function(e){var n=t(i.element);n.val("").trigger("keyup"),t(this).css({display:"none"}),o.returnFocus===!0&&n.focus(),o.onClear&&o.onClear(n),e.preventDefault()})}},t.fn[i]=function(e){return this.each(function(){t.data(this,"plugin_"+i)||t.data(this,"plugin_"+i,new r(this,e))})}}(jQuery,window,document);var d20=d20||{};d20.DicePEG=function(){function quote(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var result={parse:function(input,startRule){function padLeft(t,e,n){for(var r=t,i=n-t.length,o=0;i>o;o++)r=e+r;return r}function escape(t){var e,n,r=t.charCodeAt(0);return 255>=r?(e="x",n=2):(e="u",n=4),"\\"+e+padLeft(r.toString(16).toUpperCase(),"0",n)}function matchFailed(t){rightmostFailuresPos>pos||(pos>rightmostFailuresPos&&(rightmostFailuresPos=pos,rightmostFailuresExpected=[]),rightmostFailuresExpected.push(t))}function parse_start(){var t,e,n,r,i;if(r=pos,i=pos,t=parse_rollExpression(),null!==t){for(e=[],input.length>pos?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("any character"));null!==n;)e.push(n),input.length>pos?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("any character"));null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,n){return Array.isArray(e)||(e=[e]),""!==n&&(n=n.join(""),n.trim().length>0&&e.push(new Comment(n))),e}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_rollExpression(){var t,e,n,r,i;return r=pos,i=pos,t=parse_rollExpressionPrimary(),null!==t?(e=parse_labelAwareRollOperator(),null!==e?(n=parse_rollExpression(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n,r){var i=e;return i=mergeExpressions(i,n),i=mergeExpressions(i,r)}(r,t[0],t[1],t[2])),null===t&&(pos=r),null===t&&(r=pos,i=pos,t=parse_rollExpressionPrimary(),null!==t?(e=parse_inlineLabelWithSpace(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return mergeExpressions(e,n)}(r,t[0],t[1])),null===t&&(pos=r),null===t&&(r=pos,i=pos,t=parse_inlineLabelWithSpace(),null!==t?(e=parse_rollExpression(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return mergeExpressions(e,n)}(r,t[0],t[1])),null===t&&(pos=r),null===t&&(r=pos,t=parse_rollExpressionPrimary(),null!==t&&(t=function(t,e){return Array.isArray(e)||(e=[e]),e}(r,t)),null===t&&(pos=r)))),t}function parse_rollExpressionPrimary(){var t,e,n,r,i,o,s,a;return o=pos,s=pos,t=parse_fullRoll(),null!==t?(a=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=a):e=null,null!==e?t=[t,e]:(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[0])),null===t&&(pos=o),null===t&&(o=pos,s=pos,t=parse_rollGroup(),null!==t?(a=pos,reportFailures++,e=parse_validRollSuffix(),reportFailures--,null!==e?(e="",pos=a):e=null,null!==e?t=[t,e]:(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[0])),null===t&&(pos=o),null===t&&(o=pos,t=parse_number(),null!==t&&(t=function(t,e){return new MathExpression(e)}(o,t)),null===t&&(pos=o),null===t&&(o=pos,s=pos,"floor("===input.substr(pos,6)?(t="floor(",pos+=6):(t=null,0===reportFailures&&matchFailed('"floor("')),null!==t?(e=parse__(),null!==e?(n=parse_rollExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("floor(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"ceil("===input.substr(pos,5)?(t="ceil(",pos+=5):(t=null,0===reportFailures&&matchFailed('"ceil("')),null!==t?(e=parse__(),null!==e?(n=parse_rollExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("ceil(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"round("===input.substr(pos,6)?(t="round(",pos+=6):(t=null,0===reportFailures&&matchFailed('"round("')),null!==t?(e=parse__(),null!==e?(n=parse_rollExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("round(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,"abs("===input.substr(pos,4)?(t="abs(",pos+=4):(t=null,0===reportFailures&&matchFailed('"abs("')),null!==t?(e=parse__(),null!==e?(n=parse_rollExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("abs(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o),null===t&&(o=pos,s=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t?(e=parse__(),null!==e?(n=parse_rollExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return mergeExpressions("(",mergeExpressions(e,")"))}(o,t[2])),null===t&&(pos=o)))))))),t}function parse_validRollSuffix(){var t,e;return t=parse___(),null===t&&(t=parse_inlineLabelWithSpace(),null===t&&(125===input.charCodeAt(pos)?(t="}",pos++):(t=null,0===reportFailures&&matchFailed('"}"')),null===t&&(44===input.charCodeAt(pos)?(t=",",pos++):(t=null,0===reportFailures&&matchFailed('","')),null===t&&(41===input.charCodeAt(pos)?(t=")",pos++):(t=null,0===reportFailures&&matchFailed('")"')),null===t&&(e=pos,reportFailures++,t=parse_operator(),reportFailures--,null!==t?(t="",pos=e):t=null,null===t&&(e=pos,reportFailures++,input.length>pos?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("any character")),reportFailures--,null===t?t="":(t=null,pos=e))))))),t}function parse_rollGroup(){var t,e,n,r,i,o,s,a;return s=pos,a=pos,123===input.charCodeAt(pos)?(t="{",pos++):(t=null,0===reportFailures&&matchFailed('"{"')),null!==t?(e=parse__(),null!==e?(n=parse_rollGroupExpression(),null!==n?(r=parse__(),null!==r?(125===input.charCodeAt(pos)?(i="}",pos++):(i=null,0===reportFailures&&matchFailed('"}"')),null!==i?(o=parse_groupMods(),o=null!==o?o:"",null!==o?t=[t,e,n,r,i,o]:(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a)):(t=null,pos=a),null!==t&&(t=function(t,e,n){return new GroupExpression(e,n)}(s,t[2],t[5])),null===t&&(pos=s),t}function parse_rollGroupExpression(){var t,e,n,r,i,o,s;return o=pos,s=pos,t=parse_rollExpression(),null===t&&(t=parse_rollGroup()),null!==t?(e=parse__(),null!==e?(44===input.charCodeAt(pos)?(n=",",pos++):(n=null,0===reportFailures&&matchFailed('","')),null!==n?(r=parse__(),null!==r?(i=parse_rollGroupExpression(),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,n){return Array.isArray(e)||(e=[e]),""!==n?[e].concat(n):e}(o,t[0],t[4])),null===t&&(pos=o),null===t&&(o=pos,t=parse_rollExpression(),null===t&&(t=parse_rollGroup()),null!==t&&(t=function(t,e){return[e]}(o,t)),null===t&&(pos=o)),t}function parse_labelAwareRollOperator(){var t,e,n,r,i;if(r=pos,i=pos,t=parse_rollOperator(),null!==t){for(e=[],n=parse_rollOperator(),null===n&&(n=parse_inlineLabelWithSpace());null!==n;)e.push(n),n=parse_rollOperator(),null===n&&(n=parse_inlineLabelWithSpace());null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,n){for(var r=e,i=0;i<n.length;i++)r=mergeExpressions(r,n[i]);return r}(r,t[0],t[1])),null===t&&(pos=r),null===t&&(r=pos,i=pos,t=parse_inlineLabelWithSpace(),null!==t?(e=parse_labelAwareRollOperator(),null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return mergeExpressions(e,n)}(r,t[0],t[1])),null===t&&(pos=r)),t}function parse_rollOperator(){var t,e,n,r,i,o,s,a,l;return a=pos,l=pos,t=parse__(),null!==t?(e=parse_operator(),null!==e?(n=parse__(),null!==n?(r=parse_mathExpressionPrimary(),null!==r?(i=parse__(),null!==i?(o=parse_rollOperator(),null!==o?(s=parse__(),null!==s?t=[t,e,n,r,i,o,s]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e,n,r){return e+n+r}(a,t[1],t[3],t[5])),null===t&&(pos=a),null===t&&(a=pos,l=pos,t=parse__(),null!==t?(e=parse_operator(),null!==e?(n=parse__(),null!==n?t=[t,e,n]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e){return e}(a,t[1])),null===t&&(pos=a)),t}function parse_fullRoll(){var t,e,n,r,i;return r=pos,i=pos,t=parse_coreRoll(),null!==t?(e=parse_rollMods(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return""!==n&&(e.mods=n),e
}(r,t[0],t[1])),null===t&&(pos=r),null===t&&(r=pos,i=pos,t=parse_numberOfDice(),null!==t?("t"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"t"')),null!==e?(n=parse_inlineLabel(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return new TableRollExpression(e,n.text)}(r,t[0],t[2])),null===t&&(pos=r)),t}function parse_coreRoll(){var t,e,n,r,i;return r=pos,i=pos,t=parse_numberOfDice(),null!==t?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e?("f"===input.substr(pos,1).toLowerCase()?(n=input.substr(pos,1),pos++):(n=null,0===reportFailures&&matchFailed('"f"')),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return new FateRollExpression(e)}(r,t[0])),null===t&&(pos=r),null===t&&(r=pos,i=pos,t=parse_numberOfDice(),null!==t?("d"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"d"')),null!==e?(n=parse_numberOfSides(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return new RollExpression(e,n)}(r,t[0],t[2])),null===t&&(pos=r)),t}function parse_numberOfDice(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,result0="",null!==result0&&(result0=function(){return 1}(pos0)),null===result0&&(pos=pos0))),result0}function parse_numberOfSides(){var result0,result1,result2,result3,result4,pos0,pos1;return result0=parse_integer(),null===result0&&(pos0=pos,pos1=pos,40===input.charCodeAt(pos)?(result0="(",pos++):(result0=null,0===reportFailures&&matchFailed('"("')),null!==result0?(result1=parse__(),null!==result1?(result2=parse_mathExpression(),null!==result2?(result3=parse__(),null!==result3?(41===input.charCodeAt(pos)?(result4=")",pos++):(result4=null,0===reportFailures&&matchFailed('")"')),null!==result4?result0=[result0,result1,result2,result3,result4]:(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1)):(result0=null,pos=pos1),null!==result0&&(result0=function(offset,expr){return Math.round(eval("("+expr+")"))}(pos0,result0[2])),null===result0&&(pos=pos0),null===result0&&(pos0=pos,"f"===input.substr(pos,1).toLowerCase()?(result0=input.substr(pos,1),pos++):(result0=null,0===reportFailures&&matchFailed('"f"')),null!==result0&&(result0=function(){return"F"}(pos0)),null===result0&&(pos=pos0))),result0}function parse_groupMods(){var t,e,n,r,i;if(r=pos,i=pos,t=parse_keepMod(),null===t&&(t=parse_dropMod(),null===t&&(t=parse_multipleMod(),null===t&&(t=parse_successMod()))),null!==t){for(e=[],n=parse_groupMods();null!==n;)e.push(n),n=parse_groupMods();null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,n){return processMods(e,n)}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_rollMods(){var t,e,n,r,i;if(r=pos,i=pos,t=parse_compoundingMod(),null===t&&(t=parse_penetratingMod(),null===t&&(t=parse_explodingMod(),null===t&&(t=parse_keepMod(),null===t&&(t=parse_dropMod(),null===t&&(t=parse_rerollOnceMod(),null===t&&(t=parse_rerollMod(),null===t&&(t=parse_customCritMod(),null===t&&(t=parse_customFumbleMod(),null===t&&(t=parse_sortMod(),null===t&&(t=parse_successMod())))))))))),null!==t){for(e=[],n=parse_rollMods();null!==n;)e.push(n),n=parse_rollMods();null!==e?t=[t,e]:(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e,n){return processMods(e,n)}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_explodingMod(){var t,e,n,r;return n=pos,r=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e){return{exploding:e}}(n,t[1])),null===t&&(pos=n),t}function parse_compoundingMod(){var t,e,n,r;return n=pos,r=pos,"!!"===input.substr(pos,2)?(t="!!",pos+=2):(t=null,0===reportFailures&&matchFailed('"!!"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e){return{compounding:e}}(n,t[1])),null===t&&(pos=n),t}function parse_penetratingMod(){var t,e,n,r,i;return r=pos,i=pos,33===input.charCodeAt(pos)?(t="!",pos++):(t=null,0===reportFailures&&matchFailed('"!"')),null!==t?("p"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"p"')),null!==e?(n=parse_comparisonPoint(),n=null!==n?n:"",null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return{penetrating:e}}(r,t[2])),null===t&&(pos=r),t}function parse_keepMod(){var t,e,n,r,i;return r=pos,i=pos,"k"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"k"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),e=null!==e?e:"",null!==e?(n=parse_integer(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return{keep:{end:e.toLowerCase()||"h",count:n}}}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_dropMod(){var t,e,n,r,i;return r=pos,i=pos,"d"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"d"')),null!==t?(/^['h'|'l']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['h'|'l']i")),e=null!==e?e:"",null!==e?(n=parse_integer(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){return{drop:{end:e.toLowerCase()||"l",count:n}}}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_customCritMod(){var t,e,n,r,i;return r=pos,i=pos,"cs"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cs"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(n=parse_customCritMod(),n=null!==n?n:"",null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){var r={customCrit:""!==e?[e]:[{}]};return""!==n&&(r.customCrit=r.customCrit.concat(n.customCrit)),r}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_customFumbleMod(){var t,e,n,r,i;return r=pos,i=pos,"cf"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"cf"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(n=parse_customFumbleMod(),n=null!==n?n:"",null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){var r={customFumble:""!==e?[e]:[{}]};return""!==n&&(r.customFumble=r.customFumble.concat(n.customFumble)),r}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_rerollMod(){var t,e,n,r,i;return r=pos,i=pos,"r"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"r"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(n=parse_rerollMod(),n=null!==n?n:"",null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){var r={reroll:""!==e?[e]:[{}]};return""!==n&&(r.reroll=r.reroll.concat(n.reroll)),r}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_rerollOnceMod(){var t,e,n,r,i;return r=pos,i=pos,"ro"===input.substr(pos,2).toLowerCase()?(t=input.substr(pos,2),pos+=2):(t=null,0===reportFailures&&matchFailed('"ro"')),null!==t?(e=parse_comparisonPoint(),e=null!==e?e:"",null!==e?(n=parse_rerollMod(),n=null!==n?n:"",null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){var r={reroll:""!==e?[e]:[{}]};return""!==n&&(r.reroll=r.reroll.concat(n.reroll)),r.reroll&&r.reroll[0]&&(r.reroll[0].maxrerolls=1),r}(r,t[1],t[2])),null===t&&(pos=r),t}function parse_sortMod(){var t,e,n,r;return n=pos,r=pos,"s"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"s"')),null!==t?(/^['a'|'d']/i.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("['a'|'d']i")),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e){return{sort:{order:e.toLowerCase()||"a"}}}(n,t[1])),null===t&&(pos=n),t}function parse_floorMod(){var t,e;return e=pos,"flr"===input.substr(pos,3)?(t="flr",pos+=3):(t=null,0===reportFailures&&matchFailed('"flr"')),null!==t&&(t=function(){return{round:{type:"floor"}}}(e)),null===t&&(pos=e),t}function parse_multipleMod(){var t,e,n,r;return n=pos,r=pos,"x"===input.substr(pos,1).toLowerCase()?(t=input.substr(pos,1),pos++):(t=null,0===reportFailures&&matchFailed('"x"')),null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e){return{multiple:{times:e}}}(n,t[1])),null===t&&(pos=n),t}function parse_successMod(){var t,e,n,r,i,o;return r=pos,i=pos,t=parse_comparisonPoint(),null!==t?(o=pos,"f"===input.substr(pos,1).toLowerCase()?(e=input.substr(pos,1),pos++):(e=null,0===reportFailures&&matchFailed('"f"')),null!==e?(n=parse_comparisonPoint(),null!==n?e=[e,n]:(e=null,pos=o)):(e=null,pos=o),e=null!==e?e:"",null!==e?t=[t,e]:(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e,n){var r={success:e};return""!==n&&(r.failure=n[1]),r}(r,t[0],t[1])),null===t&&(pos=r),t}function parse_comparisonPoint(){var t,e,n,r;return n=pos,r=pos,t=parse_comparison(),t=null!==t?t:"",null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e,n){return{comp:(""==e?"=":e)+"=",point:n}}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_comparison(){var t;return/^[>|<|=]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[>|<|=]")),t}function parse_mathExpression(){var t,e,n,r,i,o,s,a,l;return a=pos,l=pos,t=parse__(),null!==t?(e=parse_mathExpressionPrimary(),null!==e?(n=parse__(),null!==n?(r=parse_operator(),null!==r?(i=parse__(),null!==i?(o=parse_mathExpression(),null!==o?(s=parse__(),null!==s?t=[t,e,n,r,i,o,s]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e,n,r){return e+n+r}(a,t[1],t[3],t[5])),null===t&&(pos=a),null===t&&(a=pos,l=pos,t=parse__(),null!==t?(e=parse_mathExpressionPrimary(),null!==e?(n=parse__(),null!==n?t=[t,e,n]:(t=null,pos=l)):(t=null,pos=l)):(t=null,pos=l),null!==t&&(t=function(t,e){return e}(a,t[1])),null===t&&(pos=a)),t}function parse_mathExpressionPrimary(){var t,e,n,r,i,o,s;return o=pos,s=pos,t=parse__(),null!==t?(e=parse_number(),null!==e?(n=parse__(),null!==n?t=[t,e,n]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return e}(o,t[1])),null===t&&(pos=o),null===t&&(o=pos,s=pos,40===input.charCodeAt(pos)?(t="(",pos++):(t=null,0===reportFailures&&matchFailed('"("')),null!==t?(e=parse__(),null!==e?(n=parse_mathExpression(),null!==n?(r=parse__(),null!==r?(41===input.charCodeAt(pos)?(i=")",pos++):(i=null,0===reportFailures&&matchFailed('")"')),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e){return"("+e+")"}(o,t[2])),null===t&&(pos=o)),t}function parse_inlineLabelWithSpace(){var t,e,n,r,i;return r=pos,i=pos,t=parse__(),null!==t?(e=parse_inlineLabel(),null!==e?(n=parse__(),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)):(t=null,pos=i),null!==t&&(t=function(t,e){return e}(r,t[1])),null===t&&(pos=r),t}function parse_inlineLabel(){var t,e,n,r,i;if(r=pos,i=pos,91===input.charCodeAt(pos)?(t="[",pos++):(t=null,0===reportFailures&&matchFailed('"["')),null!==t){for(e=[],/^[^\]]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[^\\]]"));null!==n;)e.push(n),/^[^\]]/.test(input.charAt(pos))?(n=input.charAt(pos),pos++):(n=null,0===reportFailures&&matchFailed("[^\\]]"));null!==e?(93===input.charCodeAt(pos)?(n="]",pos++):(n=null,0===reportFailures&&matchFailed('"]"')),null!==n?t=[t,e,n]:(t=null,pos=i)):(t=null,pos=i)}else t=null,pos=i;return null!==t&&(t=function(t,e){return new Label(e.join(""))}(r,t[1])),null===t&&(pos=r),t}function parse_operator(){var t;return/^[+|\-|*|\/|%]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-|*|\\/|%]")),t}function parse_number(){var t;return t=parse_exponent(),null===t&&(t=parse_float(),null===t&&(t=parse_signedInteger())),t}function parse_integer(){var t,e,n;if(n=pos,/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]")),null!==e)for(t=[];null!==e;)t.push(e),/^[0-9]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[0-9]"));else t=null;return null!==t&&(t=function(t,e){return parseInt(e.join(""),10)}(n,t)),null===t&&(pos=n),t}function parse_signedInteger(){var t,e,n,r;return n=pos,r=pos,/^[+|\-]/.test(input.charAt(pos))?(t=input.charAt(pos),pos++):(t=null,0===reportFailures&&matchFailed("[+|\\-]")),t=null!==t?t:"",null!==t?(e=parse_integer(),null!==e?t=[t,e]:(t=null,pos=r)):(t=null,pos=r),null!==t&&(t=function(t,e,n){return"-"==e?-1*n:n}(n,t[0],t[1])),null===t&&(pos=n),t}function parse_float(){var t,e,n,r,i,o;if(i=pos,o=pos,t=parse_signedInteger(),t=null!==t?t:"",null!==t)if(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e){if(/^[0-9]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[0-9]")),null!==r)for(n=[];null!==r;)n.push(r),/^[0-9]/.test(input.charAt(pos))?(r=input.charAt(pos),pos++):(r=null,0===reportFailures&&matchFailed("[0-9]"));else n=null;null!==n?t=[t,e,n]:(t=null,pos=o)}else t=null,pos=o;else t=null,pos=o;return null!==t&&(t=function(t,e,n){return 0===e&&0>1/e?-1*parseFloat(e+"."+n.join("")):parseFloat(e+"."+n.join(""))}(i,t[0],t[2])),null===t&&(pos=i),t}function parse_exponent(){var t,e,n,r,i,o,s;return o=pos,s=pos,t=parse_signedInteger(),t=null!==t?t:"",null!==t?(46===input.charCodeAt(pos)?(e=".",pos++):(e=null,0===reportFailures&&matchFailed('"."')),null!==e?(n=parse_integer(),null!==n?(101===input.charCodeAt(pos)?(r="e",pos++):(r=null,0===reportFailures&&matchFailed('"e"')),null!==r?(i=parse_signedInteger(),null!==i?t=[t,e,n,r,i]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,n,r){return parseFloat(e+"."+n+"e"+r)}(o,t[0],t[2],t[4])),null===t&&(pos=o),null===t&&(o=pos,s=pos,t=parse_signedInteger(),null!==t?(101===input.charCodeAt(pos)?(e="e",pos++):(e=null,0===reportFailures&&matchFailed('"e"')),null!==e?(n=parse_signedInteger(),null!==n?t=[t,e,n]:(t=null,pos=s)):(t=null,pos=s)):(t=null,pos=s),null!==t&&(t=function(t,e,n){return parseFloat(e+"e"+n)}(o,t[0],t[2])),null===t&&(pos=o)),t}function parse__(){var t,e,n;for(n=pos,t=[],/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));return null!==t&&(t=function(t,e){return e.join("")}(n,t)),null===t&&(pos=n),t}function parse___(){var t,e,n;if(n=pos,/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]")),null!==e)for(t=[];null!==e;)t.push(e),/^[ |\t]/.test(input.charAt(pos))?(e=input.charAt(pos),pos++):(e=null,0===reportFailures&&matchFailed("[ |\\t]"));else t=null;return null!==t&&(t=function(t,e){return e.join("")}(n,t)),null===t&&(pos=n),t}function cleanupExpected(t){t.sort();for(var e=null,n=[],r=0;r<t.length;r++)t[r]!==e&&(n.push(t[r]),e=t[r]);return n}function computeErrorPosition(){for(var t=1,e=1,n=!1,r=0;r<Math.max(pos,rightmostFailuresPos);r++){var i=input.charAt(r);"\n"===i?(n||t++,e=1,n=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(t++,e=1,n=!0):(e++,n=!1)}return{line:t,column:e}}function log(t){console.log(t)}function MathExpression(t){this.type=d20.dice.TYPE_MATH_EXPR,this.expr=void 0!=t?t:""}function RollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.sides=e,this.mods={}}function FateRollExpression(t){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.fate=!0,this.mods={}}function TableRollExpression(t,e){this.type=d20.dice.TYPE_ROLL_EXPR,this.dice=t,this.table=e,this.mods={}}function GroupExpression(t,e){this.type=d20.dice.TYPE_GROUP_EXPR,this.rolls=t,this.mods=e||{}}function Label(t){this.type=d20.dice.TYPE_LABEL,this.text=t}function Comment(t){this.type=d20.dice.TYPE_COMMENT,this.text=t}function mergeExpressions(t,e){if("string"==typeof t){if(0==t.length)return e;t=new MathExpression(t)}if("string"==typeof e){if(0==e.length)return t;e=new MathExpression(e)}if(Array.isArray(t)&&Array.isArray(e)){if(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e[0].type==d20.dice.TYPE_MATH_EXPR){var n=t.pop();e[0].expr=n.expr+e[0].expr}return t.concat(e)}return Array.isArray(t)?(t[t.length-1].type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?t[t.length-1].expr+=e.expr:t.push(e),t):Array.isArray(e)?(e[0].type==d20.dice.TYPE_MATH_EXPR&&t.type==d20.dice.TYPE_MATH_EXPR?e[0].expr=t.expr+e[0].expr:e.unshift(t),e):t.type==d20.dice.TYPE_MATH_EXPR&&e.type==d20.dice.TYPE_MATH_EXPR?(t.expr+=e.expr,t):[t,e]}function processMods(t,e){var n=t;if(e.length>0)for(var r in e[0]){if(void 0!=n[r])throw{message:"'"+r+"' roll modifier can only be specified once"};n[r]=e[0][r]}return n}var parseFunctions={start:parse_start,rollExpression:parse_rollExpression,rollExpressionPrimary:parse_rollExpressionPrimary,validRollSuffix:parse_validRollSuffix,rollGroup:parse_rollGroup,rollGroupExpression:parse_rollGroupExpression,labelAwareRollOperator:parse_labelAwareRollOperator,rollOperator:parse_rollOperator,fullRoll:parse_fullRoll,coreRoll:parse_coreRoll,numberOfDice:parse_numberOfDice,numberOfSides:parse_numberOfSides,groupMods:parse_groupMods,rollMods:parse_rollMods,explodingMod:parse_explodingMod,compoundingMod:parse_compoundingMod,penetratingMod:parse_penetratingMod,keepMod:parse_keepMod,dropMod:parse_dropMod,customCritMod:parse_customCritMod,customFumbleMod:parse_customFumbleMod,rerollMod:parse_rerollMod,rerollOnceMod:parse_rerollOnceMod,sortMod:parse_sortMod,floorMod:parse_floorMod,multipleMod:parse_multipleMod,successMod:parse_successMod,comparisonPoint:parse_comparisonPoint,comparison:parse_comparison,mathExpression:parse_mathExpression,mathExpressionPrimary:parse_mathExpressionPrimary,inlineLabelWithSpace:parse_inlineLabelWithSpace,inlineLabel:parse_inlineLabel,operator:parse_operator,number:parse_number,integer:parse_integer,signedInteger:parse_signedInteger,"float":parse_float,exponent:parse_exponent,_:parse__,__:parse___};if(void 0!==startRule){if(void 0===parseFunctions[startRule])throw new Error("Invalid rule name: "+quote(startRule)+".")}else startRule="start";var pos=0,reportFailures=0,rightmostFailuresPos=0,rightmostFailuresExpected=[],d20="undefined"!=typeof window&&void 0!==window.d20?window.d20:{};void 0==d20.dice&&(d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V");var result=parseFunctions[startRule]();if(null===result||pos!==input.length){var offset=Math.max(pos,rightmostFailuresPos),found=offset<input.length?input.charAt(offset):null,errorPosition=computeErrorPosition();throw new this.SyntaxError(cleanupExpected(rightmostFailuresExpected),found,offset,errorPosition.line,errorPosition.column)}return result},toSource:function(){return this._source}};return result.SyntaxError=function(t,e,n,r,i){function o(t,e){var n,r;switch(t.length){case 0:n="end of input";break;case 1:n=t[0];break;default:n=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return r=e?quote(e):"end of input","Expected "+n+" but "+r+" found."}this.name="SyntaxError",this.expected=t,this.found=e,this.message=o(t,e),this.offset=n,this.line=r,this.column=i},result.SyntaxError.prototype=Error.prototype,result}(),d20.dice_formatter={},d20ext.dice_formatter=d20.dice_formatter,function(){var t=function(){},e=function(n){for(var r="",i=0;i<n.length;i++){if(n[i].type===d20.dice.TYPE_GROUP_EXPR){console.log("Descending into madness..."),r+="{<div class='parsegroup'>";for(var o=0;o<n[i].rolls.length;o++)r+="<div class='parsegroupitem ",n[i].results&&n[i].results[o].d&&(r+="dropped"),r+="'>",r+=e(n[i].rolls[o]),o+1<n[i].rolls.length&&(r+=" + "),r+="</div>";r+="</div>}"}if(n[i].type===d20.dice.TYPE_ROLL_EXPR){r+="<div class='dicegrouping' data-groupindex='"+i+"' ",n[i+1]&&n[i+1].type==d20.dice.TYPE_LABEL&&(r+="title='"+n[i+1].text.replace(/'/g,"&apos;")+"'"),r+=">",r+="(";for(var s=0;s<n[i].results.length;s++){r+="<div data-origindex='"+s+"' class='diceroll ",n[i].results.length>50&&(r+="withouticons "),n[i].fate?r+="d6":n[i].table||(r+="d"+n[i].sides),n[i].results[s].d===!0&&(r+=" dropped ");var a=!1,l=!1;if(n[i].mods&&n[i].mods.customCrit?_.each(n[i].mods.customCrit,function(t){"<="===t.comp?n[i].results[s].v<=t.point&&(a=!0):">="===t.comp?n[i].results[s].v>=t.point&&(a=!0):"=="===t.comp&&n[i].results[s].v===t.point&&(a=!0)}):n[i].results[s].v===n[i].sides&&(a=!0),a&&(r+=" critsuccess ",t()),n[i].mods&&n[i].mods.customFumble?_.each(n[i].mods.customFumble,function(t){"<="===t.comp?n[i].results[s].v<=t.point&&(l=!0):">="===t.comp?n[i].results[s].v>=t.point&&(l=!0):"=="===t.comp&&n[i].results[s].v===t.point&&(l=!0)}):1===n[i].results[s].v&&n[i].fate!==!0&&(l=!0),l&&(r+=" critfail "),r+="'><div class='dicon'><div class='didroll'>",n[i].fate===!0)switch(n[i].results[s].v){case 1:r+="+";break;case 0:r+="0";break;case-1:r+="-"}else r+=n[i].results[s].tableItem?n[i].results[s].tableItem.avatar&&""!=n[i].results[s].tableItem.avatar?"<img src='"+n[i].results[s].tableItem.avatar+"' title='"+d20ext.utils.strip_tags(n[i].results[s].tableItem.name).replace(/'/g,"&apos;")+"' />":d20ext.utils.strip_tags(n[i].results[s].tableItem.name):n[i].results[s].v;r+="</div><div class='backing'></div></div>",n[i].fate!==!0&&s+1<n[i].results.length&&(r+="+"),r+="</div>"}r+=")",r+="</div>"}else n[i].type===d20.dice.TYPE_MATH_EXPR&&(r+=n[i].expr)}return r},n=function(t){if(t){for(var e="",r=0;r<t.length;r++){if(t[r].type===d20.dice.TYPE_GROUP_EXPR){console.log("Descending into madness..."),e+="{";for(var i=0;i<t[r].rolls.length;i++)e+=n(t[r].rolls[i]),i+1<t[r].rolls.length&&(e+="+");e+="}"}if(t[r].type===d20.dice.TYPE_ROLL_EXPR){var o=void 0!==t[r].results?t[r].results.length:0;e+="(";for(var s=0;o>s;s++){if(e+="<span class='basicdiceroll",t[r].results[s].d)e+=" dropped";else{var a=!1,l=!1;t[r].mods&&t[r].mods.customCrit?_.each(t[r].mods.customCrit,function(e){"<="===e.comp?t[r].results[s].v<=e.point&&(a=!0):">="===e.comp?t[r].results[s].v>=e.point&&(a=!0):"=="===e.comp&&t[r].results[s].v===e.point&&(a=!0)}):t[r].results[s].v===t[r].sides&&(a=!0),a&&(e+=" critsuccess "),t[r].mods&&t[r].mods.customFumble?_.each(t[r].mods.customFumble,function(e){"<="===e.comp?t[r].results[s].v<=e.point&&(l=!0):">="===e.comp?t[r].results[s].v>=e.point&&(l=!0):"=="===e.comp&&t[r].results[s].v===e.point&&(l=!0)}):1===t[r].results[s].v&&t[r].fate!==!0&&(l=!0),l&&(e+=" critfail ")}if(e+="'>",t[r].fate===!0)switch(t[r].results[s].v){case 1:e+="+";break;case 0:e+="0";break;case-1:e+="-"}else e+=t[r].results[s].tableItem?d20ext.utils.strip_tags(t[r].results[s].tableItem.name):t[r].results[s].v;e+="</span>",t[r].fate!==!0&&s+1<t[r].results.length&&(e+="+")}e+=")"}else t[r].type===d20.dice.TYPE_MATH_EXPR&&(e+=t[r].expr)}return e}};d20.dice_formatter.checkForCrits=function(t,e){if(!t)return!1;for(var n=!1,r=!1,i=0;i<t.length;i++){if(t[i].type===d20.dice.TYPE_GROUP_EXPR)for(var o=0;o<t[i].rolls.length;o++)d20.dice_formatter.checkForCrits(t[i].rolls[o],e)===!0&&("crit"===e?n=!0:r=!0);if(t[i].type===d20.dice.TYPE_ROLL_EXPR)for(var s=void 0!==t[i].results?t[i].results.length:0,a=0;s>a;a++)t[i].results[a].d!==!0&&(t[i].mods&&t[i].mods.customCrit?_.each(t[i].mods.customCrit,function(e){"<="===e.comp?t[i].results[a].v<=e.point&&(n=!0):">="===e.comp?t[i].results[a].v>=e.point&&(n=!0):"=="===e.comp&&t[i].results[a].v===e.point&&(n=!0)}):t[i].results[a].v===t[i].sides&&(n=!0),t[i].mods&&t[i].mods.customFumble?_.each(t[i].mods.customFumble,function(e){"<="===e.comp?t[i].results[a].v<=e.point&&(r=!0):">="===e.comp?t[i].results[a].v>=e.point&&(r=!0):"=="===e.comp&&t[i].results[a].v===e.point&&(r=!0)}):1===t[i].results[a].v&&t[i].fate!==!0&&(r=!0))}return"crit"===e?n:r},d20.dice_formatter.getHtmlForResult=function(t){var n=e(t.rolls);return{formula:n,total:t.total+(t.resultType===d20.dice.ROLL_TYPE_SUCCESS?" Successes":"")}},d20.dice_formatter.replaceInlineRolls=function(t,e,r){return t=d20.utils.strip_tags(t,r),e.inlinerolls?t=t.replace(/\$\[\[[0-9]+\]\]/g,function(t){var i=t.substring(3,t.length-1),o=e.inlinerolls[parseInt(i,10)];if(!o||!o.results)return"INVALID INLINE ROLL!";o.expression=o.expression.replace("<","&lt;");var s="Rolling "+d20.utils.strip_tags(o.expression,r)+" = ";o.signature&&d20.textchat.verifyRoll(o.rollid,o.results,o.signature)&&(s="<img src='/images/quantumrollwhite.png' class='inlineqroll'> "+s),s+=n(o.results.rolls);var a=o.results.total;try{0==a&&o.results.rolls[0].results[0].tableItem&&(a=d20ext.utils.strip_tags(o.results.rolls[0].results[0].tableItem.name))}catch(l){}var u="<span class='inlinerollresult showtip tipsy-n",c=-1!==s.indexOf("critsuccess"),p=-1!==s.indexOf("critfail");return c&&p?u+=" importantroll":c?u+=" fullcrit":p&&(u+=" fullfail"),u+="' title='"+s.replace(/'/g,"&quot;")+"'>"+a+"</span>"}):t};var r={"@":"critsuccess","#":"critfail",_:"dropped"},i=function(t,e){for(var n in r){var o=new RegExp("\\{"+n+"(.+?)"+n+"\\}","g");if(null!=(match=o.exec(t)))return e.push(r[n]),i(match[1],e)}return t};d20.dice_formatter.oldformat=function(t){return void 0===t?"":t.replace(/\{([@#_])(.+?)\1\}/g,function(t,e,n){var o=[r[e]],n=i(n,o);return"<span class='"+o.sort().join(" ")+"'>"+n+"</span>"})}}();var d20=d20||{};d20.dice_engine=function(seed){function TaskCompletionCallback(t,e,n){var r=0,i=!1;this.taskComplete=function(){if(r==t)throw"All "+r+" tasks have already been completed for: "+n;r++,r==t&&(i=!0,e())},this.verify=function(){r!=t||i||e()}}function RollResult(t){this.i=t,this.v=0}function GroupResult(t){this.v=t}function ValidatedRollExpression(t,e){this.type=d20.dice.TYPE_VALIDATED_ROLLS,this.rolls=t,this.resultType=e}function ExpressionBuilder(){var expression="",groupMemeberCount=void 0,verifyInGroup=function(){if(void 0==groupMemeberCount)throw"Not currently in a group expression: '"+expression+"'"};this.addMathExpr=function(t){expression+=t},this.startGroup=function(){expression+="(",groupMemeberCount=0},this.addGroupValue=function(t){verifyInGroup(),groupMemeberCount>0&&(expression+="+"),expression+=t,groupMemeberCount++},this.addGroupSuccess=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?1:0)")},this.addGroupFailure=function(t,e){this.addGroupValue("("+t+e.comp+e.point+"?-1:0)")},this.endGroup=function(){verifyInGroup(),0==groupMemeberCount&&(expression+="0"),expression+=")",groupMemeberCount=void 0},this.eval=function(){log(expression);var result,thisexp=expression;return function(){"use strict";var floor=Math.floor,ceil=Math.ceil,round=Math.round,max=Math.max,min=Math.min,abs=Math.abs;try{result=eval(thisexp)}catch(e){result=0}}(),result}}d20.dice=d20.dice||{},d20.dice.TYPE_MATH_EXPR="M",d20.dice.TYPE_ROLL_EXPR="R",d20.dice.TYPE_GROUP_EXPR="G",d20.dice.TYPE_LABEL="L",d20.dice.TYPE_COMMENT="C",d20.dice.TYPE_VALIDATED_ROLLS="V",d20.dice.ROLL_TYPE_SUCCESS="success",d20.dice.ROLL_TYPE_TABLE="table",d20.dice.ROLL_TYPE_SUM="sum",void 0==d20.getTableElementCount&&(d20.getTableElementCount=function(t){return log("Using fallback getTableElementCount("+t+")"),t.length},d20.getTableElementValue=function(t,e){return log("Using fallback getTableElementValue("+t+", "+e+")"),parseInt(t,10)||0});var MAX_NUM_ROLLS=999,MAX_ROLL=9999999;console.log("Initializing new dice engine with randomness..."),void 0==seed?(console.log("Using random entropy"),Math.seedrandom(window.RANDOM_ENTROPY,!0)):Math.seedrandom(seed),this.random=Math.randomInt;var othis=this,log=function(t){},logerr=function(t){_.isFunction(t)&&(t=t()),console.log(t)},fallbackErrorHandler=function(t){throw logerr(t),t},diceRollToString=function(t){var e=t.dice+"d"+t.sides;return t.mods.compounding&&(e+="!!"+comparePointToString(t.mods.compounding)),t.mods.penetrating&&(e+="!p"+comparePointToString(t.mods.penetrating)),t.mods.exploding&&(e+="!"+comparePointToString(t.mods.exploding)),t.mods.keep&&(e+="k","h"!=t.mods.keep.end&&(e+=t.mods.keep.end),e+=t.mods.keep.count),t.mods.drop&&(e+="k","l"!=t.mods.drop.end&&(e+=t.mods.drop.end),e+=t.mods.drop.count),t.mods.reroll&&t.mods.reroll.forEach(function(t){e+="r"+comparePointToString(t)}),t.mods.sort&&(e+="s"+t.mods.sort.order),t.mods.success&&(e+=comparePointToString(t.mods.success,!0)),t.mods.failure&&(e+="f"+comparePointToString(t.mods.failure,!0)),e},comparePointToString=function(t,e){var n="";return t.point&&(("=="!=t.comp||e)&&(n+=t.comp.charAt(0)),n+=t.point),n},validateParseResult=function(t){for(var e=void 0,n=0;n<t.length;n++){if(t[n].type==d20.dice.TYPE_ROLL_EXPR||t[n].type==d20.dice.TYPE_GROUP_EXPR){var r=getRollType(t[n]);if(void 0==e)e=r;else if(e!=r)throw"Cannot mix "+e+" and "+r+" rolls in a single roll expression"}if(t[n].type==d20.dice.TYPE_ROLL_EXPR){if(t[n].fate?t[n].sides=3:void 0!=t[n].table&&(t[n].sides=d20.getTableElementCount(t[n].table)),t[n].fate&&void 0!=t[n].mods.compounding)throw"Compounding FATE dice are not legal, try ! instead of !! for exploding FATE dice";if(t[n].mods&&void 0!=t[n].mods.exploding&&t[n].sides<2)throw"You must roll a d2 or higher to roll exploding dice.";t[n].dice=Math.max(Math.min(t[n].dice,MAX_NUM_ROLLS),0),t[n].sides=Math.max(Math.min(t[n].sides,MAX_ROLL),0)}if(t[n].type==d20.dice.TYPE_GROUP_EXPR){if(1==t[n].rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS)for(var i=!1,o=0;o<t[n].rolls[0].length;o++)if(t[n].rolls[0][o].type==d20.dice.TYPE_ROLL_EXPR){if(i)throw"Only one roll expression is allowed in a single sub-roll expression success check";i=!0}else if(t[n].rolls[0][o].type==d20.dice.TYPE_GROUP_EXPR)throw t[n].rolls[0][o].type+" expression is not supported in a single sub-roll expression success check";for(var s=void 0,a=0;a<t[n].rolls.length;a++){var l=validateParseResult(t[n].rolls[a]);if(void 0==s)s=l;else if(s!=l)throw"Cannot mix "+s+" and "+l+" rolls in a  roll group"}t[n].resultType=s}}if(void 0==e){if(t[0].type===d20.dice.TYPE_MATH_EXPR)return d20.dice.TYPE_MATH_EXPR;throw"Could not determine result type of: "+JSON.stringify(t)}return e},getRollType=function(t){return t.mods&&void 0!==t.mods.success?d20.dice.ROLL_TYPE_SUCCESS:void 0!=t.sides&&t.sides.type==d20.dice.TYPE_LABEL?d20.dice.ROLL_TYPE_TABLE:d20.dice.ROLL_TYPE_SUM},parseRollString=function(t){log(function(){return"E parseRollString: "+t});var e=d20.DicePEG.parse(t);log(e);var n=validateParseResult(e),r=new ValidatedRollExpression(e,n);return log(r),log(JSON.stringify(r)),log(function(){return"L parseRollString: "+r.rolls.length+" expressions from: "+t}),r},initiateRolls=function(t,e,n){for(var r=0;r<t.length;r++)t[r].type==d20.dice.TYPE_ROLL_EXPR?doRolls(t[r],n):t[r].type==d20.dice.TYPE_GROUP_EXPR?initiateGroupRolls(t[r],e,n):n()},initiateGroupRolls=function(t,e,n){for(var r=new TaskCompletionCallback(t.rolls.length,function(){postProcessCompleteGroup(t,e),n()},"groupCompleteCallback"),i=0;i<t.rolls.length;i++)initiateSubGroupRolls(t.rolls[i],t.resultType,r)},initiateSubGroupRolls=function(t,e,n){var r=new TaskCompletionCallback(t.length,function(){n.taskComplete()},"subGroupCompleteCallback");initiateRolls(t,e,function(){r.taskComplete()})},doRolls=function(t,e){log(function(){return diceRollToString(t)+"	 - E doRolls"}),t.results=[];for(var n=new TaskCompletionCallback(t.dice,function(){diceRollCompleteCallback(t),e()},"rollCompleteCallback"),r=function(){n.taskComplete()
},i=0;i<t.dice;i++)rollDie(i,t,r);n.verify(),log(function(){return diceRollToString(t)+"	 - L doRolls"})},diceRollCompleteCallback=function(t){if(log(function(){return diceRollToString(t)+"	 - E diceRollCompleteCallback"}),t.results.sort(function(t,e){var n=t.i-e.i;return 0!=n||t.d==e.d?n:t.d?-1:1}),t.results.forEach(function(t){delete t.i}),t.mods&&void 0!=t.mods.keep){var e="l"==t.mods.keep.end?"a":"d",n=sortRolls(t.results,e);keepRolls(n,t.mods.keep.count)}if(t.mods&&void 0!=t.mods.drop){var e="l"==t.mods.drop.end?"a":"d",n=sortRolls(t.results,e);dropRolls(n,t.mods.drop.count)}t.mods&&void 0!=t.mods.sort&&(t.results=sortRolls(t.results,t.mods.sort.order)),log(function(){return diceRollToString(t)+"	 - L diceRollCompleteCallback"})},postProcessCompleteGroup=function(t,e){if(log(function(){return"E postProcessCompleteGroup("+e+")"}),t.mods&&void 0!=t.mods.keep&&1==t.rolls.length){var n="l"==t.mods.keep.end?"a":"d",r=buildSubGroupRollsArray(t.rolls[0]);r=sortRolls(r,n),keepRolls(r,t.mods.keep.count),cleanupSubGroupValues(t.rolls[0])}if(t.mods&&void 0!=t.mods.drop&&1==t.rolls.length){var n="l"==t.mods.drop.end?"a":"d",r=buildSubGroupRollsArray(t.rolls[0]);r=sortRolls(r,n),dropRolls(r,t.mods.drop.count),cleanupSubGroupValues(t.rolls[0])}if(totalResult(t,e),t.mods&&void 0!=t.mods.keep&&t.rolls.length>1){var n="l"==t.mods.keep.end?"a":"d",i=sortRolls(t.results,n);keepRolls(i,t.mods.keep.count)}if(t.mods&&void 0!=t.mods.drop&&t.rolls.length>1){var n="l"==t.mods.drop.end?"a":"d",i=sortRolls(t.results,n);dropRolls(i,t.mods.drop.count)}log(function(){return"L postProcessCompleteGroup"})},buildSubGroupRollsArray=function(t){for(var e=[],n=0;n<t.length;n++)t[n].type==d20.dice.TYPE_ROLL_EXPR?e=e.concat(t[n].results):t[n].type==d20.dice.TYPE_GROUP_EXPR&&(t[n].v=totalResult(t[n],t[n].resultType).eval(),e.push(t[n]));return e},cleanupSubGroupValues=function(t){t.forEach(function(t){t.type==d20.dice.TYPE_GROUP_EXPR&&delete t.v})},keepRolls=function(t,e){for(var n=0,r=0;r<t.length;r++)t[r].d||(e>n?n++:t[r].d=!0)},dropRolls=function(t,e){for(var n=0,r=0;r<t.length&&e>n;r++)t[r].d||(t[r].d=!0,n++)},sortRolls=function(t,e){var n="d"==e?-1:1;return t.slice(0).sort(function(t,e){return(t.v-e.v)*n})},asyncRand=function(t,e,n,r){if(0===t)setTimeout(function(){e(0)},0);else{if("undefined"==typeof Firebase&&d20.tddice&&d20.tddice.canRoll3D()&&!n)return void d20.tddice.roller(t,e,r);if(6===t&&d20.textchat&&d20.textchat.egg_clickhole&&!$("#lightly-overlay").is(":visible")){var i=[["2990",1,4],["2991",1,7],["2992",1,12],["2993",2,7],["2994",2,5],["2995",2,38],["2996",2,11],["2997",3,13],["2998",3,16],["2999",3,6],["3000",3,16],["3001",4,17],["3002",4,18],["3003",4,16],["3004",5,7],["3006",5,24],["3005",5,14],["3007",5,27],["3008",6,7],["3009",6,6],["3010",6,5],["3012",6,10]],o=i[othis.random(i.length)];d20.textchat.sendShout({type:"playclickhole",playerid:window.currentPlayer.id,content:o,time:(new Date).getTime()}),window.fakeLightly&&window.fakeLightly("http://v.theonion.com/onionstudios/video/"+o[0]+"/640.mp4"),setTimeout(function(){e(o[1]),$("#lightly-overlay").hide()},1e3*o[2]+2e3)}else setTimeout(function(){e(othis.random(t)+1)},0)}},compareToPoint=function(value,cp,defaultPoint){if(void 0!=cp.comp){var cpFormula=value+cp.comp+cp.point,cpResult=eval(cpFormula);return cpResult}return value==defaultPoint},rollDie=function(t,e,n,r){var i=new RollResult(t);e.results.push(i),function(t){asyncRand(e.sides,function(i){individualRollCallback(e,t,i,n,r)},void 0!==e.table,e.rollid)}(i)},individualRollCallback=function(t,e,n,r,i){if(i=i||0,log(function(){return diceRollToString(t)+"	 - E individualRollCallback("+i+") "+n}),void 0!==t.table?(e.tableidx=n-1,e.v+=d20.getTableElementValue(t.table,e.tableidx)):e.v+=n,t.fate&&(e.v-=2),t.mods&&void 0!=t.mods.penetrating&&i>0&&(e.v-=1),i>MAX_NUM_ROLLS)r();else if(t.mods&&void 0!=t.mods.exploding&&compareToPoint(n,t.mods.exploding,t.sides))rollDie(e.i,t,r,i+1);else if(t.mods&&void 0!=t.mods.compounding&&compareToPoint(n,t.mods.compounding,t.sides))asyncRand(t.sides,function(n){individualRollCallback(t,e,n,r,i+1)},void 0!==t.table,t.rollid);else if(t.mods&&void 0!=t.mods.penetrating&&compareToPoint(n,t.mods.penetrating,t.sides))rollDie(e.i,t,r,i+1);else if(t.mods&&void 0!=t.mods.reroll){var o=t.mods.reroll.some(function(o){if(o.maxrerolls)for(var s=0,a=0;a<t.results.length;a++)t.results[a].i===e.i&&t.results[a].d===!0&&s++;return compareToPoint(n,o,1)?o.maxrerolls&&s>=o.maxrerolls?!1:(e.d=!0,rollDie(e.i,t,r,i+1),!0):!1});o||r()}else r();log(function(){return diceRollToString(t)+"	 - L individualRollCallback("+i+") "+n})},postProcessCompleteRolls=function(t,e,n){if(log(function(){return"E postProcessCompleteRolls"}),t.type==d20.dice.TYPE_VALIDATED_ROLLS){var r=postProcessCompleteRolls(t.rolls,t.resultType);return t.total=r,r}var i=totalResults(t,e,n);return log(function(){return"L postProcessCompleteRolls - "+i}),i},totalResults=function(t,e,n,r){for(var r=r||new ExpressionBuilder,r=new ExpressionBuilder,i=0;i<t.length;i++)totalResult(t[i],e,n,r);return r.eval()},totalResult=function(t,e,n,r){var r=r||new ExpressionBuilder;if(t.type==d20.dice.TYPE_ROLL_EXPR){r.startGroup();for(var i=0;i<t.results.length;i++)t.results[i].d||addResultValue(r,e,t.results[i].v,t);r.endGroup()}else if(t.type==d20.dice.TYPE_MATH_EXPR)r.addMathExpr(t.expr);else if(t.type==d20.dice.TYPE_GROUP_EXPR){if(r.startGroup(),!t.d)if(void 0==t.results||n)if(t.results=[],1==t.rolls.length&&e==d20.dice.ROLL_TYPE_SUCCESS){for(var o="",s=void 0,a="",l=0;l<t.rolls[0].length;l++)if(t.rolls[0][l].type==d20.dice.TYPE_ROLL_EXPR){if(void 0!=s)throw"Only one roll expression is allowed in a single sub-roll expression success check";s=t.rolls[0][l]}else if(t.rolls[0][l].type==d20.dice.TYPE_MATH_EXPR)void 0==s?o+=t.rolls[0][l].expr:a+=t.rolls[0][l].expr;else if(t.rolls[0][l].type==d20.dice.TYPE_GROUP_EXPR)throw t.rolls[0][l].type+" expression is not supported in a single sub-roll expression success check";for(var l=0;l<s.results.length;l++)if(!s.results[l].d){var u=new ExpressionBuilder;u.startGroup(),u.addMathExpr(o),u.addGroupValue(s.results[l].v),u.addMathExpr(a),u.endGroup(),t.results.push(new GroupResult(u.eval()))}}else for(var c=0;c<t.rolls.length;c++){var p=totalResults(t.rolls[c],t.resultType,n);t.results.push(new GroupResult(p)),addResultValue(r,e,p,t)}else t.results.forEach(function(n){n.d||addResultValue(r,e,n.v,t)});r.endGroup()}return r},addResultValue=function(t,e,n,r){if(e==d20.dice.ROLL_TYPE_SUM)t.addGroupValue(n);else{if(e!=d20.dice.ROLL_TYPE_SUCCESS)throw"Unsupported resultType: "+e;t.addGroupSuccess(n,r.mods.success),r.mods&&void 0!=r.mods.failure&&t.addGroupFailure(n,r.mods.failure)}};this.reprocess=function(t,e,n){n=n||fallbackErrorHandler;try{postProcessCompleteRolls(t,void 0,!0),e(t)}catch(r){n(r)}};var remoteRollQueue=[],remoteRollCallbacks={},performRemoteRoll=function(t,e,n,r,i){remoteRollQueue.push({vre:t,rollid:e,rolltype:n}),remoteRollCallbacks[e]={success:r,error:i},debounced_doRemoteRollRequest()},_doRemoteRollRequest=function(){if(0!==remoteRollQueue.length)if(!window.is_playerapp&&window.currentPlayer.get("tddiceenabled")&&window.currentPlayer.get("disableagency")===!1){if($("#tdagencyoverlay").is(":visible"))return;$("#tdagencyoverlay").show(),numberofdice=remoteRollQueue[0].vre.rolls[0].dice?remoteRollQueue[0].vre.rolls[0].dice:1,d20.tddice.playsound("dicecup",numberofdice);var t={},e=$("#tdagencyoverlay svg line"),n=!1;$("#tdagencyoverlay").on("mousedown",function(r){t.startx=r.clientX/$(window).width(),t.starty=r.clientY/$(window).height(),e.attr("x1",r.clientX).attr("y1",r.clientY).attr("x2",r.clientX).attr("y2",r.clientY),n=!0}),$("#tdagencyoverlay").on("mousemove",function(r){if(n){xdist=Math.abs(t.startx-r.clientX/$(window).width()),ydist=Math.abs(t.starty-r.clientY/$(window).height());var i=Math.sqrt(xdist*xdist+ydist*ydist);.2>i?e.css("stroke","rgb(255,255,255)"):.5>i?e.css("stroke","rgb(245,238,44)"):e.css("stroke","rgb(245,44,44)"),e.attr("x2",r.clientX).attr("y2",r.clientY)}}),$("#tdagencyoverlay").on("mouseup",function(n){$("#tdagencyoverlay").off().hide(),e.attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0),t.startx?(t.stopx=n.clientX/$(window).width(),t.stopy=n.clientY/$(window).height(),_posthookrollrequest(t)):_posthookrollrequest()})}else setTimeout(function(){_posthookrollrequest()},50)},_posthookrollrequest=function(t){if(0!==remoteRollQueue.length){var e={cid:window.campaign_storage_path,fbnum:window.FIREBASE_ROOT,authkey:window.GNTKN,pid:window.currentPlayer.id,rolls:remoteRollQueue,use3d:window.currentPlayer.get(window.is_playerapp?"apptddiceenabled":"tddiceenabled")};if(t){var n={x:t.startx-t.stopx,y:t.starty-t.stopy};mindistance=.01,maxdistance=.3,Math.abs(n.x)<mindistance&&(n.x=n.x<0?-mindistance:mindistance),Math.abs(n.y)<mindistance&&(n.y=n.y<0?-mindistance:mindistance),Math.abs(n.x)>maxdistance&&(n.x=n.x<0?-maxdistance:maxdistance),Math.abs(n.y)>maxdistance&&(n.y=n.y<0?-maxdistance:maxdistance),e.deltas={x:80*n.x*-1,y:80*n.y*1}}else e.use3d===!0&&(e.deltas={x:10*Math.random()-5,y:20});$.ajax({url:"https://app.roll20.net/doroll",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",success:function(t){var e=t;for(var n in e)if(void 0==e[n].error){var r=JSON.parse(e[n].json);postProcessCompleteRolls(r),remoteRollCallbacks[n].success(r,n,e[n].signature,e[n].tdseed),d20.tutorial&&void 0!==e[n].shoutjson&&d20.tddice.remoteRoll(JSON.parse(e[n].shoutjson))}else remoteRollCallbacks[n].error("There was an error fetching your roll. "+e[n].error)},error:function(){console.log("Error fetching from QuantumRoll, fallback to local rolls."),_.each(e.rolls,function(t){var e=t.vre,n=new TaskCompletionCallback(e.rolls.length,function(){postProcessCompleteRolls(e),setTimeout(function(){remoteRollCallbacks[t.rollid].success(e,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(e.rolls,e.resultType,function(){n.taskComplete()})})}}),remoteRollQueue=[]}};this.flushRemoteQueue=function(){_doRemoteRollRequest()};var debounced_doRemoteRollRequest=_.debounce(_doRemoteRollRequest,100);return this.process=function(t,e,n){n=n||fallbackErrorHandler;try{var r=parseRollString(t);if(0==r.rolls)throw"There were no dice to roll!";var i=!1,o=!1,s=0,a=function(t){if(s++,void 0!==t)for(var e=0;e<t.length;e++)if(void 0!==t[e].table&&(i=!0),"R"===t[e].type&&(o=!0),(!i||!o)&&99>s&&void 0!==t[e].rolls&&t[e].rolls.length>0)for(var n=0;n<t[e].rolls.length;n++)a(t[e].rolls[n])};try{a(r.rolls)}catch(l){console.log("Error while checking for table existence. Ignoring.")}if(a=null,d20.textchat&&d20.textchat.egg_clickhole&&(i=!0),"undefined"==typeof Firebase||i===!0||o===!1){var u=new TaskCompletionCallback(r.rolls.length,function(){postProcessCompleteRolls(r),setTimeout(function(){e(r,null,!1)},0)},"wholeRollCompleteCallback");initiateRolls(r.rolls,r.resultType,function(){u.taskComplete()})}else if("undefined"==typeof $){var c=generateUUID(),p={vre:r,cid:CAMPAIGNID,fbnum:"https://"+FIREBASENUM+".firebaseio.com/",pid:"api",rid:c,use3d:!1,authkey:FIREBASETOKEN,rolltype:d20.textchat.currentRollType};request.post({url:"https://app.roll20.net/doroll",body:p,json:!0,timeout:5e3},function(t,r,i){if(t||200!=r.statusCode||""===i)n("There was an error communicating with the QuantumRoll server.");else{var o=i;if(void 0!==o.error)return void n("There was an error fetching your roll. "+o.error);var s=JSON.parse(o.json);postProcessCompleteRolls(s),e(s,c,o.signature)}})}else{var c=generateUUID();performRemoteRoll(r,c,d20.textchat.currentRollType,e,n)}}catch(l){n(l)}},this.handleRollReq=function(t,e){var n=new TaskCompletionCallback(t.rolls.length,function(){try{postProcessCompleteRolls(t)}catch(n){return void e({error:"There was an error processing this roll."})}setTimeout(function(){e(t)},0)},"wholeRollCompleteCallback");try{initiateRolls(t.rolls,t.resultType,function(){n.taskComplete()})}catch(r){e({error:"There was an error processing this roll."})}},this.handleRollString=function(t){var e=parseRollString(t);if(0==e.rolls)throw"There were no dice to roll!";return e},this},d20.textchat={commandhistory:[],commandIndex:0,currentRollType:"rollresult",commandInProgress:!1,lastChatBeep:0,talktomyself:!1,allowed3drolls:[],globalrolled:0,egg_clickhole:!1},$(function(){var t,e,n,r="",i=0,o=!0,s=!1,a=!1,l={},u={};d20.textchat.tabIsFocused=!0,d20.dice_engine&&(d20.textchat.diceengine=new d20.dice_engine),$(window).bind("focus",function(){o=!0}),$(window).bind("blur",function(){o=!1}),d20.textchat.$textarea=$("#textchat-input textarea"),d20.textchat.$speakingas=$("#speakingas"),d20.textchat.$textchat=$("#textchat");var c=new X509;c.readCertPEM("-----BEGIN CERTIFICATE-----MIICtTCCAl+gAwIBAgIJAJtwle/qkHJnMA0GCSqGSIb3DQEBBQUAMHIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UEChMGUm9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90ZWFtQHJvbGwyMC5uZXQwHhcNMTQwMzAzMTgwMTQ4WhcNMTQwNDAyMTgwMTQ4WjByMQswCQYDVQQGEwJVUzELMAkGA1UECBMCS1MxEDAOBgNVBAcTB1dpY2hpdGExDzANBgNVBAoTBlJvbGwyMDETMBEGA1UEAxMKcm9sbDIwLm5ldDEeMBwGCSqGSIb3DQEJARYPdGVhbUByb2xsMjAubmV0MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALJq8muAFnZMkJysXg9VJsevoQxtxV1NytYvCKHTtaCja/tyeLTRei0nu+NymPfNKKiRhv7R8D33oZLvIA/udusCAwEAAaOB1zCB1DAdBgNVHQ4EFgQUarGxVvODYDpzS5OKyKsTyCEmDSUwgaQGA1UdIwSBnDCBmYAUarGxVvODYDpzS5OKyKsTyCEmDSWhdqR0MHIxCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UEChMGUm9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90ZWFtQHJvbGwyMC5uZXSCCQCbcJXv6pByZzAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA0EAjBHayltU3K4DCs2h4nC2quGGKzGE2h1nMCBzhQ1ed+vir+lLnWQvAOrqt50Nx7lMk+23uFGhGMysK2UyrqptMw==-----END CERTIFICATE-----");var p=/\/((roll)|(r)|(gmroll)|(gr))[ ]+/i,h=function(t,e){if(t.content=t.content+"",null!==t.content.match(p)){var n="rollresult";null!==t.content.match(/\/((gmroll)|(gr))[ ]+/i)&&(n="gmrollresult"),d20.textchat.currentRollType=n;try{var r=t.content.replace(p,"");r=r.replace(/\$\[\[[0-9]+\]\]/g,function(e){var n=e.substring(3,e.length-1),r=t.inlinerolls[parseInt(n,10)];return r?r.results.total:"INVALID INLINE ROLL"});var i=function(t,e){var n=0,r=!1;return e>99?void console.log("Too many subgroups, abort."):(_.each(t,function(t){if("G"===t.type)_.each(t.rolls,function(t){var o=i(t,e+1);void 0!==o&&(n+=o,r=!0)});else if(t.table){var o=d20.Campaign.rollabletables.findTableByName(t.table),s=o.getWeightedArray();o&&_.each(t.results,function(t){r=!0,t.tableItem=o.tableitems.get(s[t.tableidx]).toJSON(),void 0===t.d&&(n+=t.v)})}else t.results&&_.each(t.results,function(t){return t.d?!0:void(n+=t.v)})}),r?n:void 0)};d20.utils.textchatNotify("Rolling the dice..."),d20.textchat.diceengine.process(r,function(r,o,s,a){if(d20.textchat.globalrolled++,d20.utils.textchatNotify(!1),r.error){var l={who:"error",type:"error",content:r.error};d20.textchat.incoming(!1,l)}else{if(r.rolls&&r.rolls.length>0)try{var u=i(r.rolls,0);void 0!==u&&(s=null)}catch(c){console.log("ERROR matching table"),console.log(c)}var h={who:d20.textchat.$speakingas.find("option:selected").text(),type:n,content:JSON.stringify(r),signature:s,origRoll:t.content.replace(p,""),playerid:window.currentPlayer.id,avatar:t.avatar,_fbid:o};a&&(h.tdseed=a),t.opts&&t.opts.tracker&&g(t.currentSelected,r,t.opts.tracker),e(h)}},function(t){console.log(t);var e={who:"error",type:"error",content:"string"==typeof t?t:"There was an error with your formula. Please try again."};d20.textchat.incoming(!1,e),d20.utils.textchatNotify(!1)})}catch(o){console.log(o);var s={who:"error",type:"error",content:"string"==typeof o?o:"There was an error with your formula. Please try again."};d20.textchat.incoming(!1,s)}}else if("/em "===t.content.substring(0,4)||"/e "==t.content.substring(0,3)||"/me "==t.content.substring(0,4)){var a=t.content.replace("/em ","").replace("/e ","").replace("/me ",""),l={who:d20.textchat.$speakingas.find("option:selected").text(),type:"emote",content:a,playerid:window.currentPlayer.id,avatar:t.avatar};e(l)}else if("/ooc "===t.content.substring(0,5)||"/o "===t.content.substring(0,3)){var u=t.content.replace("/ooc ","").replace("/o ",""),l={who:d20.textchat.$speakingas.find("option:first-child").text(),type:"general",playerid:window.currentPlayer.id,content:u,avatar:"/users/avatar/"+window.currentPlayer.get("d20userid")+"/30"};e(l)}else if(window.is_gm&&"/as "===t.content.substring(0,4)){var u=t.content.substring(4,t.content.length),c=u.match(/\w+|"[^"]+"/);if(null==c||!c.length)throw'Invalid. Try /as "Name of Character" <message>';u=u.substring(c[0].length,u.length);var l={who:'"'===c[0][0]?c[0].substring(1,c[0].length-1):c[0],type:"general",playerid:window.currentPlayer.id,content:u};e(l)}else if(window.is_gm&&"/emas "===t.content.substring(0,6)){var u=t.content.substring(6,t.content.length),c=u.match(/\w+|"[^"]+"/);if(null==c||!c.length)throw'Invalid. Try /as "Name of Character" <message>';u=u.substring(c[0].length,u.length);var l={who:'"'===c[0][0]?c[0].substring(1,c[0].length-1):c[0],type:"emote",playerid:window.currentPlayer.id,content:u};e(l)}else if(window.is_gm&&"/desc "===t.content.substring(0,6)){var u=t.content.substring(6,t.content.length),l={who:"",type:"desc",playerid:window.currentPlayer.id,content:u};e(l)}else if("/w "===t.content.substring(0,3)){var h=t.content.split(" "),m=h.slice(2,h.length),v=/\"([^"]+)\"/i,y=h[1],b=function(t,e){return t.split(" ")[0].toLowerCase()===e.toLowerCase()};if('"'===h[1].substring(0,1)){var w=v.exec(t.content);w&&(y=w[1],m=t.content.replace(v,function(){return""}).split(" ").slice(1,h.length),b=function(t,e){return t.toLowerCase()===e.toLowerCase()})}var x=0;if("gm"==y.toLowerCase()&&(x="gm",targetname="GM"),0==x&&d20.Campaign.players.each(function(t){b(t.get("displayname"),y)&&(x=t.id,targetname=t.get("displayname"))}),0==x&&d20.Campaign.characters.each(function(t){b(t.get("name"),y)&&(t.get("controlledby")&&""!=t.get("controlledby")?(x=t.get("controlledby"),targetname=t.get("name")):(x="gm",targetname="GM"))}),0==x){var s={who:"error",type:"error",content:"Unable to find a player or character with name: "+y};return void d20.textchat.incoming(!1,s)}var S=m.join(" "),l={who:d20.textchat.$speakingas.find("option:selected").text(),type:"whisper",target:x,target_name:targetname,playerid:window.currentPlayer.id,content:S,avatar:t.avatar};e(l)}else if("/say "==t.content.substring(0,5)){var E=t.content.replace("/say ",""),T=d20.textchat.$speakingas.val();if(t.content=E,e(l),-1===T.indexOf("character|"))return;{T.split("|")[1]}}else if("/fx "==t.content.substring(0,4)){var A=t.content.split(" "),C=!1,y=t.currentSelected,P=!1,R=A[1],L=R.indexOf("-")>-1?R.split("-")[0]:R;if(d20.fx.presetEffects[L])-1===d20.fx.presetEffects[L].angle&&(C=!0);else if(window.Campaign.custFx){var M=window.Campaign.custFx.filter(function(t){return t.get("name").toLowerCase()===L.toLowerCase()})[0];if(M){R=M.id;var k=window.Campaign.custFx.get(R).get("definition");-1===k.angle&&(C=!0)}}if(-1===R.indexOf("|")?R+="|duration:25":-1===R.indexOf("duration")&&(R+=",duration:25"),A.length>2){var x=A[2];y=d20.Campaign.activePage().thegraphics.get(x).view.graphic}if(A.length>3){var B=A[3];P=d20.Campaign.activePage().thegraphics.get(B).view.graphic}if(y){var I=y.left,O=y.top;if(C)if(P){var H={};H.distance=f(P.left-y.left,P.top-y.top),H.angle=d(P.left-y.left,P.top-y.top),d20.fx.spawnFx(I,O,R,H)}else d20.fx.agencyFx(function(t){d20.fx.spawnFx(I,O,R,t)},I,O);else d20.fx.spawnFx(I,O,R)}else{var s={who:"error",type:"error",content:"The /fx command requires a selected token or token ID, but none was provided. Select a token and try again."};d20.textchat.incoming(!1,s)}e("noop")}else if("/talktomyself on"===t.content.substring(0,16)||"/talktomyself"===t.content||"/talktomyself off"===t.content.substring(0,17)){if("/talktomyself on"===t.content.substring(0,16)||"/talktomyself"===t.content&&d20.textchat.talktomyself===!1){d20.textchat.talktomyself=!0;var s={who:"system",type:"system",content:"<strong>You are now talking to yourself.</strong> Chat messages and dice rolls will <strong>NOT BE BROADCAST</strong> to others until you turn this off. Use <code>/talktomyself off</code> to disable."};d20.textchat.incoming(!1,s),d20.utils.textchatNotify("Talking to Yourself",!0)}else if("/talktomyself off"===t.content.substring(0,17)||"/talktomyself"===t.content&&d20.textchat.talktomyself===!0){d20.textchat.talktomyself=!1;var s={who:"system",type:"system",content:"<strong>You are no longer talking to yourself.</strong> Hooray!"};d20.textchat.incoming(!1,s),d20.utils.textchatNotify(!1,!0)}}else{var s={who:"error",type:"error",content:"Unrecognized command: "+t.content};d20.textchat.incoming(!1,s)}},d=function(t,e){var n=180*Math.atan2(e,t)/Math.PI;return 0>n&&(n=360+n),n%180>90?n+=n%90>45?10-n%45/4.5:n%45/4.5:n-=n%90>45?10-n%45/4.5:n%45/4.5,n},f=function(t,e){return Math.sqrt(Math.pow(t,2)+Math.pow(e,2))},g=function(t,e,n){if(t&&"image"===t.type)d20.Campaign.parentRef.child("campaign").child("turnorder").transaction(function(r){d20.Campaign.set("turnorder",r);var i=d20.Campaign.initiativewindow.cleanList(),o=!1;return _.each(i,function(r){if(r.id===t.model.id)switch(o=!0,n){case"+":r.pr=parseFloat(r.pr)+e.total;break;case"-":r.pr=parseFloat(r.pr)-e.total;break;default:r.pr=e.total}}),o||i.push({id:t.model.id,pr:e.total,custom:""}),JSON.stringify(i)});else{var r={who:"error",type:"error",content:"You wanted to send the result of this roll to the turn tracker, but no valid token was selected!"};d20.textchat.incoming(!1,r)}};d20.textchat.rawChatInput=function(t){var n=_.extend({who:d20.textchat.$speakingas.find("option:selected").text(),type:"general",playerid:window.currentPlayer.id,content:""},t);if(d20.textchat.talktomyself)d20.textchat.incoming(!0,n);else{var r=e.push().key();e.child(r).setWithPriority(n,Firebase.ServerValue.TIMESTAMP)}};var m=function(t,e,n){return"bar1"==t.toLowerCase()?e.get("max"==n?"bar1_max":"bar1_value"):"bar2"==t.toLowerCase()?e.get("max"==n?"bar2_max":"bar2_value"):"bar3"==t.toLowerCase()?e.get("max"==n?"bar3_max":"bar3_value"):"token_name"==t.toLowerCase()?e.get("name"):"token_id"===t.toLowerCase()?e.id:void 0};d20.textchat.doChatInput=function(t){if(!e)return void console.log("No document!");if(t=d20.utils.strip_tags(t),""!=t){d20.textchat.commandhistory.push(t),d20.textchat.commandhistory=_.last(d20.textchat.commandhistory,20),d20.textchat.commandIndex=0;var n=d20.textchat.$speakingas.find("option:selected").val(),r=!1;if(-1!==n.indexOf("player"))r="/users/avatar/"+window.currentPlayer.get("d20userid")+"/30";else{var i=d20.Campaign.characters.get(n.split("|")[1]);i&&(r=i.get("avatar"))}var o={who:d20.textchat.$speakingas.find("option:selected").text(),type:"general",content:$.trim(t),playerid:window.currentPlayer.id,avatar:r},s=!1;"`"===o.content.substring(0,1)&&(s=!0,o.content=o.content.substring(1,o.content.length));var a=d20.engine.selected();a.length>0&&a[0].model&&(o.currentSelected=a[0]);var l={};d20.Campaign.players.each(function(t){t.macros.each(function(e){(t.id==window.currentPlayer.id||e.visibleToCurrentPlayer())&&(l["#"+e.get("name")]=e.get("action"))})});var u={},c={},p=d20.engine.mode+"",d=/(#[^ \n]+)/gm,f=/(%{[^}]+})/gm,v=/&{[^}]+}/,y=/(@{[^}]+})/gm,b="",w=0,x=function(){try{var t=!1,e=!1;if(o.content=o.content.replace(/&{noerror}/g,function(){return e=!0,""}),o.content=o.content.replace(f,function(n){var r,i,s,a,l,u,p;n=n.substring(2,n.length-1);var h=n.split("|");if(4==h.length&&(r=h[1],i=h[0],charname=h[2],l=h[3],s=d20.Campaign.characters.get(i),s&&(a=s.abilities.get(r),u=a.get("action"))),2==h.length&&(charname=h[0],l=h[1]),3==h.length&&(charname=h[0],l=h[2]),"repeating_"===l.substring(0,10)&&(!d20.journal.customSheets||void 0===d20.journal.customSheets.availableRolls[l.toLowerCase()])){console.log("SUBBING ABILITY REPEATING STUFF");var d=l.split("_");l="repeating_"+d[1]+"_"+d.slice(3).join("_"),p="repeating_"+d[1]+"_"+d[2]+"_"}if("selected"==charname.toLowerCase()){if(!o.currentSelected)throw"You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.";if(""===o.currentSelected.model.get("represents"))throw"You attempted to use a roll command looking for a selected token ability, but the selected token does not represent a Character, and therefore has no abilities.";s=d20.Campaign.characters.get(o.currentSelected.model.get("represents"))}else if("target"===charname.toLowerCase()){if(t||d20.engine.nextTargetCallback)return"%{"+n+"}";var f="target";if(h.length>2&&(f=h[1],l=h[2]),!l)throw"Syntax Error: You must specify a valid ability to fetch from the target.";return d20.engine.nextTargetCallback=function(t){return t===!1?(P(),void(d20.engine.nextTargetCallback=!1)):(o.content=o.content.replace(/%\${currentTarget\|[^}]+}/,function(r){var i=r.split("|")[1].replace("}","");if(""!==t.model.get("represents")){var o=d20.Campaign.characters.get(t.model.get("represents"));if(o){var s=void 0;return o.abilities.each(function(t){t.get("name").toLowerCase()==i.toLowerCase()&&(s="%{"+o.id+"|"+t.id+"|"+o.get("name")+"|"+t.get("name")+"}")}),void 0!==s?s:"%{"+o.get("name")+"|"+i+"}"}console.log("Couldn't find character that represents this token.")}if(!e){var a={who:"error",type:"error",content:"No ability was found for targeted token by the name of "+i};d20.textchat.incoming(!1,a)}return n}),d20.engine.nextTargetCallback=!1,c[f]=t,void x())},void 0!==c[f]?_.defer(function(){d20.engine.nextTargetCallback(c[f])}):(setMode("targeting"),$("#targetinginstructions .targetname").text(ucfirst(f))),t=!0,"%${currentTarget|"+l+"}"}if(s&&a||(s||d20.Campaign.characters.each(function(t){return t.get("name").toLowerCase()==charname.toLowerCase()||t.id===charname?(s=t,!1):void 0}),!a&&s&&s.abilities.each(function(t){return t.get("name").toLowerCase()==l.toLowerCase()||t.id===l?(a=t,u=a.get("action"),!1):void 0}),!a&&s&&d20.journal.customSheets&&d20.journal.customSheets.availableRolls&&void 0!==d20.journal.customSheets.availableRolls[l.toLowerCase()]&&(a=d20.journal.customSheets.availableRolls[l.toLowerCase()],u=a)),!(s&&a&&s.currentPlayerControls())){if(!e){var g={who:"error",type:"error",content:"No ability was found for %{"+charname+"|"+l+"}"};d20.textchat.incoming(!1,g)}return n}n=u;var m={};p&&s.attribs.each(function(t){t.get("name").substring(0,p.length)===p&&(m[t.get("name").substring(p.length,t.get("name").length)]=!0)});var v=/(@{[^}]+})/gm;return n=n.replace(v,function(t){var n=t.substring(2,t.length-1),r=n.split("|");if(r.length>1&&"max"!==r[1])return t;var i=void 0!==p?p.split("_")[1]:"";if("repeating_"===r[0].substring(0,10)&&-1!==r[0].indexOf("$")){var o=r[0].split("_");if(o.length>3&&void 0!==o[2]&&"$"===o[2].substring(0,1)){var a=parseInt(o[2].replace("$",""),10),l=[],u=o[0]+"_"+o[1];if(s.attribs.each(function(t){if(t.get("name").toLowerCase().substring(0,u.length)===u.toLowerCase()){var e=t.get("name").split("_");e.length>2&&void 0!==e[2]&&l.push(e[2])}}),l=_.uniq(l),l=s.repeatingKeyOrder(l,u),void 0!==l[a])o[2]=l[a],r[0]=o.join("_");else if(!e){var c={who:"error",type:"error",content:"You tried to use the repeating section row at index "+a+" for "+u+", but there doesn't seem to be a row at that index."};d20.textchat.incoming(!1,c)}}}return p&&void 0!==m[r[0]]?"@{"+s.get("name")+"|"+p+r[0]+(2==r.length?"|"+r[1]:"")+"}":p&&d20.journal.customSheets&&void 0!==d20.journal.customSheets.availableAttributes[("repeating_"+i+"_"+r[0]).toLowerCase()]&&void 0===d20.journal.customSheets.availableAttributes[r[0].toLowerCase()]?"@{"+s.get("name")+"|"+p+r[0]+(2==r.length?"|"+r[1]:"")+"}":"@{"+s.get("name")+"|"+r[0]+(2==r.length?"|"+r[1]:"")+"}"}),n=n.replace(/\(~[^\)]+\)/g,function(t){var e=t.split("|");if(e.length<2){var n=t.substring(2,t.length);if(p&&"repeating_"===n.substring(0,10)){var r=n.split("_");n=p+r.splice(2).join("_")}return"(~"+s.id+"|"+n}return t})}),o.content=o.content.replace(d,function(t){return void 0!==l[t]?l[t]:t}),o.content=o.content.replace(y,function(n){var r,i,s,a,l,u,p;n=n.substring(2,n.length-1);var h=n.split("|"),d="current",f=!1;if(4==h.length&&(r=h[1],i=h[0],l=h[2],u=h[3],s=d20.Campaign.characters.get(i),s&&(a=s.attribs.get(r))),!s)if(l=h[0],u=h[1],h.length>2&&("max"==(h[2]+"").toLowerCase()||"max"==(h[3]+"").toLowerCase())&&(d="max"),"selected"==l.toLowerCase()){if(!o.currentSelected)throw"You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.";var g=m(u,o.currentSelected.model,d);if(void 0!==g)return g;if(""!==o.currentSelected.model.get("represents")){if(s=d20.Campaign.characters.get(o.currentSelected.model.get("represents")),"character_name"===u.toLowerCase())return s.get("name");if("character_id"===u.toLowerCase())return s.id}}else{if("target"===l.toLowerCase()){if(t||d20.engine.nextTargetCallback)return"@{"+n+"}";var v=(d20.engine.mode+"","target");if(h.length>2&&(v=h[1],u=h[2]),!u)throw"Syntax Error: You must specify a valid attribute to fetch from the target.";return d20.engine.nextTargetCallback=function(t){return t===!1?(d20.engine.nextTargetCallback=!1,P(),void setTimeout(function(){if("targeting"!=d20.engine.mode)for(var t=0;t<origtoken.length;t++)d20.engine.select(origtoken[t])},500)):(o.content=o.content.replace(/@\${currentTarget\|[^}]+}/,function(n){var r=n.split("|")[1].replace("}",""),i=m(r,t.model,d);if(void 0!==i)return i;if(""!==t.model.get("represents")){var o=d20.Campaign.characters.get(t.model.get("represents"));if(o)return"character_name"===u.toLowerCase()?o.get("name"):"character_id"===u.toLowerCase()?o.id:"@{TARGET:"+v+"|"+r+("max"===d?"|max":"")+"}";console.log("Couldn't find character that represents this token.")}if(!e){var s={who:"error",type:"error",content:"No attribute was found for targeted token by the name of "+r};d20.textchat.incoming(!1,s)}return""}),d20.engine.nextTargetCallback=!1,c[v]=t,x(),void setTimeout(function(){if("targeting"!=d20.engine.mode)for(var t=0;t<origtoken.length;t++)d20.engine.select(origtoken[t])},500))},void 0!==c[v]?_.defer(function(){d20.engine.nextTargetCallback(c[v])}):("targeting"!=d20.engine.mode&&(origtoken=d20.engine.selected()),setMode("targeting"),$("#targetinginstructions .targetname").text(ucfirst(v))),t=!0,"@${currentTarget|"+u+"}"}if("tracker"===l.toLowerCase()){var y,b=d20.Campaign.initiativewindow.cleanList();if(_.each(b,function(t){if(t.custom.toLowerCase()===u.toLowerCase())return y=t.pr,!1;if(t.id){var e=d20.Campaign.activePage().thegraphics.get(t.id);if(e&&e.get("name").toLowerCase()===u.toLowerCase())return y=t.pr,!1}}),void 0!==y)return y;if(!e){var w={who:"error",type:"error",content:"No turn order item was found by the name "+u};d20.textchat.incoming(!1,w)}return""}}if("repeating_"===u.substring(0,10)){var S=u.split("_");p="repeating_"+S[1]+"_"+S[2]+"_"}if(!(s&&a||(!s&&"TARGET:"===l.substring(0,7)&&c[l.substring(7,l.length)]&&(s=d20.Campaign.characters.get(c[l.substring(7,l.length)].model.get("represents")),f=!0),s||d20.Campaign.characters.each(function(t){return t.get("name").toLowerCase()==l.toLowerCase()?(s=t,!1):void 0}),a||!s))){if("repeating_"===u.substring(0,10)&&-1!==u.indexOf("$")){var E=u.split("_");if(E.length>3&&void 0!==E[2]&&"$"===E[2].substring(0,1)){var T=parseInt(E[2].replace("$",""),10),A=[],C=E[0]+"_"+E[1];if(s.attribs.each(function(t){if(t.get("name").toLowerCase().substring(0,C.length)===C.toLowerCase()){var e=t.get("name").split("_");e.length>2&&void 0!==e[2]&&A.push(e[2])}}),A=_.uniq(A),A=s.repeatingKeyOrder(A,C),void 0!==A[T])E[2]=A[T],u=E.join("_");else if(!e){var w={who:"error",type:"error",content:"You tried to use the repeating section row at index "+T+" for "+C+", but there doesn't seem to be a row at that index."};d20.textchat.incoming(!1,w)}}}a=s.attribs.find(function(t){return t.get("name").toLowerCase()===u.toLowerCase()})}if(!s){var w={who:"error",type:"error",content:"No character was found for '"+l+"'"};return d20.textchat.incoming(!1,w),n}var R={};p&&s.attribs.each(function(t){t.get("name").substring(0,p.length)===p&&(R[t.get("name").substring(p.length,t.get("name").length)]=!0)});var L=function(t){var e=/(@{[^}]+})/gm;return t=(t+"").replace(e,function(t){var e=t.substring(2,t.length-1),n=e.split("|");if(n.length>1&&"max"!==n[1])return t;var r=void 0!==p?p.split("_")[1]:"";return p&&void 0!==R[n[0]]?"@{"+(f?l:s.get("name"))+"|"+p+n[0]+(2==n.length?"|"+n[1]:"")+"}":p&&d20.journal.customSheets&&void 0!==d20.journal.customSheets.availableAttributes[("repeating_"+r+"_"+n[0]).toLowerCase()]&&void 0===d20.journal.customSheets.availableAttributes[n[0].toLowerCase()]?"@{"+(f?l:s.get("name"))+"|"+p+n[0]+(2==n.length?"|"+n[1]:"")+"}":"@{"+(f?l:s.get("name"))+"|"+n[0]+(2==n.length?"|"+n[1]:"")+"}"}),t=t.replace(/\(~[^\)]+\)/g,function(t){var e=t.split("|");if(e.length<2){var n=t.substring(2,t.length);if(p&&"repeating_"===n.substring(0,10)){var r=n.split("_");
n=p+r.splice(2).join("_")}return"(~"+s.id+"|"+n}return t})};if("character_name"===u)return s.get("name");if("character_id"===u)return s.id;var M=void 0;if(a&&(s.currentPlayerControls()||f===!0)&&(M=a.get("max"==d?"max":"current")),void 0!==M&&""!==M)return L(M);var k=void 0,B=(u+("max"===d?"_max":"")).toLowerCase();if("repeating_"===B.substring(0,10)&&(!d20.journal.customSheets||void 0===d20.journal.customSheets.availableAttributes[B])){var I=B.split("_");isNaN(I[2])&&"-"!==I[2].substring(0,1)||(I.splice(2,1),B=I.join("_"))}if((s.currentPlayerControls()||f===!0)&&d20.journal.customSheets&&d20.journal.customSheets.availableAttributes&&void 0!==d20.journal.customSheets.availableAttributes[B]){var O=d20.journal.customSheets.availableAttributes[B];k=O}if(void 0!==M&&void 0===k)return L(M);if(void 0!==k)return L(k);if(!e){var w={who:"error",type:"error",content:"No attribute was found for @{"+l+"|"+u+"}"};d20.textchat.incoming(!1,w)}return n}),w++,t)return;void 0!==window.logRolls&&console.log(o.content),o.content==b||w>99?(console.log("Finished after going "+w+" levels deep."),C()):(b=o.content,x())}catch(n){var r={who:"error",type:"error",content:n+""};d20.textchat.incoming(!1,r)}},S=function(){var t=/{{[\s\S]*?}}/g;o.content=o.content.replace(t,function(t){return t.replace(/\n/g,"%NEWLINE%")});var n=o.content.split("\n"),r=[],i=0,a=function(){if(r&&!(i<r.length)){for(var t=0;t<r.length;t++)if("noop"!==r[t])if(r[t]._fbid){console.log("Found existing ID!");var n=r[t]._fbid;delete r[t]._fbid,d20.textchat.talktomyself?(r[t].id=n,r[t].timestamp=(new Date).getTime(),d20.textchat.incoming(!0,r[t])):e.child(n).setWithPriority(r[t],Firebase.ServerValue.TIMESTAMP)}else if(d20.textchat.talktomyself)r[t].id=e.push().key(),r[t].timestamp=(new Date).getTime(),d20.textchat.incoming(!0,r[t]);else{var o=e.push().key();e.child(o).setWithPriority(r[t],Firebase.ServerValue.TIMESTAMP)}P(),r=null}},l=0;_.each(n,function(t){r.push(!1);var e=_.clone(o);e.content=t,e.content=e.content.replace(/%NEWLINE%/g,"<br/>\n");var n,u=l+0,c=function(t){if("object"==typeof t&&(e.inlinerolls&&(t.inlinerolls=e.inlinerolls),n&&(t.rolltemplate=n),delete t.currentSelected,delete t.opts,"api"==t.type)){var o=d20.engine.selected();o&&o.length>0&&(t.selected=[],_.each(o,function(e){return void 0==e.model?!0:void t.selected.push({_type:"image"==e.model.get("type")?"graphic":e.model.get("type"),_id:e.model.id})}))}r[u]=t,i++,_.defer(function(){a()})},p=function(){console.log("Inline rolls complete!"),s||(e.content=e.content.replace(v,function(t){t=t.substring(2,t.length-1),e.opts||(e.opts={});for(var n=t.split(","),r=0;r<n.length;r++){var i=n[r].split(":");e.opts[i[0]]=i.length>1?i[1]:!0}return""})),e.opts&&void 0!==e.opts.template&&(n=e.opts.template),"//"===e.content.substring(0,2)?c("noop"):s||"/"!=e.content.substring(0,1)?(s||"!"!=e.content.substring(0,1)||(e.type="api"),c(e)):h(e,c)};s?p():(console.log("Begin processing op!"),E(e,p)),d20.textchat.diceengine.flushRemoteQueue(),l++})},E=function(t,e){var n=[],r=0,i=0,o=function(){r>i||(t.inlinerolls=n,e())},s=function(e,i){for(var o=[],s=[],l=!1,u=!1,c=0,p=!1;!p;){for(var h=0;h<e.length;h++)if("["===e[h])if("["===e[h-1]){if(c++,"$"===e[h-2]){l=!0;continue}o.push(h-1)}else"["===e[h+1]||(u=!0);else if("]"===e[h]){if(u){u=!1,s.push(h);continue}if("]"===e[h-1]&&-1===s.indexOf(h-1)){if(c--,l){l=!1;continue}var d=o.slice(-1)[0],f=e.substring(d,h+1);if(-1!==f.indexOf("$[[")){console.log("There's a nested inline roll in here. Ignore for now");continue}if(function(){var o=r+0,s=c+0;r++,e=e.substring(0,d)+"$[["+o+"]]"+e.substring(h+1,e.length),t.content=e,a(f,o,function(){console.log("Finished "+o),console.log("Levels deep: "+s),s>0&&(console.log("Substituting for "+o),t.content=t.content.replace("$[["+o+"]]",n[o].results.total)),i()})}(),console.log("Levels deep: "+c),c>0)return void d20.textchat.diceengine.flushRemoteQueue();break}}p=!0}i(e)},a=function(e,r,o){e=$.trim(e.substring(2,e.length-2));var s={};e=e.replace(v,function(t){t=t.substring(2,t.length-1);for(var e=t.split(","),n=0;n<e.length;n++){var r=e[n].split(":");s[r[0]]=r.length>1?r[1]:!0}return""}),d20.textchat.diceengine.process(e,function(a,l,u,c){if(d20.textchat.globalrolled++,a.rolls&&a.rolls.length>0)try{_.each(a.rolls,function(t){if(t.table){d20.utils.stattracker.rolltables||(d20.utils.stattracker.rolltables=!0);var e=d20.Campaign.rollabletables.findTableByName(t.table),n=e.getWeightedArray();e&&_.each(t.results,function(t){t.tableItem=e.tableitems.get(n[t.tableidx]).toJSON()})}})}catch(p){console.log("ERROR matching table"),console.log(p)}n[r]={expression:e,results:a,signature:u,rollid:l},c&&(n[r].tdseed=c),s.tracker&&g(t.currentSelected,a,s.tracker),i++,o()})},l="",u=function(){l!==t.content?(l=t.content,s(t.content+"",u)):o()};s(t.content+"",u)},T=/(\?{[^}]+})/m,A=0,C=function(){var t=!1;o.content=o.content.replace(T,function(e){if(A>99)return e;t=!0,A++,e=$.trim(e.substring(2,e.length-1));var n=e.split("|");if(e=n[0],console.log(n.length),void 0!==u[e])return _.defer(function(){C()}),u[e];if(n.length<=2)var r=$("<div><p style='font-size: 1.15em;'><strong>"+d20.utils.strip_tags(e)+":</strong> <input type='text' style='width: 75px; margin-left: 5px;'></p></div>");else{options=[],n.each(function(t){opt=t.split(","),optlabel=opt[0],optvalue=opt[1]?opt[1]:opt[0],optvalue=optvalue.replace(/'/g,"&#39"),opt!=e&&options.push("<option value='"+d20.utils.strip_tags(optvalue)+"'>"+d20.utils.strip_tags(optlabel)+"</option>")});var r=$("<div><p style='font-size: 1.15em;'><strong>"+d20.utils.strip_tags(e)+":</strong> <select style='width: 150px; margin-left: 5px;'>"+options.join("")+"</select></p></div>")}return r.dialog({title:"Input Value",beforeClose:function(){return!1},buttons:{Submit:function(){n.length<3?(u[e]=r.find("input").val(),o.content=o.content.replace("?${1}",r.find("input").val())):(u[e]=r.find("select").val(),o.content=o.content.replace("?${1}",r.find("select").val())),r.off(),r.dialog("destroy").remove(),C(),d20.textchat.$textarea.focus()},Cancel:function(){r.off(),r.dialog("destroy").remove(),P()}}}),r.on("keydown","input, select",function(t){13==t.which&&(n.length<3?(u[e]=r.find("input").val(),o.content=o.content.replace("?${1}",r.find("input").val())):(u[e]=r.find("select").val(),o.content=o.content.replace("?${1}",r.find("select").val())),r.off(),r.dialog("destroy").remove(),C(),t.stopPropagation(),t.preventDefault(),d20.textchat.$textarea.focus())}),_.defer(function(){n.length<=2?(2===n.length&&r.find("input").val(n[1]).select(),r.find("input").focus()):r.find("select").focus()}),"?${1}"}),t||S()},P=function(){x=null,E=null,S=null,C=null,inlinerolls=null,o=null,b=null,u=null,c=null,d20.engine.mode!==p&&setMode(p),p=null};s?S():x()}},$("#textchat-input").on("click","button",function(){var t=$.trim(d20.textchat.$textarea.val());d20.textchat.doChatInput(t),d20.textchat.$textarea.val("").focus()});var v=!1,y=function(t){var e=(new Date).getTime();v&&3e3>e-v||d20.textchat.talktomyself||(v=e,d20.textchat.sendShout({type:"istyping",playerid:window.currentPlayer.id,content:t,time:(new Date).getTime()}))};d20.textchat.$textarea.bind("keyup",function(){var t=$(this).val();if(t.length>1&&"#"!=t.substring(0,1)){var e=!1;if("/as "===t.substring(0,4)||"/emas "===t.substring(0,6)){t=t.replace("/as ","").replace("/emas ","");var n=t.match(/ /g);if(null==n||n.length<2)return;var r=t.match(/"/g);if('"'===t[0]&&null!==r&&r.length<2)return;var i=t.match(/\w+|"[^"]+"/);null!=i&&i.length&&i.length>0&&(e='"'===i[0][0]?i[0].substring(1,i[0].length-1):i[0])}else"/ooc "===t.substring(0,5)||"/o "===t.substring(0,3)||"/desc "===t.substring(0,6)||"/em "===t.substring(0,4)||"/me "===t.substring(0,4)||"/e "===t.substring(0,3)?e=d20.textchat.$speakingas.find("option:first-child").text():"/"!==t.substring(0,1)&&(e=d20.textchat.$speakingas.find("option:selected").text());e&&y(e)}}),d20.textchat.$textarea.bind("keydown",function(t){if(13===t.which){if(a)return!1;if(t.shiftKey===!0)return;$(this).parent().find("button").trigger("click"),t.preventDefault()}}),d20.textchat.$textarea.bind("keyup","up",function(){var t=d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex];(""==$(this).val()||$(this).val()==t)&&(Math.abs(d20.textchat.commandIndex)<d20.textchat.commandhistory.length+1&&(d20.textchat.commandIndex=d20.textchat.commandIndex-1),$(this).val(d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex]))}),d20.textchat.$textarea.bind("keyup","down",function(){var t=d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex];(""==$(this).val()||$(this).val()==t)&&(d20.textchat.commandIndex<0&&(d20.textchat.commandIndex=d20.textchat.commandIndex+1),$(this).val(d20.textchat.commandhistory[d20.textchat.commandhistory.length+d20.textchat.commandIndex]))});var b=function(t,e){return t.substring(0,e.selectionStart).match(/[\w\xe4\xf6\xfc\xc4\xd6\xdc\xdf#%{]+$/)},w=function(t,e){if(t.setSelectionRange)t.setSelectionRange(e,e);else if(t.createTextRange){var n=t.createTextRange();n.collapse(!0),n.moveEnd("character",e),n.moveStart("character",e),n.select()}};d20.textchat.$textarea.autocomplete({delay:100,autoFocus:!0,position:{my:"left top",at:"left bottom"},source:function(t,e){var n=b(t.term,d20.textchat.$textarea[0]);if(n=null!=n?n[0]:"","%"===n[0]&&"{"!==n[1]&&(n="%{"+n.substring(1,n.length)),"#"==n.substring(0,1)){var r=[];d20.Campaign.players.each(function(t){t.macros.each(function(e){return""==e.get("name")?!0:void((t.id==window.currentPlayer.id||e.visibleToCurrentPlayer())&&r.push("#"+e.get("name")))})});var i=$.ui.autocomplete.filter(r,n);e(i)}else if("/w "==t.term.substring(0,3)&&t.term.split(" ").length<3){var i=$.ui.autocomplete.filter(_.union(["gm"],d20.Campaign.players.map(function(t){return t.get("displayname").split(" ")[0]}),d20.Campaign.characters.map(function(t){var e=t.get("inplayerjournals").split(",");return window.is_gm||-1!==_.indexOf(e,"all")||window.currentPlayer&&-1!==_.indexOf(e,window.currentPlayer.id)?t.get("name").split(" ")[0]:!1})),n);e(i)}else if("%{"===n.substring(0,2)){var r=[];d20.Campaign.characters.each(function(t){t.currentPlayerControls()&&t.abilities.each(function(e){-1!==e.get("name").toLowerCase().indexOf(n.substring(2,n.lenght).toLowerCase())&&r.push("%{"+t.get("name")+"|"+e.get("name")+"}")})}),e(r)}else e([])},focus:function(){return!1},select:function(t,e){e.item.value+=" ";var n=b(this.value,this)[0],r=this.value.substring(0,this.selectionStart-n.length);this.value=r+e.item.value+this.value.substring(this.selectionStart,this.value.length);var i=r.length+e.item.value.length;return w(this,i),t.preventDefault(),!1},search:function(){var t=b(this.value,this);return null!=t},open:function(){a=!0},close:function(){setTimeout(function(){a=!1},250)}});var x=$("#textchat .content");d20.textchat.incoming=function(e,n,a,l){var c=n.type;if("api"!==n.type){if(d20.tutorial&&d20.tutorial.active&&$(document).trigger("receivedChat",n),null===n.timestamp)n.timestamp="";else{var p=n.timestamp,h=Date.create(p),d=(new Date).getTime();n.timestamp=h.format(864e5>d-p?"{h}:{mm}{TT}":"{{Month}} {{dd}}, {{yyyy}} {h}:{mm}{TT}")}if(d20.Campaign&&n.playerid!=window.currentPlayer.id&&(delete u[n.playerid],d20.textchat.updateWhoIsTyping()),"gmrollresult"==n.type){if(!window.is_gm&&n.playerid!=window.currentPlayer.id)return void console.log("ignoring message, not gm, and not original player.");c="rollresult"}if("whisper"==n.type)if(n.playerid==window.currentPlayer.id)c="whispersent";else{if(c="whisperreceived","gm"==n.target){if(!window.is_gm)return}else if(-1===n.target.indexOf(window.currentPlayer.id))return;t=n}if(d20.Campaign){var f=x.height(),g=$(window).height(),m=d20.textchat.$textchat.scrollTop(),v=!1;g>f-m-200&&(v=!0)}if("rollresult"==c&&n.origRoll){c="newroll";try{var y=JSON.parse(n.content);n.signature&&(d20.textchat.verifyRoll(n.id,y,n.signature)?n.passedSignature=!0:n.failedSignature=!0),n.htmlcontent=d20.dice_formatter.getHtmlForResult(y),n.sanitizedOrigRoll=d20.dice_formatter.replaceInlineRolls(n.origRoll.replace("<","&lt;"),n,"")}catch(b){return}}else"rollresult"==c&&"object"==typeof n.content&&(n.content=n.content.origformula+"|"+n.content.formula+"|"+n.content.total);var w;if(w=$("#tmpl_chatmessage_"+c),l){var S=x.find(".message[data-messageid="+n.id+"]");n.showname=S.find(".avatar").length>0?!0:!1}else(n.who!==r||i>5)&&(n.showname=!0,i=0);if(n.rolltemplate||"rollresult"==c||"newroll"==c||"tokenroll"==c||"direct"==c||(n.content=Markdown.parse(n.content+"").autoLink()),n.rolltemplate){for(var E,T={},A=/{{([\s\S]*?}?)}}/gi;null!=(E=A.exec(n.content));){E.index===A.lastIndex&&A.lastIndex++;var C=E[1]+"",P=C.split("=");T[P[0]]=C.substring(P[0].length+1,C.length)}$.each(T,function(t,e){T[t]=e.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,'<span style="color: red;">['+e+"]</span>")});var n=t.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,"["+e+"]")});n!==t&&(T[n]=T[t],delete T[t])}),T["rollWasCrit()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(s){console.log("Error while checking for crit in roll...")}return null}},T["^rollWasCrit()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&!d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(s){console.log("Error while checking for crit in roll...")}return null}},T["rollWasFumble()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(s){console.log("Error while checking for fumble in roll...")}return null}},T["^rollWasFumble()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==T[i]&&"string"==typeof T[i]){var o=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&!d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(s){console.log("Error while checking for fumble in roll...")}return null}},T["rollTotal()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total===parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollTotal()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total!==parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollGreater()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total>parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollGreater()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total<=parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollLess()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total<parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["^rollLess()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,void 0!==T[i]&&"string"==typeof T[i]){var s=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[s]&&n.inlinerolls[s].results.total>=parseInt(lookingForTotal,10))return e(t)}}catch(a){console.log("Error while checking for roll total...")}return null}},T["rollBetween()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1],s=r[2];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,lookingForTotal2=void 0!==s&&isNaN(s)?n.inlinerolls[T[s].split("$[[")[1].split("]]")[0]].results.total:s,void 0!==T[i]&&"string"==typeof T[i]){var a=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[a]&&n.inlinerolls[a].results.total>=parseInt(lookingForTotal,10)&&n.inlinerolls[a].results.total<=parseInt(lookingForTotal2,10))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},T["^rollBetween()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1],s=r[2];if(lookingForTotal=void 0!==o&&isNaN(o)?n.inlinerolls[T[o].split("$[[")[1].split("]]")[0]].results.total:o,lookingForTotal2=void 0!==s&&isNaN(s)?n.inlinerolls[T[s].split("$[[")[1].split("]]")[0]].results.total:s,void 0!==T[i]&&"string"==typeof T[i]){var a=T[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[a]&&(n.inlinerolls[a].results.total<parseInt(lookingForTotal,10)||n.inlinerolls[a].results.total>parseInt(lookingForTotal2,10)))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},T["allprops()"]=function(){return function(t,e,n){try{var r="";for(var i in T)"name"!==i&&-1===n.indexOf(i)&&"function"!=typeof T[i]&&(r+=e(t.replace("{{key}}",ucfirst(i)).replace("{{value}}",T[i])));return r}catch(o){console.log("Error enumerating all properties")}return null}};var R="";if(d20.journal&&d20.journal.customSheets&&d20.journal.customSheets.rollTemplates[n.rolltemplate])R="<div class='sheet-rolltemplate-"+n.rolltemplate+"'>"+d20.journal.customSheets.rollTemplates[n.rolltemplate]+"</div>";else{var L=$("#sheet-rolltemplate-"+n.rolltemplate);0===L.length?console.error("Didn't find a roll template called '"+n.rolltemplate+"'"):R="<div class='"+L.attr("id")+"'>"+L.html()+"</div>"}n.content=Mustache.render(R,T),n.content=Markdown.parse(n.content),n.content=d20.utils.htmlTranslator(n.content,!0)}var M=w.jqote(n),k=":last-child";if(l?(S.replaceWith(M),k="[data-messageid="+n.id+"]"):x.append(M),("rollresult"==n.type||"gmrollresult"==n.type)&&d20.Campaign&&window.currentPlayer&&window.currentPlayer.get("diceiconsenabled")){x.find(".message"+k+" .rolled").draggable({revert:!0,distance:10,revertDuration:0,helper:"clone",appendTo:"body",scroll:!1}).addTouch();var B=x.find(".message"+k+" .formattedformula > .dicegrouping");B.find(".diceroll").length<20&&B.sortable({appendTo:document.body,helper:"clone",distance:10,items:"> .diceroll",update:function(t){d20.textchat.updateDiceOrdering(n,t)}}).addTouch(),B=null}if(d20.Campaign&&window.currentPlayer&&"newroll"==c&&n.playerid==window.currentPlayer.id)try{var I=$("#mylastrolls tbody tr").eq(0);(0==I.length||$.trim(I.find("td.formula").text())!=n.origRoll)&&($("#mylastrolls tbody").prepend($("#tmpl_recentroll").jqote(n)),$("#mylastrolls tbody tr").eq(10).remove())}catch(b){}if(!a&&x.find(".message").length>100&&x.find(".message").eq(0).remove(),l||(r="emote"==n.type||"gmrollresult"==n.type||"whisper"==n.type?"":n.who,i++),d20.Campaign&&(v||e===!1)){var O=x.height();d20.textchat.$textchat.scrollTop(O)}if(d20.Campaign&&$("#chatbeepenabled").is(":checked")&&(!o&&!s||!d20.textchat.tabIsFocused&&!d20.textchat.childWindow)&&0!=e&&!d20.textchat.chatstartingup){if((new Date).getTime()-d20.textchat.lastChatBeep>1e3){var H=new Audio;H.src="/images/sounds/beep."+(H.canPlayType("audio/ogg")?"ogg":"mp3"),H.play(),d20.textchat.lastChatBeep=(new Date).getTime()}d20.textchat.tabIsFocused||$("#textchattab").addClass("alertify")}if(-1!==document.body.className.indexOf("sidebarhidden")&&$("#sidebarcontrol").addClass("alertify"),!d20.textchat.chatstartingup){var F;void 0!==n.tdseed?F=n.id:void 0!==n.inlinerolls&&n.inlinerolls.length>0&&_.each(n.inlinerolls,function(t){return void 0!==t.tdseed?(F=t.rollid,!1):void 0}),F&&(x.find(".message[data-messageid="+n.id+"]").addClass("hidden3d"),d20.tddice.handleIncomingChatWith3DRoll(F,1),setTimeout(function(){d20.textchat.showHidden3DRolls()},d20.tddice.canRoll3D()?3e3:2e3),d20.textchat.allowed3drolls.push(F))}}},d20.textchat.showHidden3DRolls=function(){var t=!1;if(d20.Campaign){var e=x.height(),n=$(window).height(),r=d20.textchat.$textchat.scrollTop();n>e-r-200&&(t=!0)}if(x.find(".message.hidden3d").removeClass("hidden3d"),t){var i=x.height();d20.textchat.$textchat.scrollTop(i)}},d20.textchat.verifyRoll=function(t,e,n){var r=window.campaign_storage_path+"//"+t+"//"+e.total,i=c.subjectPublicKeyRSA.verifyString(r,n);return i},d20.textchat.updateDiceOrdering=function(t,n){var r=$(n.target),i=parseInt(r.attr("data-groupindex"),10),o=JSON.parse(t.content),s=[];r.find(".diceroll").each(function(){var t=parseInt($(this).attr("data-origindex"),10);return o.rolls[i]&&o.rolls[i].results[t]?void s.push(o.rolls[i].results[t]):void console.log("ERROR: Unable to find group "+i+" or result "+t)}),o.rolls[i].results=s,e.child(t.id).child("content").set(JSON.stringify(o))},d20.textchat.updateWhoIsTyping=function(){var t=x.height(),e=$(window).height(),n=d20.textchat.$textchat.scrollTop(),r=!1;e-150>t-n&&(r=!0);var i=_.values(u);if(0==i.length)$("#whoistyping").hide();else{var o="are";1==i.length&&(o="is"),$("#whoistyping .names").text(i.join(", ").replace(/,$/," and")+" "+o+" typing..."),$("#whoistyping").show()}if(r){var s=x.height();d20.textchat.$textchat.scrollTop(s)}};var S=function(t){if("istyping"==t.type){if(t.playerid==window.currentPlayer.id)return;l[t.playerid]&&clearTimeout(l[t.playerid]),u[t.playerid]=t.content,l[t.playerid]=setTimeout(function(){l[t.playerid]=!1,delete u[t.playerid],d20.textchat.updateWhoIsTyping()},5e3),d20.textchat.updateWhoIsTyping()}else if("shdw_update"==t.type||"shdw_kill"==t.type)d20.engine.handleShadows(t);else if("steal_request"==t.type)d20.decks.steal_request(t);else if("steal_response"==t.type)d20.decks.steal_response(t);else if("measuring"==t.type)d20.engine.receiveMeasureUpdate(t);else if("endmeasurement"==t.type)d20.engine.receiveEndMeasure(t);else if("mapping"==t.type)d20.engine.receiveMapping(t);else if("showhandout"==t.type)d20.journal.showHandoutFromShout(t);else if("showcharacter"==t.type)d20.journal.showCharacterFromShout(t);else if("showobject"==t.type){if(!t.id)return;d20.engine.zoomObject(t.id)}else if("3droll"==t.type)d20.tddice&&t.playerid!==window.currentPlayer.id&&d20.tddice.remoteRoll(t);else if("fx_start"==t.type||"fx_update"==t.type||"fx_kill"==t.type){if(t.playerid===window.currentPlayer.id)return;d20.fx.handleShout(t)}else"settingschanged"==t.type?(new Date).getTime()-t.time<5e3&&window.location.reload():"playclickhole"==t.type&&t.content.length>2&&(window.fakeLightly&&window.fakeLightly("http://v.theonion.com/onionstudios/video/"+t.content[0]+"/640.mp4"),setTimeout(function(){$("#lightly-overlay").hide()},1e3*t.content[2]+2e3))};d20.textchat.startup=function(){var t=new Firebase(window.FIREBASE_ROOT+window.campaign_storage_path+"/");n=t.child("shout"),e=t.child("chat"),textchatpopped=!1;var r,i=!1;d20.textchat.sendShout=function(t){!i||"istyping"!==t.type&&"measuring"!==t.type&&"endmeasurement"!==t.type&&"fx_start"!==t.type&&"fx_update"!==t.type&&"fx_kill"!==t.type?d20.tutorial&&d20.tutorial.active?S(t):d20.textchat.shoutref.set(JSON.stringify(t)):r.send(JSON.stringify({t:"msg",content:t}))},d20.textchat.shoutref=n,d20.textchat.chatstartingup=!0,n.on("value",function(t){if(!d20.textchat.chatstartingup){var e=t.val();e&&S(JSON.parse(e))}});var o=[],s=function(){for(var t=0;t<o.length;t++)d20.textchat.incoming(!d20.textchat.chatstartingup,o[t]);o=null,window.is_gm&&(window.is_offsite&&!window.is_playerapp?d20.textchat.incoming(!1,{who:"system",type:"system",content:"Invite other users to join this Google+ Hangout and they'll join your Roll20 game."}):$.get("/campaigns/sharelink/"+window.campaign_id,function(t){d20.textchat.incoming(!1,{who:"system",type:"system",content:"The player link for this campaign is: <div class='sharelink'><a href='"+t+"'>"+t+"</a></div> <div style='font-size: 0.9em;'>(Hover over with your mouse pointer to show)</div>"})})),d20.textchat.incoming(!1,{who:"system",type:"system",content:$("#tmpl_welcome_message").jqote()}),d20.textchat.chatstartingup=!1},a=_.debounce(s,1e3),l=e.limitToLast(100),u=[],c=!1,p=0,h=function(t){var e=t.val();e.timestamp=t.getPriority(),e.id=t.key(),-1===u.indexOf(e.id)?(u.push(e.id),c=e.id,p=(new Date).getTime(),d20.textchat.chatstartingup?(o.push(e),a()):d20.textchat.incoming(!d20.textchat.chatstartingup,e)):!d20.textchat.chatstartingup&&(c!==e.id||(new Date).getTime()-p>500)&&d20.textchat.incoming(!0,e,!0,!0)};l.on("child_added",function(t){h(t)}),l.on("child_changed",function(t){h(t)}),l.once("value",function(){a()})};var E;d20.textchat.opendialog=function(){E=$("#textchat").css("height"),$("#textchat").dialog({title:"Text Chat",beforeClose:function(){$(this).dialog("destroy"),$(this).appendTo("#rightsidebar"),$(this).css("height",E).css("width","auto"),$(this).show()}})},d20.textchat.showPopout=function(){if(textchatpopped!==!0){var t=$("#textchat"),e=$("#textchat-input"),n=t.parent();d20.textchat.childWindow=window.open("/editor/popoutchat","ChatPopout","menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width=300,height=800"),window.allChildWindows.push(d20.textchat.childWindow),d20.textchat.childWindow.onload=function(){textchatpopped=!0,d20.journal.customSheets&&d20.journal.customSheets.styleel&&(console.log("Setting style element in child window."),$(d20.journal.customSheets.styleel).clone().appendTo(d20.textchat.childWindow.document.head)),t.appendTo(d20.textchat.childWindow.document.getElementById("containerdiv")),e.appendTo(d20.textchat.childWindow.document.body),d20.textchat.$textarea.autocomplete("widget").appendTo(d20.textchat.childWindow.document.body),d20.textchat.childWindow.document.title="Roll20 Chat",t.scrollTop(t[0].scrollHeight),$("#rightsidebar").find("ul.tabmenu li").eq(1).find("a").trigger("click");var n=function(){return $(this).hasClass("tipsy-w")?"w":$(this).hasClass("tipsy-e")?"e":$(this).hasClass("tipsy-n")?"n":$(this).hasClass("tipsy-s")?"s":$(this).hasClass("tipsy-side")?$(this).offset().left>$(document).scrollLeft()+$(window).width()/2?"e":"w":$(this).offset().top<$(document).scrollTop()+$(window).height()/2?"n":"s"};$(d20.textchat.childWindow.document.body).find(".showtip").tipsy({live:!0,gravity:n,opacity:.5,html:!0,containerel:$(d20.textchat.childWindow.document.body)}),$(d20.textchat.childWindow.document.body).find(".userscript-showtip").tipsy({live:!0,gravity:n,opacity:1,html:!0,filterhtml:!0,userscript:!0,containerel:$(d20.textchat.childWindow.document.body)}),s=!0,$(d20.textchat.childWindow.document).on("click","a",d20.utils.handleURL)},d20.textchat.childWindow.onbeforeunload=function(){textchatpopped=!1,setTimeout(function(){$("#rightsidebar").find("a[href=#textchat]").trigger("click")},100),t.appendTo(n),e.appendTo($("body")),d20.textchat.$textarea.autocomplete("widget").appendTo($("body")),t.scrollTop(t[0].scrollHeight),window.allChildWindows=_.without(window.allChildWindows,d20.textchat.childWindow),s=!1,d20.textchat.childWindow=null},$(d20.textchat.childWindow).bind("focus",function(){s=!0}),$(d20.textchat.childWindow).bind("blur",function(){s=!1})}},$("#textchattab").on("dblclick",function(){d20.textchat.showPopout()}),$("#rightsidebar").resizable({handles:"w",alsoResize:"#textchat-input, #rightsidebar .tabmenu",minWidth:300,start:function(){$("#editor-wrapper, #canvas-overlay").addClass("noshow")},resize:function(){},stop:function(){$("#editor-wrapper, #canvas-overlay").removeClass("noshow"),$(window).trigger("resize"),$("#rightsidebar").css("left","").css("height","100%")}})}),function(t,e){"object"==typeof exports&&exports?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Mustache={})}(this,function(t){function e(t){return"function"==typeof t}function n(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function r(t,e){return f.call(t,e)}function i(t){return!r(g,t)}function o(t){return String(t).replace(/[&<>"'\/]/g,function(t){return m[t]})}function s(e,r){function o(){if(_&&!S)for(;m.length;)delete g[m.pop()];else m=[];_=!1,S=!1}function s(t){if("string"==typeof t&&(t=t.split(y,2)),!d(t)||2!==t.length)throw new Error("Invalid tags: "+t);c=new RegExp(n(t[0])+"\\s*"),p=new RegExp("\\s*"+n(t[1])),h=new RegExp("\\s*"+n("}"+t[1]))}if(!e)return[];var c,p,h,f=[],g=[],m=[],_=!1,S=!1;s(r||t.tags);for(var E,T,A,C,P,R,L=new u(e);!L.eos();){if(E=L.pos,A=L.scanUntil(c))for(var M=0,k=A.length;k>M;++M)C=A.charAt(M),i(C)?m.push(g.length):S=!0,g.push(["text",C,E,E+1]),E+=1,"\n"===C&&o();if(!L.scan(c))break;if(_=!0,T=L.scan(x)||"name",L.scan(v),"="===T?(A=L.scanUntil(b),L.scan(b),L.scanUntil(p)):"{"===T?(A=L.scanUntil(h),L.scan(w),L.scanUntil(p),T="&"):A=L.scanUntil(p),!L.scan(p))throw new Error("Unclosed tag at "+L.pos);if(P=[T,A,E,L.pos],g.push(P),"#"===T||"^"===T)f.push(P);else if("/"===T){if(R=f.pop(),!R)throw new Error('Unopened section "'+A+'" at '+E);if(R[1]!==A)throw new Error('Unclosed section "'+R[1]+'" at '+E)}else"name"===T||"{"===T||"&"===T?S=!0:"="===T&&s(A)}if(R=f.pop())throw new Error('Unclosed section "'+R[1]+'" at '+L.pos);return l(a(g))}function a(t){for(var e,n,r=[],i=0,o=t.length;o>i;++i)e=t[i],e&&("text"===e[0]&&n&&"text"===n[0]?(n[1]+=e[1],n[3]=e[3]):(r.push(e),n=e));return r}function l(t){for(var e,n,r=[],i=r,o=[],s=0,a=t.length;a>s;++s)switch(e=t[s],e[0]){case"#":case"^":i.push(e),o.push(e),i=e[4]=[];break;case"/":n=o.pop(),n[5]=e[2],i=o.length>0?o[o.length-1][4]:r;break;default:i.push(e)}return r}function u(t){this.string=t,this.tail=t,this.pos=0}function c(t,e){this.view=null==t?{}:t,this.cache={".":this.view},this.parent=e}function p(){this.cache={}}var h=Object.prototype.toString,d=Array.isArray||function(t){return"[object Array]"===h.call(t)},f=RegExp.prototype.test,g=/\S/,m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},v=/\s*/,y=/\s+/,b=/\s*=/,w=/\s*\}/,x=/#|\^|\/|>|\{|&|=|!/;u.prototype.eos=function(){return""===this.tail},u.prototype.scan=function(t){var e=this.tail.match(t);if(!e||0!==e.index)return"";var n=e[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},u.prototype.scanUntil=function(t){var e,n=this.tail.search(t);switch(n){case-1:e=this.tail,this.tail="";break;case 0:e="";break;default:e=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=e.length,e},c.prototype.push=function(t){return new c(t,this)},c.prototype.lookup=function(t){var n,r=this.cache;if(t in r)n=r[t];else{for(var i,o,s=this;s;){if(t.indexOf(".")>0)for(n=s.view,i=t.split("."),o=0;null!=n&&o<i.length;)n=n[i[o++]];else"object"==typeof s.view&&(n=s.view[t]);if(null!=n)break;s=s.parent}r[t]=n}return e(n)&&(n=n.call(this.view)),n},p.prototype.clearCache=function(){this.cache={}},p.prototype.parse=function(t,e){var n=this.cache,r=n[t];return null==r&&(r=n[t]=s(t,e)),r},p.prototype.render=function(t,e,n){var r=this.parse(t),i=e instanceof c?e:new c(e);return this.renderTokens(r,i,n,t)},p.prototype.renderTokens=function(t,n,r,i){function o(t){return u.render(t,n,r)}for(var s,a,l="",u=this,c=0,p=t.length;p>c;++c)switch(s=t[c],s[0]){case"#":var h=(s[1]+"").split(" ");if("()"===h[0].substring(h[0].length-2,h[0].length)?(a=n.lookup(h[0]),h.splice(0,1)):a=n.lookup(s[1]),!a)continue;if(d(a))for(var f=0,g=a.length;g>f;++f)l+=this.renderTokens(s[4],n.push(a[f]),r,i);else if("object"==typeof a||"string"==typeof a)l+=this.renderTokens(s[4],n.push(a),r,i);else if(e(a)){if("string"!=typeof i)throw new Error("Cannot use higher-order sections without the original template");a=a.call(n.view,i.slice(s[3],s[5]),o,h),null!=a&&(l+=a)}else l+=this.renderTokens(s[4],n,r,i);break;case"^":a=n.lookup(s[1]),(!a||d(a)&&0===a.length)&&(l+=this.renderTokens(s[4],n,r,i));
break;case">":if(!r)continue;a=e(r)?r(s[1]):r[s[1]],null!=a&&(l+=this.renderTokens(this.parse(a),n,r,a));break;case"&":a=n.lookup(s[1]),null!=a&&(l+=a);break;case"name":a=n.lookup(s[1]),null!=a&&(l+=a);break;case"text":l+=s[1]}return l},t.name="mustache.js",t.version="1.0.0",t.tags=["{{","}}"];var _=new p;t.clearCache=function(){return _.clearCache()},t.parse=function(t,e){return _.parse(t,e)},t.render=function(t,e,n){return _.render(t,e,n)},t.to_html=function(n,r,i,o){var s=t.render(n,r,i);return e(o)?void o(s):s},t.escape=o,t.Scanner=u,t.Context=c,t.Writer=p}),function(){window.Markdown={parse:function(t){{var e=t,n=[],r=[];-1!=e.indexOf("\r\n")?"\r\n":-1!=e.indexOf("\n")?"\n":""}return e=e.replace(/{{{([\s\S]*?)}}}/g,function(t){return n.push(t.substring(3,t.length-3)),"{{{}}}"}),e=e.replace(new RegExp("<pre>([\\s\\S]*?)</pre>","gi"),function(t){return r.push(t.substring(5,t.length-6)),"<pre></pre>"}),e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/``(.*?)``/g,"<code>$1</code>"),e=e.replace(/\[([^\]]+)\]\(([^)]+(\.png|\.gif|\.jpg|\.jpeg))\)/g,'<a href="$2"><img src="$2" alt="$1" /></a>'),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>'),e=e.replace(new RegExp("<pre></pre>","g"),function(){return"<pre>"+r.shift()+"</pre>"}),e=e.replace(/{{{}}}/g,function(){return n.shift()})}}}(),function(){function t(t){return function(){return t}}function e(t){var e="Array"===t&&on.isArray||function(e,n){return(n||hn.call(e))==="[object "+t+"]"};return vn[t]=e}function n(t,e){function n(n){return g(n)?hn.call(n)==="[object "+e+"]":typeof n===t}return vn[e]=n}function r(t){t.SugarMethods||(l(t,"SugarMethods",{}),i(t,!1,!0,{extend:function(e,n,r){i(t,!1!==r,n,e)},sugarRestore:function(){return s(this,t,arguments,function(t,e,n){l(t,e,n.method)})},sugarRevert:function(){return s(this,t,arguments,function(t,e,n){n.existed?l(t,e,n.original):delete t[e]})}}))}function i(t,e,n,i){var o=e?t.prototype:t;r(t),y(i,function(r,i){var s=o[r],u=f(o,r);An(n)&&s&&(i=a(s,i,n)),!1===n&&s||l(o,r,i),t.SugarMethods[r]={method:i,existed:u,original:s,instance:e}})}function o(t,e,n,r,o){var s={};r=_n(r)?r.split(","):r,r.forEach(function(t,e){o(s,t,e)}),i(t,e,n,s)}function s(t,e,n,r){var i=0===n.length,o=u(n),s=!1;return y(e.SugarMethods,function(e,n){(i||-1!==o.indexOf(e))&&(s=!0,r(n.instance?t.prototype:t,e,n))}),s}function a(t,e,n){return function(){return n.apply(this,arguments)?e.apply(this,arguments):t.apply(this,arguments)}}function l(t,e,n){fn?rn.defineProperty(t,e,{value:n,configurable:!0,enumerable:!1,writable:!0}):t[e]=n}function u(t,e,n){var r=[];n=n||0;var i;for(i=t.length;i>n;n++)r.push(t[n]),e&&e.call(t,t[n],n);return r}function c(t,e,n){var r=t[n||0];Sn(r)&&(t=r,n=0),u(t,e,n)}function p(t){if(!t||!t.call)throw new TypeError("Callback is not callable")}function h(t){return void 0!==t}function d(t){return void 0===t}function f(t,e){return!!t&&dn.call(t,e)}function g(t){return!!t&&("object"==typeof t||gn&&Tn(t))}function m(t){var e=typeof t;return null==t||"string"===e||"number"===e||"boolean"===e}function v(t,e){e=e||hn.call(t);try{if(t&&t.constructor&&!f(t,"constructor")&&!f(t.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}return!!t&&"[object Object]"===e&&"hasOwnProperty"in t}function y(t,e){for(var n in t)if(f(t,n)&&!1===e.call(t,n,t[n],t))break}function b(t,e){for(var n=0;t>n;n++)e(n)}function w(t,e){return y(e,function(n){t[n]=e[n]}),t}function x(t){if(m(t)&&(t=rn(t)),mn&&_n(t))for(var e,n=t,r=0;e=n.charAt(r);)n[r++]=e;return t}function _(t){w(this,x(t))}function S(t,e,n){var r=Rn(10,Pn(e||0));return n=n||kn,0>e&&(r=1/r),n(t*r)/r}function E(){return"	\n\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u2028\u2029\u3000\ufeff"}function T(t,e){var n="";for(t=t.toString();e>0;)1&e&&(n+=t),(e>>=1)&&(t+=t);return n}function A(t,e){var n,r;return n=t.replace(Cn,function(t){return t=$n[t],t===Dn&&(r=!0),t}),r?parseFloat(n):parseInt(n,e||10)}function C(t,e,n,r){return r=Pn(t).toString(r||10),r=T("0",e-r.replace(/\.\d+/,"").length)+r,(n||0>t)&&(r=(0>t?"-":"+")+r),r}function P(t){if(t>=11&&13>=t)return"th";switch(t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function R(t,e){function n(t,n){(t||-1<e.indexOf(n))&&(r+=n)}var r="";return e=e||"",n(t.multiline,"m"),n(t.ignoreCase,"i"),n(t.global,"g"),n(t.u,"y"),r}function L(t){return _n(t)||(t=ln(t)),t.replace(/([\\/\'*+?|()\[\]{}.^$])/g,"\\$1")}function M(t,e){return t["get"+(t._utc?"UTC":"")+e]()}function k(t,e,n){return t["set"+(t._utc&&"ISOWeek"!=e?"UTC":"")+e](n)}function B(t,e){var n,r,i,o,s,a,l,u=typeof t;if("string"===u)return t;if(i=hn.call(t),n=v(t,i),r=Sn(t,i),null!=t&&n||r){if(e||(e=[]),1<e.length)for(a=e.length;a--;)if(e[a]===t)return"CYC";for(e.push(t),n=t.valueOf()+ln(t.constructor),o=r?t:rn.keys(t).sort(),a=0,l=o.length;l>a;a++)s=r?a:o[a],n+=s+B(t[s],e);e.pop()}else n=-1/0===1/t?"-0":ln(t&&t.valueOf?t.valueOf():t);return u+i+n}function I(t,e){return t===e?0!==t||1/t===1/e:O(t)&&O(e)?B(t)===B(e):!1}function O(t){var e=hn.call(t);return yn.test(e)||v(t,e)}function H(t,e,n){var r,i=t.length,o=e.length,s=!1!==e[o-1];return o>(s?1:2)?(r=[],u(e,function(e){return wn(e)?!1:void r.push(F(t,i,e,s,n))}),r):F(t,i,e[0],s,n)}function F(t,e,n,r,i){return r&&(n%=e,0>n&&(n=e+n)),i?t.charAt(n):t[n]}function N(t,e){o(e,!0,!1,t,function(t,e){t[e+("equal"===e?"s":"")]=function(){return rn[e].apply(null,[this].concat(u(arguments)))}})}function D(t,e,n,r){var i=t.length,o=-1==r,s=o?i-1:0;for(n=isNaN(n)?s:parseInt(n>>0),0>n&&(n=i+n),(!o&&0>n||o&&n>=i)&&(n=s);o&&n>=0||!o&&i>n;){if(t[n]===e)return n;n+=r}return-1}function j(t,e,n,r){var i=t.length,o=0,s=h(n);if(p(e),0==i&&!s)throw new TypeError("Reduce called on empty array with no initial value");for(s||(n=t[r?i-1:o],o++);i>o;)s=r?i-o-1:o,s in t&&(n=e(n,t[s],s,t)),o++;return n}function $(t){if(0===t.length)throw new TypeError("First argument must be defined")}function G(t){return t=sn(t),function(e){return t.test(e)}}function U(t){var e=t.getTime();return function(t){return!(!t||!t.getTime)&&t.getTime()===e}}function z(t){return function(e,n,r){return e===t||t.call(this,e,n,r)}}function q(t){return function(e,n,r){return e===t||t.call(r,n,e,r)}}function X(t,e){var n={};return function(r,i,o){var s;if(!g(r))return!1;for(s in t)if(n[s]=n[s]||V(t[s],e),!1===n[s].call(o,r[s],i,o))return!1;return!0}}function K(t){return function(e){return e===t||I(e,t)}}function V(t,e){if(!m(t)){if(Tn(t))return G(t);if(En(t))return U(t);if(An(t))return e?q(t):z(t);if(v(t))return X(t,e)}return K(t)}function Y(t,e,n,r){return e?e.apply?e.apply(n,r||[]):An(t[e])?t[e].call(t):t[e]:t}function W(t,e,n,r){var i=+t.length;for(0>n&&(n=t.length+n),n=isNaN(n)?0:n,!0===r&&(i+=n);i>n;){if(r=n%t.length,!(r in t)){Q(t,e,n);break}if(!1===e.call(t,t[r],r,t))break;n++}}function Q(t,e,n){var r,i=[];for(r in t)r in t&&r>>>0==r&&4294967295!=r&&r>=n&&i.push(parseInt(r));i.sort().each(function(n){return e.call(t,t[n],n,t)})}function J(t,e,n,r,i,o){var s,a,l;return 0<t.length&&(l=V(e),W(t,function(e,n){return l.call(o,e,n,t)?(s=e,a=n,!1):void 0},n,r)),i?a:s}function Z(t,e){var n,r=[],i={};return W(t,function(o,s){n=e?Y(o,e,t,[o,s,t]):o,ie(i,n)||r.push(o)}),r}function te(t,e,n){var r=[],i={};return e.each(function(t){ie(i,t)}),t.each(function(t){var e=B(t),o=!O(t);if(re(i,e,t,o)!==n){var s=0;if(o)for(e=i[e];s<e.length;)e[s]===t?e.splice(s,1):s+=1;else delete i[e];r.push(t)}}),r}function ee(t,e,n){e=e||1/0,n=n||0;var r=[];return W(t,function(t){Sn(t)&&e>n?r=r.concat(ee(t,e,n+1)):r.push(t)}),r}function ne(t){var e=[];return u(t,function(t){e=e.concat(t)}),e}function re(t,e,n,r){var i=e in t;return r&&(t[e]||(t[e]=[]),i=-1!==t[e].indexOf(n)),i}function ie(t,e){var n=B(e),r=!O(e),i=re(t,n,e,r);return r?t[n].push(e):t[n]=e,i}function oe(t,e,n,r){var i,o,s,a=[],l="max"===n,u="min"===n,c=on.isArray(t);for(i in t)if(t.hasOwnProperty(i)){if(n=t[i],s=Y(n,e,t,c?[n,parseInt(i),t]:[]),d(s))throw new TypeError("Cannot compare with undefined");s===o?a.push(n):(d(o)||l&&s>o||u&&o>s)&&(a=[n],o=s)}return c||(a=ee(a,1)),r?a:a[0]}function se(t,e){var n,r,i,o,s=0,a=0;n=on[qn],r=on[Xn];var l=on[Kn],u=on[zn],c=on[Vn];t=ae(t,n,r),e=ae(e,n,r);do n=t.charAt(s),i=l[n]||n,n=e.charAt(s),o=l[n]||n,n=i?u.indexOf(i):null,r=o?u.indexOf(o):null,-1===n||-1===r?(n=t.charCodeAt(s)||null,r=e.charCodeAt(s)||null,c&&(n>=On&&Hn>=n||n>=Fn&&Nn>=n)&&(r>=On&&Hn>=r||r>=Fn&&Nn>=r)&&(n=A(t.slice(s)),r=A(e.slice(s)))):(i=i!==t.charAt(s),o=o!==e.charAt(s),i!==o&&0===a&&(a=i-o)),s+=1;while(null!=n&&null!=r&&n===r);return n===r?a:n-r}function ae(t,e,n){return _n(t)||(t=ln(t)),n&&(t=t.toLowerCase()),e&&(t=t.replace(e,"")),t}function le(t,e){o(rn,!1,!0,t,function(t,n){t[n]=function(t,r,i){var o,s=rn.keys(x(t));return e||(o=V(r,!0)),i=on.prototype[n].call(s,function(n){var i=t[n];return e?Y(i,r,t,[n,i,t]):o(i,n,t)},i),Sn(i)&&(i=i.reduce(function(e,n){return e[n]=t[n],e},{})),i}}),N(t,_)}function ue(t){w(this,t),this.g=ar.concat()}function ce(t,e,n){var r,i,o=e[0],s=e[1],a=e[2];return e=t[n]||t.relative,An(e)?e.call(t,o,s,a,n):(i=t.units[8*(t.plural&&o>1?1:0)+s]||t.units[s],t.capitalizeUnit&&(i=ve(i)),r=t.modifiers.filter(function(t){return"sign"==t.name&&t.value==(a>0?1:-1)})[0],e.replace(/\{(.*?)\}/g,function(t,e){switch(e){case"num":return o;case"unit":return i;case"sign":return r.src}}))}function pe(t,e){return e=e||t.code,"en"===e||"en-US"===e?!0:t.variant}function he(t,e){return e.replace(sn(t.num,"g"),function(e){return de(t,e)||""})}function de(t,e){var n;return xn(e)?e:e&&-1!==(n=t.numbers.indexOf(e))?(n+1)%10:1}function fe(t,e){var n;if(_n(t)||(t=""),n=pr[t]||pr[t.slice(0,2)],!1===e&&!n)throw new TypeError("Invalid locale.");return n||tr}function ge(t,e){function n(t){var e=a[t];_n(e)?a[t]=e.split(","):e||(a[t]=[])}function r(t,e){t=t.split("+").map(function(t){return t.replace(/(.+):(.+)$/,function(t,e,n){return n.split("|").map(function(t){return e+t}).join("|")})}).join("|"),t.split("|").forEach(e)}function i(t,e,n){var i=[];a[t].forEach(function(t,o){e&&(t+="+"+t.slice(0,3)),r(t,function(t,e){i[e*n+o]=t.toLowerCase()})}),a[t]=i}function o(t,e,n){return t="\\d{"+t+","+e+"}",n&&(t+="|(?:"+ye(a.numbers)+")+"),t}function s(t,e){a[t]=a[t]||e}var a,l;return a=new ue(e),n("modifiers"),"months weekdays units numbers articles tokens timeMarker ampm timeSuffixes dateParse timeParse".split(" ").forEach(n),l=!a.monthSuffix,i("months",l,12),i("weekdays",l,7),i("units",!1,8),i("numbers",!1,10),s("code",t),s("date",o(1,2,a.digitDate)),s("year","'\\d{2}|"+o(4,4)),s("num",function(){var t=["-?\\d+"].concat(a.articles);return a.numbers&&(t=t.concat(a.numbers)),ye(t)}()),function(){var t=[];a.i={},a.modifiers.push({name:"day",src:"yesterday",value:-1}),a.modifiers.push({name:"day",src:"today",value:0}),a.modifiers.push({name:"day",src:"tomorrow",value:1}),a.modifiers.forEach(function(e){var n=e.name;r(e.src,function(r){var i=a[n];a.i[r]=e,t.push({name:n,src:r,value:e.value}),a[n]=i?i+"|"+r:r})}),a.day+="|"+ye(a.weekdays),a.modifiers=t}(),a.monthSuffix&&(a.month=o(1,2),a.months="1 2 3 4 5 6 7 8 9 10 11 12".split(" ").map(function(t){return t+a.monthSuffix})),a.full_month=o(1,2)+"|"+ye(a.months),0<a.timeSuffixes.length&&a.addFormat(Fe(a),!1,ir),a.addFormat("{day}",!0),a.addFormat("{month}"+(a.monthSuffix||"")),a.addFormat("{year}"+(a.yearSuffix||"")),a.timeParse.forEach(function(t){a.addFormat(t,!0)}),a.dateParse.forEach(function(t){a.addFormat(t)}),pr[t]=a}function me(t,e,n,r){t.g.unshift({r:r,locale:t,q:sn("^"+e+"$","i"),to:n})}function ve(t){return t.slice(0,1).toUpperCase()+t.slice(1)}function ye(t){return t.filter(function(t){return!!t}).join("|")}function be(){var t=an.SugarNewDate;return t?t():new an}function we(t,e){var n;return g(t[0])?t:xn(t[0])&&!xn(t[1])?[t[0]]:_n(t[0])&&e?[xe(t[0]),t[1]]:(n={},nr.forEach(function(e,r){n[e.name]=t[r]}),[n])}function xe(t){var e,n={};return(t=t.match(/^(\d+)?\s?(\w+?)s?$/i))&&(d(e)&&(e=parseInt(t[1])||1),n[t[2].toLowerCase()]=e),n}function _e(t,e,n){var r;for(d(n)&&(n=rr.length),e=e||0;n>e&&(r=rr[e],!1!==t(r.name,r,e));e++);}function Se(t,e){var n,r,i={};return e.forEach(function(e,o){n=t[o+1],d(n)||""===n||("year"===e&&(i.t=n.replace(/'/,"")),r=parseFloat(n.replace(/'/,"").replace(/,/,".")),i[e]=isNaN(r)?n.toLowerCase():r)}),i}function Ee(t){return t=t.trim().replace(/^just (?=now)|\.+$/i,""),Te(t)}function Te(t){return t.replace(er,function(t,e,n){var r,i,o=0,s=1;return e?t:(n.split("").reverse().forEach(function(t){t=sr[t];var e=t>9;e?(r&&(o+=s),s*=t/(i||1),i=t):(!1===r&&(s*=10),o+=s*t),r=e}),r&&(o+=s),o)})}function Ae(t,e,n,r){function i(t){d.push(t)}function o(){d.forEach(function(t){t.call()})}function s(){var t=u.getWeekday();u.setWeekday(7*(m.num-1)+(t>w?w+7:w))}function a(){var t=f.i[m.edge];_e(function(t){return h(m[t])?(v=t,!1):void 0},4),"year"===v?m.e="month":("month"===v||"week"===v)&&(m.e="day"),u[(0>t.value?"endOf":"beginningOf")+ve(v)](),-2===t.value&&u.reset()}function l(){var t;_e(function(e,n,r){if("day"===e&&(e="date"),h(m[e])){if(r>=b)return u.setTime(0/0),!1;t=t||{},t[e]=m[e],delete m[e]}}),t&&i(function(){u.set(t,!0)})}var u,c,p,d,f,m,v,b,w,x,_;return u=be(),d=[],u.utc(r),En(t)?u.utc(t.isUTC()).setTime(t.getTime()):xn(t)?u.setTime(t):g(t)?(u.set(t,!0),m=t):_n(t)&&(p=fe(e),t=Ee(t),p&&y(p.o?[p.o].concat(p.g):p.g,function(n,r){var o=t.match(r.q);return o?(f=r.locale,m=Se(o,r.to),f.o=r,m.utc&&u.utc(),m.timestamp?(m=m.timestamp,!1):(r.r&&!_n(m.month)&&(_n(m.date)||pe(p,e))&&(_=m.month,m.month=m.date,m.date=_),m.year&&2===m.t.length&&(m.year=100*kn(M(be(),"FullYear")/100)-100*kn(m.year/100)+m.year),m.month&&(m.month=f.getMonth(m.month),m.shift&&!m.unit&&(m.unit=f.units[7])),m.weekday&&m.date?delete m.weekday:m.weekday&&(m.weekday=f.getWeekday(m.weekday),m.shift&&!m.unit&&(m.unit=f.units[5])),m.day&&(_=f.i[m.day])?(m.day=_.value,u.reset(),c=!0):m.day&&-1<(w=f.getWeekday(m.day))&&(delete m.day,m.num&&m.month?(i(s),m.day=1):m.weekday=w),m.date&&!xn(m.date)&&(m.date=he(f,m.date)),m.ampm&&m.ampm===f.ampm[1]&&12>m.hour?m.hour+=12:m.ampm===f.ampm[0]&&12===m.hour&&(m.hour=0),("offset_hours"in m||"offset_minutes"in m)&&(u.utc(),m.offset_minutes=m.offset_minutes||0,m.offset_minutes+=60*m.offset_hours,"-"===m.offset_sign&&(m.offset_minutes*=-1),m.minute-=m.offset_minutes),m.unit&&(c=!0,x=de(f,m.num),b=f.units.indexOf(m.unit)%8,v=Zn.units[b],l(),m.shift&&(x*=(_=f.i[m.shift])?_.value:0),m.sign&&(_=f.i[m.sign])&&(x*=_.value),h(m.weekday)&&(u.set({weekday:m.weekday},!0),delete m.weekday),m[v]=(m[v]||0)+x),m.edge&&i(a),"-"===m.year_sign&&(m.year*=-1),_e(function(t,e,n){e=m[t];var r=e%1;r&&(m[rr[n-1].name]=kn(r*("second"===t?1e3:60)),m[t]=Mn(e))},1,4),!1)):void 0}),m?c?u.advance(m):(u._utc&&u.reset(),He(u,m,!0,!1,n)):("now"!==t&&(u=new an(t)),r&&u.addMinutes(-u.getTimezoneOffset())),o(),u.utc(!1)),{c:u,set:m}}function Ce(t){var e,n=Pn(t),r=n,i=0;return _e(function(t,o,s){e=Mn(S(n/o.b(),1)),e>=1&&(r=e,i=s)},1),[r,i,t]}function Pe(t){var e=Ce(t.millisecondsFromNow());return(6===e[1]||5===e[1]&&4===e[0]&&t.daysFromNow()>=be().daysInMonth())&&(e[0]=Pn(t.monthsFromNow()),e[1]=6),e}function Re(t,e,n){function r(t,n){var r=M(t,"Month");return fe(n).months[r+12*e]}Le(t,r,n),Le(ve(t),r,n,1)}function Le(t,e,n,r){ur[t]=function(t,i){var o=e(t,i);return n&&(o=o.slice(0,n)),r&&(o=o.slice(0,r).toUpperCase()+o.slice(r)),o}}function Me(t,e,n){ur[t]=e,ur[t+t]=function(t,n){return C(e(t,n),2)},n&&(ur[t+t+t]=function(t,n){return C(e(t,n),3)},ur[t+t+t+t]=function(t,n){return C(e(t,n),4)})}function ke(t){var e=t.match(/(\{\w+\})|[^{}]+/g);lr[t]=e.map(function(t){return t.replace(/\{(\w+)\}/,function(e,n){return t=ur[n]||n,n}),t})}function Be(t,e,n,r){var i;if(!t.isValid())return"Invalid Date";if(Date[e]?e=Date[e]:An(e)&&(i=Pe(t),e=e.apply(t,i.concat(fe(r)))),!e&&n)return i=i||Pe(t),0===i[1]&&(i[1]=1,i[0]=1),t=fe(r),ce(t,i,0<i[2]?"future":"past");e=e||"long",("short"===e||"long"===e||"full"===e)&&(e=fe(r)[e]),lr[e]||ke(e);var o,s;for(i="",e=lr[e],o=0,n=e.length;n>o;o++)s=e[o],i+=An(s)?s(t,r):s;return i}function Ie(t,e,n,r,i){var o,s,a,l=0,u=0,c=0;return o=Ae(e,n,null,i),r>0&&(u=c=r,s=!0),o.c.isValid()?(o.set&&o.set.e&&(cr.forEach(function(e){e.name===o.set.e&&(l=e.b(o.c,t-o.c)-1)}),e=ve(o.set.e),(o.set.edge||o.set.shift)&&o.c["beginningOf"+e](),"month"===o.set.e&&(a=o.c.clone()["endOf"+e]().getTime()),!s&&o.set.sign&&"millisecond"!=o.set.e&&(u=50,c=-50)),s=t.getTime(),e=o.c.getTime(),a=Oe(t,e,a||e+l),s>=e-u&&a+c>=s):!1}function Oe(t,e,n){return e=new an(e),t=new an(n).utc(t.isUTC()),23!==M(t,"Hours")&&(e=e.getTimezoneOffset(),t=t.getTimezoneOffset(),e!==t&&(n+=(t-e).minutes())),n}function He(t,e,n,r,i){function o(t){return h(e[t])?e[t]:e[t+"s"]}function s(t){return h(o(t))}var a;if(xn(e)&&r)e={milliseconds:e};else if(xn(e))return t.setTime(e),t;h(e.date)&&(e.day=e.date),_e(function(r,i,o){var l="day"===r;return s(r)||l&&s("weekday")?(e.e=r,a=+o,!1):void(!n||"week"===r||l&&s("week")||k(t,i.method,l?1:0))}),cr.forEach(function(n){var i=n.name;n=n.method;var a;a=o(i),d(a)||(r?("week"===i&&(a=(e.day||0)+7*a,n="Date"),a=a*r+M(t,n)):"month"===i&&s("day")&&k(t,"Date",15),k(t,n,a),r&&"month"===i&&(i=a,0>i&&(i=i%12+12),i%12!=M(t,"Month")&&k(t,"Date",0)))}),r||s("day")||!s("weekday")||t.setWeekday(o("weekday"));var l;t:{switch(i){case-1:l=t>be();break t;case 1:l=t<be();break t}l=void 0}return l&&_e(function(e,n){return(n.k||"week"===e&&s("weekday"))&&!(s(e)||"day"===e&&s("weekday"))?(t[n.j](i),!1):void 0},a+1),t}function Fe(t,e){var n,r=or,i={h:0,m:1,s:2};return t=t||Zn,r.replace(/{([a-z])}/g,function(r,o){var s=[],a="h"===o,l=a&&!e;return"t"===o?t.ampm.join("|"):(a&&s.push(":"),(n=t.timeSuffixes[i[o]])&&s.push(n+"\\s*"),0===s.length?"":"(?:"+s.join("|")+")"+(l?"":"?"))})}function Ne(t,e,n){var r,i;return xn(t[1])?r=we(t)[0]:(r=t[0],i=t[1]),Ae(r,i,e,n).c}function De(t,e){function n(){return kn(this*e)}function r(){return Ne(arguments)[t.j](this)}function i(){return Ne(arguments)[t.j](-this)}var o=t.name,s={};s[o]=n,s[o+"s"]=n,s[o+"Before"]=i,s[o+"sBefore"]=i,s[o+"Ago"]=i,s[o+"sAgo"]=i,s[o+"After"]=r,s[o+"sAfter"]=r,s[o+"FromNow"]=r,s[o+"sFromNow"]=r,un.extend(s)}function je(t,e){this.start=$e(t),this.end=$e(e)}function $e(t){return En(t)?new an(t.getTime()):null==t?t:En(t)?t.getTime():t.valueOf()}function Ge(t){return t=null==t?t:En(t)?t.getTime():t.valueOf(),!!t||0===t}function Ue(t,e){var n,r,i,o;return xn(e)?new an(t.getTime()+e):(n=e[0],r=e[1],i=M(t,r),o=new an(t.getTime()),k(o,r,i+n),o)}function ze(t,e){return ln.fromCharCode(t.charCodeAt(0)+e)}function qe(t,e){return t+e}function Xe(t,e,n,r,i){1/0!==e&&(t.timers||(t.timers=[]),xn(e)||(e=1),t.n=!1,t.timers.push(setTimeout(function(){t.n||n.apply(r,i||[])},e)))}function Ke(t,e,n,r,i,o){var s=t.toFixed(20),a=s.search(/\./),s=s.search(/[1-9]/),a=a-s;return a>0&&(a-=1),i=In(Bn(Mn(a/3),!1===i?n.length:i),-r),r=n.charAt(i+r-1),-9>a&&(i=-3,e=Pn(a)-9,r=n.slice(0,1)),n=o?Rn(2,10*i):Rn(10,3*i),S(t/n,e||0).format()+r.trim()}function Ve(t,e,n,r){var i,o,s;(o=e.match(/^(.+?)(\[.*\])$/))?(s=o[1],e=o[2].replace(/^\[|\]$/g,"").split("]["),e.forEach(function(e){i=!e||e.match(/^\d+$/),!s&&Sn(t)&&(s=t.length),f(t,s)||(t[s]=i?[]:{}),t=t[s],s=e}),!s&&i&&(s=t.length.toString()),Ve(t,s,n,r)):t[e]=r&&"true"===n?!0:r&&"false"===n?!1:n}function Ye(t,e){var n;return Sn(e)||g(e)&&e.toString===hn?(n=[],y(e,function(e,r){t&&(e=t+"["+e+"]"),n.push(Ye(e,r))}),n.join("&")):t?We(t)+"="+(En(e)?e.getTime():We(e)):""}function We(t){return t||!1===t||0===t?encodeURIComponent(t).replace(/%20/g,"+"):""}function Qe(t,e,n){var r,i=t instanceof _?new _:{};return y(t,function(t,o){r=!1,c(e,function(e){(Tn(e)?e.test(t):g(e)?e[t]===o:t===ln(e))&&(r=!0)},1),r===n&&(i[t]=o)}),i}function Je(t){if(t=+t,0>t||1/0===t)throw new RangeError("Invalid number");return t}function Ze(t,e){return T(h(e)?e:" ",t)}function tn(t,e,n,r,i){var o;if(t.length<=e)return t.toString();switch(r=d(r)?"...":r,n){case"left":return t=i?en(t,e,!0):t.slice(t.length-e),r+t;case"middle":return n=Ln(e/2),o=Mn(e/2),e=i?en(t,n):t.slice(0,n),t=i?en(t,o,!0):t.slice(t.length-o),e+r+t;default:return e=i?en(t,e):t.slice(0,e),e+r}}function en(t,e,n){if(n)return en(t.reverse(),e).reverse();n=sn("(?=["+E()+"])");var r=0;return t.split(n).filter(function(t){return r+=t.length,e>=r}).join("")}function nn(t,e,n){return _n(e)&&(e=t.indexOf(e),-1===e&&(e=n?t.length:0)),e}var rn=Object,on=Array,sn=RegExp,an=Date,ln=String,un=Number,cn=Math,pn="undefined"!=typeof global?global:this,hn=rn.prototype.toString,dn=rn.prototype.hasOwnProperty,fn=rn.defineProperty&&rn.defineProperties,gn="function"==typeof sn(),mn=!("0"in new ln("a")),vn={},yn=/^\[object Date|Array|String|Number|RegExp|Boolean|Arguments\]$/,bn="Boolean Number String Array Date RegExp Function".split(" "),wn=n("boolean",bn[0]),xn=n("number",bn[1]),_n=n("string",bn[2]),Sn=e(bn[3]),En=e(bn[4]),Tn=e(bn[5]),An=e(bn[6]);_.prototype.constructor=rn;var Cn,Pn=cn.abs,Rn=cn.pow,Ln=cn.ceil,Mn=cn.floor,kn=cn.round,Bn=cn.min,In=cn.max,On=48,Hn=57,Fn=65296,Nn=65305,Dn=".",jn="",$n={};r(rn),y(bn,function(t,e){r(pn[e])});var Gn,Un;for(Un=0;9>=Un;Un++)Gn=ln.fromCharCode(Un+Fn),jn+=Gn,$n[Gn]=ln.fromCharCode(Un+On);$n[","]="",$n["\uff0e"]=Dn,$n[Dn]=Dn,Cn=sn("["+jn+"\uff0e,"+Dn+"]","g"),i(rn,!1,!1,{keys:function(t){var e=[];if(!g(t)&&!Tn(t)&&!An(t))throw new TypeError("Object required");return y(t,function(t){e.push(t)}),e}}),i(on,!1,!1,{isArray:function(t){return Sn(t)}}),i(on,!0,!1,{every:function(t,e){var n=this.length,r=0;for($(arguments);n>r;){if(r in this&&!t.call(e,this[r],r,this))return!1;r++}return!0},some:function(t,e){var n=this.length,r=0;for($(arguments);n>r;){if(r in this&&t.call(e,this[r],r,this))return!0;r++}return!1},map:function(t,e){e=arguments[1];var n=this.length,r=0,i=Array(n);for($(arguments);n>r;)r in this&&(i[r]=t.call(e,this[r],r,this)),r++;return i},filter:function(t){var e=arguments[1],n=this.length,r=0,i=[];for($(arguments);n>r;)r in this&&t.call(e,this[r],r,this)&&i.push(this[r]),r++;return i},indexOf:function(t,e){return _n(this)?this.indexOf(t,e):D(this,t,e,1)},lastIndexOf:function(t,e){return _n(this)?this.lastIndexOf(t,e):D(this,t,e,-1)},forEach:function(t,e){var n=this.length,r=0;for(p(t);n>r;)r in this&&t.call(e,this[r],r,this),r++},reduce:function(t,e){return j(this,t,e)},reduceRight:function(t,e){return j(this,t,e,!0)}}),i(Function,!0,!1,{bind:function(t){var e,n=this,r=u(arguments,null,1);if(!An(this))throw new TypeError("Function.prototype.bind called on a non-function");return e=function(){return n.apply(n.prototype&&this instanceof n?this:t,r.concat(u(arguments)))},e.prototype=this.prototype,e}}),i(an,!1,!1,{now:function(){return(new an).getTime()}}),function(){var t=E().match(/^\s+$/);try{ln.prototype.trim.call([1])}catch(e){t=!1}i(ln,!0,!t,{trim:function(){return this.toString().trimLeft().trimRight()},trimLeft:function(){return this.replace(sn("^["+E()+"]+"),"")},trimRight:function(){return this.replace(sn("["+E()+"]+$"),"")}})}(),function(){var t=new an(an.UTC(1999,11,31)),t=t.toISOString&&"1999-12-31T00:00:00.000Z"===t.toISOString();o(an,!0,!t,"toISOString,toJSON",function(t,e){t[e]=function(){return C(this.getUTCFullYear(),4)+"-"+C(this.getUTCMonth()+1,2)+"-"+C(this.getUTCDate(),2)+"T"+C(this.getUTCHours(),2)+":"+C(this.getUTCMinutes(),2)+":"+C(this.getUTCSeconds(),2)+"."+C(this.getUTCMilliseconds(),3)+"Z"}})}();var zn="AlphanumericSortOrder",qn="AlphanumericSortIgnore",Xn="AlphanumericSortIgnoreCase",Kn="AlphanumericSortEquivalents",Vn="AlphanumericSortNatural";i(on,!1,!0,{create:function(){var t=[];return u(arguments,function(e){(!m(e)&&"length"in e&&("[object Arguments]"===hn.call(e)||e.callee)||!m(e)&&"length"in e&&!_n(e)&&!v(e))&&(e=on.prototype.slice.call(e,0)),t=t.concat(e)}),t}}),i(on,!0,!1,{find:function(t,e){return p(t),J(this,t,0,!1,!1,e)},findIndex:function(t,e){var n;return p(t),n=J(this,t,0,!1,!0,e),d(n)?-1:n}}),i(on,!0,!0,{findFrom:function(t,e,n){return J(this,t,e,n)},findIndexFrom:function(t,e,n){return e=J(this,t,e,n,!0),d(e)?-1:e},findAll:function(t,e,n){var r,i=[];return 0<this.length&&(r=V(t),W(this,function(t,e,n){r(t,e,n)&&i.push(t)},e,n)),i},count:function(t){return d(t)?this.length:this.findAll(t).length},removeAt:function(t,e){return d(t)?this:(d(e)&&(e=t),this.splice(t,e-t+1),this)},include:function(t,e){return this.clone().add(t,e)},exclude:function(){return on.prototype.remove.apply(this.clone(),arguments)},clone:function(){return w([],this)},unique:function(t){return Z(this,t)},flatten:function(t){return ee(this,t)},union:function(){return Z(this.concat(ne(arguments)))},intersect:function(){return te(this,ne(arguments),!1)},subtract:function(){return te(this,ne(arguments),!0)},at:function(){return H(this,arguments)},first:function(t){return d(t)?this[0]:(0>t&&(t=0),this.slice(0,t))},last:function(t){return d(t)?this[this.length-1]:this.slice(0>this.length-t?0:this.length-t)},from:function(t){return this.slice(t)},to:function(t){return d(t)&&(t=this.length),this.slice(0,t)},min:function(t,e){return oe(this,t,"min",e)},max:function(t,e){return oe(this,t,"max",e)},least:function(t,e){return oe(this.groupBy.apply(this,[t]),"length","min",e)},most:function(t,e){return oe(this.groupBy.apply(this,[t]),"length","max",e)},sum:function(t){return t=t?this.map(t):this,0<t.length?t.reduce(function(t,e){return t+e}):0},average:function(t){return t=t?this.map(t):this,0<t.length?t.sum()/t.length:0},inGroups:function(t,e){var n=1<arguments.length,r=this,i=[],o=Ln(this.length/t);return b(t,function(t){t*=o;var s=r.slice(t,t+o);n&&s.length<o&&b(o-s.length,function(){s=s.add(e)}),i.push(s)}),i},inGroupsOf:function(t,e){var n,r=[],i=this.length,o=this;return 0===i||0===t?o:(d(t)&&(t=1),d(e)&&(e=null),b(Ln(i/t),function(i){for(n=o.slice(t*i,t*i+t);n.length<t;)n.push(e);r.push(n)}),r)},isEmpty:function(){return 0==this.compact().length},sortBy:function(t,e){var n=this.clone();return n.sort(function(r,i){var o,s;return o=Y(r,t,n,[r]),s=Y(i,t,n,[i]),(_n(o)&&_n(s)?se(o,s):s>o?-1:o>s?1:0)*(e?-1:1)}),n},randomize:function(){for(var t,e,n=this.concat(),r=n.length;r;)t=cn.random()*r|0,e=n[--r],n[r]=n[t],n[t]=e;return n},zip:function(){var t=u(arguments);return this.map(function(e,n){return[e].concat(t.map(function(t){return n in t?t[n]:null}))})},sample:function(t){var e=this.randomize();return 0<arguments.length?e.slice(0,t):e[0]},each:function(t,e,n){return W(this,t,e,n),this},add:function(t,e){return(!xn(un(e))||isNaN(e))&&(e=this.length),on.prototype.splice.apply(this,[e,0].concat(t)),this},remove:function(){var t=this;return u(arguments,function(e){var n=0;for(e=V(e);n<t.length;)e(t[n],n,t)?t.splice(n,1):n++}),t},compact:function(t){var e=[];return W(this,function(n){Sn(n)?e.push(n.compact()):t&&n?e.push(n):t||null==n||n.valueOf()!==n.valueOf()||e.push(n)}),e},groupBy:function(t,e){var n,r=this,i={};return W(r,function(e,o){n=Y(e,t,r,[e,o,r]),i[n]||(i[n]=[]),i[n].push(e)}),e&&y(i,e),i},none:function(){return!this.any.apply(this,arguments)}}),i(on,!0,!0,{all:on.prototype.every,any:on.prototype.some,insert:on.prototype.add}),i(rn,!1,!0,{map:function(t,e){var n,r,i={};for(n in t)f(t,n)&&(r=t[n],i[n]=Y(r,e,t,[n,r,t]));return i},reduce:function(t){var e=rn.keys(x(t)).map(function(e){return t[e]});return e.reduce.apply(e,u(arguments,null,1))},each:function(t,e){return p(e),y(t,e),t},size:function(t){return rn.keys(x(t)).length}});var Yn="any all none count find findAll isEmpty".split(" "),Wn="sum average min max least most".split(" "),Qn=["map","reduce","size"],Jn=Yn.concat(Wn).concat(Qn);!function(){function t(){var t=arguments;return 0<t.length&&!An(t[0])}var e=on.prototype.map;o(on,!0,t,"every,all,some,filter,any,none,find,findIndex",function(t,e){var n=on.prototype[e];t[e]=function(t){var e=V(t);return n.call(this,function(t,n){return e(t,n,this)})}}),i(on,!0,t,{map:function(t){return e.call(this,function(e,n){return Y(e,t,this,[e,n,this])})}})}(),function(){on[zn]="A\xc1\xc0\xc2\xc3\u0104BC\u0106\u010c\xc7D\u010e\xd0E\xc9\xc8\u011a\xca\xcb\u0118FG\u011eH\u0131I\xcd\xcc\u0130\xce\xcfJKL\u0141MN\u0143\u0147\xd1O\xd3\xd2\xd4PQR\u0158S\u015a\u0160\u015eT\u0164U\xda\xd9\u016e\xdb\xdcVWXY\xddZ\u0179\u017b\u017d\xde\xc6\u0152\xd8\xd5\xc5\xc4\xd6".split("").map(function(t){return t+t.toLowerCase()}).join("");var t={};W("A\xc1\xc0\xc2\xc3\xc4 C\xc7 E\xc9\xc8\xca\xcb I\xcd\xcc\u0130\xce\xcf O\xd3\xd2\xd4\xd5\xd6 S\xdf U\xda\xd9\xdb\xdc".split(" "),function(e){var n=e.charAt(0);W(e.slice(1).split(""),function(e){t[e]=n,t[e.toLowerCase()]=n.toLowerCase()})}),on[Vn]=!0,on[Xn]=!0,on[Kn]=t}(),le(Yn),le(Wn,!0),N(Qn,_),on.AlphanumericSort=se;var Zn,tr,er,nr,rr,ir="ampm hour minute second ampm utc offset_sign offset_hours offset_minutes ampm".split(" "),or="({t})?\\s*(\\d{1,2}(?:[,.]\\d+)?)(?:{h}([0-5]\\d(?:[,.]\\d+)?)?{m}(?::?([0-5]\\d(?:[,.]\\d+)?){s})?\\s*(?:({t})|(Z)|(?:([+-])(\\d{2,2})(?::?(\\d{2,2}))?)?)?|\\s*({t}))",sr={},ar=[],lr={},ur={yyyy:function(t){return M(t,"FullYear")},yy:function(t){return M(t,"FullYear")%100},ord:function(t){return t=M(t,"Date"),t+P(t)},tz:function(t){return t.getUTCOffset()},isotz:function(t){return t.getUTCOffset(!0)},Z:function(t){return t.getUTCOffset()},ZZ:function(t){return t.getUTCOffset().replace(/(\d{2})$/,":$1")}},cr=[{name:"year",method:"FullYear",k:!0,b:function(t){return 864e5*(365+(t?t.isLeapYear()?1:0:.25))}},{name:"month",error:.919,method:"Month",k:!0,b:function(t,e){var n,r=30.4375;return t&&(n=t.daysInMonth(),e<=n.days()&&(r=n)),864e5*r}},{name:"week",method:"ISOWeek",b:t(6048e5)},{name:"day",error:.958,method:"Date",k:!0,b:t(864e5)},{name:"hour",method:"Hours",b:t(36e5)},{name:"minute",method:"Minutes",b:t(6e4)},{name:"second",method:"Seconds",b:t(1e3)},{name:"millisecond",method:"Milliseconds",b:t(1)}],pr={};ue.prototype={getMonth:function(t){return xn(t)?t-1:this.months.indexOf(t)%12},getWeekday:function(t){return this.weekdays.indexOf(t)%7},addFormat:function(t,e,n,r,i){var o,s=n||[],a=this;t=t.replace(/\s+/g,"[,. ]*"),t=t.replace(/\{([^,]+?)\}/g,function(t,e){var r,i,o,l=e.match(/\?$/);o=e.match(/^(\d+)\??$/);var u=e.match(/(\d)(?:-(\d))?/),c=e.replace(/[^a-z]+$/,"");return o?r=a.tokens[o[1]]:a[c]?r=a[c]:a[c+"s"]&&(r=a[c+"s"],u&&(i=[],r.forEach(function(t,e){var n=e%(a.units?8:r.length);n>=u[1]&&n<=(u[2]||u[1])&&i.push(t)}),r=i),r=ye(r)),o?o="(?:"+r+")":(n||s.push(c),o="("+r+")"),l&&(o+="?"),o}),e?(e=Fe(a,i),i=["t","[\\s\\u3000]"].concat(a.timeMarker),o=t.match(/\\d\{\d,\d\}\)+\??$/),me(a,"(?:"+e+")[,\\s\\u3000]+?"+t,ir.concat(s),r),me(a,t+"(?:[,\\s]*(?:"+i.join("|")+(o?"+":"*")+")"+e+")?",s.concat(ir),r)):me(a,t,s,r)}},i(an,!1,!0,{create:function(){return Ne(arguments)},past:function(){return Ne(arguments,-1)},future:function(){return Ne(arguments,1)},addLocale:function(t,e){return ge(t,e)},setLocale:function(t){var e=fe(t,!1);return tr=e,t&&t!=e.code&&(e.code=t),e},getLocale:function(t){return t?fe(t,!1):tr},addFormat:function(t,e,n){me(fe(n),t,e)}}),i(an,!0,!0,{set:function(){var t=we(arguments);return He(this,t[0],t[1])},setWeekday:function(t){return d(t)?void 0:k(this,"Date",M(this,"Date")+t-M(this,"Day"))},setISOWeek:function(t){var e=M(this,"Day")||7;return d(t)?void 0:(this.set({month:0,date:4}),this.set({weekday:1}),t>1&&this.addWeeks(t-1),1!==e&&this.advance({days:e-1}),this.getTime())},getISOWeek:function(){var t;t=this.clone();var e=M(t,"Day")||7;return t.addDays(4-e).reset(),1+Mn(t.daysSince(t.clone().beginningOfYear())/7)},beginningOfISOWeek:function(){var t=this.getDay();return 0===t?t=-6:1!==t&&(t=1),this.setWeekday(t),this.reset()},endOfISOWeek:function(){return 0!==this.getDay()&&this.setWeekday(7),this.endOfDay()},getUTCOffset:function(t){var e=this._utc?0:this.getTimezoneOffset(),n=!0===t?":":"";return!e&&t?"Z":C(Mn(-e/60),2,!0)+n+C(Pn(e%60),2)},utc:function(t){return l(this,"_utc",!0===t||0===arguments.length),this},isUTC:function(){return!!this._utc||0===this.getTimezoneOffset()},advance:function(){var t=we(arguments,!0);return He(this,t[0],t[1],1)},rewind:function(){var t=we(arguments,!0);return He(this,t[0],t[1],-1)},isValid:function(){return!isNaN(this.getTime())},isAfter:function(t,e){return this.getTime()>an.create(t).getTime()-(e||0)},isBefore:function(t,e){return this.getTime()<an.create(t).getTime()+(e||0)},isBetween:function(t,e,n){var r=this.getTime();t=an.create(t).getTime();var i=an.create(e).getTime();return e=Bn(t,i),t=In(t,i),n=n||0,r>e-n&&t+n>r},isLeapYear:function(){var t=M(this,"FullYear");return 0===t%4&&0!==t%100||0===t%400},daysInMonth:function(){return 32-M(new an(M(this,"FullYear"),M(this,"Month"),32),"Date")},format:function(t,e){return Be(this,t,!1,e)},relative:function(t,e){return _n(t)&&(e=t,t=null),Be(this,t,!0,e)},is:function(t,e,n){var r,i;if(this.isValid()){if(_n(t))switch(t=t.trim().toLowerCase(),i=this.clone().utc(n),!0){case"future"===t:return this.getTime()>be().getTime();
case"past"===t:return this.getTime()<be().getTime();case"weekday"===t:return 0<M(i,"Day")&&6>M(i,"Day");case"weekend"===t:return 0===M(i,"Day")||6===M(i,"Day");case-1<(r=Zn.weekdays.indexOf(t)%7):return M(i,"Day")===r;case-1<(r=Zn.months.indexOf(t)%12):return M(i,"Month")===r}return Ie(this,t,null,e,n)}},reset:function(t){var e,n={};return t=t||"hours","date"===t&&(t="days"),e=cr.some(function(e){return t===e.name||t===e.name+"s"}),n[t]=t.match(/^days?/)?1:0,e?this.set(n,!0):this},clone:function(){var t=new an(this.getTime());return t.utc(!!this._utc),t}}),i(an,!0,!0,{iso:function(){return this.toISOString()},getWeekday:an.prototype.getDay,getUTCWeekday:an.prototype.getUTCDay}),i(un,!0,!0,{duration:function(t){return t=fe(t),ce(t,Ce(this),"duration")}}),Zn=tr=an.addLocale("en",{plural:!0,timeMarker:"at",ampm:"am,pm",months:"January,February,March,April,May,June,July,August,September,October,November,December",weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday",units:"millisecond:|s,second:|s,minute:|s,hour:|s,day:|s,week:|s,month:|s,year:|s",numbers:"one,two,three,four,five,six,seven,eight,nine,ten",articles:"a,an,the",tokens:"the,st|nd|rd|th,of","short":"{Month} {d}, {yyyy}","long":"{Month} {d}, {yyyy} {h}:{mm}{tt}",full:"{Weekday} {Month} {d}, {yyyy} {h}:{mm}:{ss}{tt}",past:"{num} {unit} {sign}",future:"{num} {unit} {sign}",duration:"{num} {unit}",modifiers:[{name:"sign",src:"ago|before",value:-1},{name:"sign",src:"from now|after|from|in|later",value:1},{name:"edge",src:"last day",value:-2},{name:"edge",src:"end",value:-1},{name:"edge",src:"first day|beginning",value:1},{name:"shift",src:"last",value:-1},{name:"shift",src:"the|this",value:0},{name:"shift",src:"next",value:1}],dateParse:["{month} {year}","{shift} {unit=5-7}","{0?} {date}{1}","{0?} {edge} of {shift?} {unit=4-7?}{month?}{year?}"],timeParse:"{num} {unit} {sign};{sign} {num} {unit};{0} {num}{1} {day} of {month} {year?};{weekday?} {month} {date}{1?} {year?};{date} {month} {year};{date} {month};{shift} {weekday};{shift} week {weekday};{weekday} {2?} {shift} week;{num} {unit=4-5} {sign} {day};{0?} {date}{1} of {month};{0?}{month?} {date?}{1?} of {shift} {unit=6-7}".split(";")}),rr=cr.concat().reverse(),nr=cr.concat(),nr.splice(2,1),o(an,!0,!0,cr,function(t,e,n){function r(t){t/=l;var n=t%1,r=e.error||.999;return n&&Pn(n%1)>r&&(t=kn(t)),0>t?Ln(t):Mn(t)}var i,o,s=e.name,a=ve(s),l=e.b();e.j="add"+a+"s",i=function(t,e){return r(this.getTime()-an.create(t,e).getTime())},o=function(t,e){return r(an.create(t,e).getTime()-this.getTime())},t[s+"sAgo"]=o,t[s+"sUntil"]=o,t[s+"sSince"]=i,t[s+"sFromNow"]=i,t[e.j]=function(t,e){var n={};return n[s]=t,this.advance(n,e)},De(e,l),3>n&&["Last","This","Next"].forEach(function(e){t["is"+e+a]=function(){return Ie(this,e+" "+s,"en")}}),4>n&&(t["beginningOf"+a]=function(){var t={};switch(s){case"year":t.year=M(this,"FullYear");break;case"month":t.month=M(this,"Month");break;case"day":t.day=M(this,"Date");break;case"week":t.weekday=0}return this.set(t,!0)},t["endOf"+a]=function(){var t={hours:23,minutes:59,seconds:59,milliseconds:999};switch(s){case"year":t.month=11,t.day=31;break;case"month":t.day=this.daysInMonth();break;case"week":t.weekday=6}return this.set(t,!0)})}),Zn.addFormat("([+-])?(\\d{4,4})[-.]?{full_month}[-.]?(\\d{1,2})?",!0,["year_sign","year","month","date"],!1,!0),Zn.addFormat("(\\d{1,2})[-.\\/]{full_month}(?:[-.\\/](\\d{2,4}))?",!0,["date","month","year"],!0),Zn.addFormat("{full_month}[-.](\\d{4,4})",!1,["month","year"]),Zn.addFormat("\\/Date\\((\\d+(?:[+-]\\d{4,4})?)\\)\\/",!1,["timestamp"]),Zn.addFormat(Fe(Zn),!1,ir),ar=Zn.g.slice(0,7).reverse(),Zn.g=Zn.g.slice(7).concat(ar),Me("f",function(t){return M(t,"Milliseconds")},!0),Me("s",function(t){return M(t,"Seconds")}),Me("m",function(t){return M(t,"Minutes")}),Me("h",function(t){return M(t,"Hours")%12||12}),Me("H",function(t){return M(t,"Hours")}),Me("d",function(t){return M(t,"Date")}),Me("M",function(t){return M(t,"Month")+1}),function(){function t(t,e){var n=M(t,"Hours");return fe(e).ampm[Mn(n/12)]||""}Le("t",t,1),Le("tt",t),Le("T",t,1,1),Le("TT",t,null,2)}(),function(){function t(t,e){var n=M(t,"Day");return fe(e).weekdays[n]}Le("dow",t,3),Le("Dow",t,3,1),Le("weekday",t),Le("Weekday",t,null,1)}(),Re("mon",0,3),Re("month",0),Re("month2",1),Re("month3",2),ur.ms=ur.f,ur.milliseconds=ur.f,ur.seconds=ur.s,ur.minutes=ur.m,ur.hours=ur.h,ur["24hr"]=ur.H,ur["12hr"]=ur.h,ur.date=ur.d,ur.day=ur.d,ur.year=ur.yyyy,o(an,!0,!0,"short,long,full",function(t,e){t[e]=function(t){return Be(this,e,!1,t)}}),"\u3007\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07".split("").forEach(function(t,e){e>9&&(e=Rn(10,e-9)),sr[t]=e}),w(sr,$n),er=sn("([\u671f\u9031\u5468])?([\u3007\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07"+jn+"]+)(?!\u6628)","g"),function(){var t=Zn.weekdays.slice(0,7),e=Zn.months.slice(0,12);o(an,!0,!0,"today yesterday tomorrow weekday weekend future past".split(" ").concat(t).concat(e),function(t,e){t["is"+ve(e)]=function(t){return this.is(e,0,t)}})}(),an.utc||(an.utc={create:function(){return Ne(arguments,0,!0)},past:function(){return Ne(arguments,-1,!0)},future:function(){return Ne(arguments,1,!0)}}),i(an,!1,!0,{RFC1123:"{Dow}, {dd} {Mon} {yyyy} {HH}:{mm}:{ss} {tz}",RFC1036:"{Weekday}, {dd}-{Mon}-{yy} {HH}:{mm}:{ss} {tz}",ISO8601_DATE:"{yyyy}-{MM}-{dd}",ISO8601_DATETIME:"{yyyy}-{MM}-{dd}T{HH}:{mm}:{ss}.{fff}{isotz}"}),je.prototype.toString=function(){return this.isValid()?this.start+".."+this.end:"Invalid Range"},i(je,!0,!0,{isValid:function(){return Ge(this.start)&&Ge(this.end)&&typeof this.start==typeof this.end},span:function(){return this.isValid()?Pn((_n(this.end)?this.end.charCodeAt(0):this.end)-(_n(this.start)?this.start.charCodeAt(0):this.start))+1:0/0},contains:function(t){return null==t?!1:t.start&&t.end?t.start>=this.start&&t.start<=this.end&&t.end>=this.start&&t.end<=this.end:t>=this.start&&t<=this.end},every:function(t,e){var n,r=this.start,i=this.end,o=r>i,s=r,a=0,l=[];for(An(t)&&(e=t,t=null),t=t||1,xn(r)?n=qe:_n(r)?n=ze:En(r)&&(n=t,xn(n)?t=n:(r=n.toLowerCase().match(/^(\d+)?\s?(\w+?)s?$/i),n=parseInt(r[1])||1,r=r[2].slice(0,1).toUpperCase()+r[2].slice(1),r.match(/hour|minute|second/i)?r+="s":"Year"===r?r="FullYear":"Day"===r&&(r="Date"),t=[n,r]),n=Ue),o&&t>0&&(t*=-1);o?s>=i:i>=s;)l.push(s),e&&e(s,a),s=n(s,t),a++;return l},union:function(t){return new je(this.start<t.start?this.start:t.start,this.end>t.end?this.end:t.end)},intersect:function(t){return t.start>this.end||t.end<this.start?new je(0/0,0/0):new je(this.start>t.start?this.start:t.start,this.end<t.end?this.end:t.end)},clone:function(){return new je(this.start,this.end)},clamp:function(t){var e=this.start,n=this.end,r=e>n?n:e,e=e>n?e:n;return $e(r>t?r:t>e?e:t)}}),[un,ln,an].forEach(function(t){i(t,!1,!0,{range:function(e,n){return t.create&&(e=t.create(e),n=t.create(n)),new je(e,n)}})}),i(un,!0,!0,{upto:function(t,e,n){return un.range(this,t).every(n,e)},clamp:function(t,e){return new je(t,e).clamp(this)},cap:function(t){return this.clamp(void 0,t)}}),i(un,!0,!0,{downto:un.prototype.upto}),i(on,!1,function(t){return t instanceof je},{create:function(t){return t.every()}}),i(Function,!0,!0,{lazy:function(t,e,n){function r(){return u.length<n-(c&&e?1:0)&&u.push([this,arguments]),c||(c=!0,e?i():Xe(r,o,i)),a}var i,o,s,a,l=this,u=[],c=!1;return t=t||1,n=n||1/0,o=Ln(t),s=kn(o/t)||1,i=function(){var t,e=u.length;if(0!=e){for(t=In(e-s,0);e>t;)a=Function.prototype.apply.apply(l,u.shift()),e--;Xe(r,o,function(){c=!1,i()})}},r},throttle:function(t){return this.lazy(t,!0,1)},debounce:function(t){function e(){e.cancel(),Xe(e,t,n,this,arguments)}var n=this;return e},delay:function(t){var e=u(arguments,null,1);return Xe(this,t,this,this,e),this},every:function(t){function e(){n.apply(n,r),Xe(n,t,e)}var n=this,r=arguments,r=1<r.length?u(r,null,1):[];return Xe(n,t,e),n},cancel:function(){var t,e=this.timers;if(Sn(e))for(;t=e.shift();)clearTimeout(t);return this.n=!0,this},after:function(t){var e=this,n=0,r=[];if(xn(t)){if(0===t)return e.call(),e}else t=1;return function(){var i;return r.push(u(arguments)),n++,n==t?(i=e.call(this,r),n=0,r=[],i):void 0}},once:function(){return this.throttle(1/0,!0)},fill:function(){var t=this,e=u(arguments);return function(){var n=u(arguments);return e.forEach(function(t,e){(null!=t||e>=n.length)&&n.splice(e,0,t)}),t.apply(this,n)}}}),i(un,!1,!0,{random:function(t,e){var n,r;return 1==arguments.length&&(e=t,t=0),n=Bn(t||0,d(e)?1:e),r=In(t||0,d(e)?1:e)+1,Mn(cn.random()*(r-n)+n)}}),i(un,!0,!0,{log:function(t){return cn.log(this)/(t?cn.log(t):1)},abbr:function(t){return Ke(this,t,"kmbt",0,4)},metric:function(t,e){return Ke(this,t,"n\u03bcm kMGTPE",4,d(e)?1:e)},bytes:function(t,e){return Ke(this,t,"kMGTPE",0,d(e)?4:e,!0)+"B"},isInteger:function(){return 0==this%1},isOdd:function(){return!isNaN(this)&&!this.isMultipleOf(2)},isEven:function(){return this.isMultipleOf(2)},isMultipleOf:function(t){return 0===this%t},format:function(t,e,n){var r,i,o,s="";for(d(e)&&(e=","),d(n)&&(n="."),r=(xn(t)?S(this,t||0).toFixed(In(t,0)):this.toString()).replace(/^-/,"").split("."),i=r[0],o=r[1],r=i.length;r>0;r-=3)r<i.length&&(s=e+s),s=i.slice(In(0,r-3),r)+s;return o&&(s+=n+T("0",(t||0)-o.length)+o),(0>this?"-":"")+s},hex:function(t){return this.pad(t||1,!1,16)},times:function(t){if(t)for(var e=0;this>e;e++)t.call(this,e);return this.toNumber()},chr:function(){return ln.fromCharCode(this)},pad:function(t,e,n){return C(this,t,e,n)},ordinalize:function(){var t=Pn(this),t=parseInt(t.toString().slice(-2));return this+P(t)},toNumber:function(){return parseFloat(this,10)}}),function(){function t(t){return function(e){return e?S(this,e,t):t(this)}}i(un,!0,!0,{ceil:t(Ln),round:t(kn),floor:t(Mn)}),o(un,!0,!0,"abs,pow,sin,asin,cos,acos,tan,atan,exp,pow,sqrt",function(t,e){t[e]=function(t,n){return cn[e](this,t,n)}})}();var hr=["isObject","isNaN"],dr="keys values select reject each merge clone equal watch tap has toQueryString".split(" ");i(rn,!1,!0,{watch:function(t,e,n){if(fn){var r=t[e];rn.defineProperty(t,e,{enumerable:!0,configurable:!0,get:function(){return r},set:function(i){r=n.call(t,e,r,i)}})}}}),i(rn,!1,function(){return 1<arguments.length},{keys:function(t,e){var n=rn.keys(t);return n.forEach(function(n){e.call(t,n,t[n])}),n}}),i(rn,!1,!0,{isObject:function(t){return v(t)},isNaN:function(t){return xn(t)&&t.valueOf()!==t.valueOf()},equal:function(t,e){return I(t,e)},extended:function(t){return new _(t)},merge:function(t,e,n,r){var i,o,s,a,l,u,c;if(t&&"string"!=typeof e)for(i in e)if(f(e,i)&&t){if(a=e[i],l=t[i],u=h(l),o=g(a),s=g(l),c=u&&!1===r?l:a,u&&An(r)&&(c=r.call(e,i,l,a)),n&&(o||s))if(En(a))c=new an(a.getTime());else{if(!Tn(a)){s||(t[i]=on.isArray(a)?[]:{}),rn.merge(t[i],a,n,r);continue}c=new sn(a.source,R(a))}t[i]=c}return t},values:function(t,e){var n=[];return y(t,function(r,i){n.push(i),e&&e.call(t,i)}),n},clone:function(t,e){var n;if(!g(t))return t;if(n=hn.call(t),En(t,n)&&t.clone)return t.clone();if(En(t,n)||Tn(t,n))return new t.constructor(t);if(t instanceof _)n=new _;else if(Sn(t,n))n=[];else{if(!v(t,n))throw new TypeError("Clone must be a basic data type.");n={}}return rn.merge(n,t,e)},fromQueryString:function(t,e){var n=rn.extended();return t=t&&t.toString?t.toString():"",t.replace(/^.*?\?/,"").split("&").forEach(function(t){t=t.split("="),2===t.length&&Ve(n,t[0],decodeURIComponent(t[1]),e)}),n},toQueryString:function(t,e){return Ye(e,t)},tap:function(t,e){var n=e;return An(e)||(n=function(){e&&t[e]()}),n.call(t,t),t},has:function(t,e){return f(t,e)},select:function(t){return Qe(t,arguments,!0)},reject:function(t){return Qe(t,arguments,!1)}}),o(rn,!1,!0,bn,function(t,e){var n="is"+e;hr.push(n),t[n]=vn[e]}),i(rn,!1,function(){return 0===arguments.length},{extend:function(){var t=hr.concat(dr);"undefined"!=typeof Jn&&(t=t.concat(Jn)),N(t,rn)}}),N(dr,_),i(sn,!1,!0,{escape:function(t){return L(t)}}),i(sn,!0,!0,{getFlags:function(){return R(this)},setFlags:function(t){return sn(this.source,t)},addFlag:function(t){return this.setFlags(R(this,t))},removeFlag:function(t){return this.setFlags(R(this).replace(t,""))}});var fr,gr;i(ln,!0,!1,{repeat:function(t){return t=Je(t),T(this,t)}}),i(ln,!0,function(t){return Tn(t)||2<arguments.length},{startsWith:function(t){var e=arguments,n=e[1],e=e[2],r=this;return n&&(r=r.slice(n)),d(e)&&(e=!0),n=Tn(t)?t.source.replace("^",""):L(t),sn("^"+n,e?"":"i").test(r)},endsWith:function(t){var e=arguments,n=e[1],e=e[2],r=this;return h(n)&&(r=r.slice(0,n)),d(e)&&(e=!0),n=Tn(t)?t.source.replace("$",""):L(t),sn(n+"$",e?"":"i").test(r)}}),i(ln,!0,!0,{escapeRegExp:function(){return L(this)},escapeURL:function(t){return t?encodeURIComponent(this):encodeURI(this)},unescapeURL:function(t){return t?decodeURI(this):decodeURIComponent(this)},escapeHTML:function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\//g,"&#x2f;")},unescapeHTML:function(){return this.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#x2f;/g,"/").replace(/&amp;/g,"&")},encodeBase64:function(){return fr(unescape(encodeURIComponent(this)))},decodeBase64:function(){return decodeURIComponent(escape(gr(this)))},each:function(t,e){var n,r,i;if(An(t)?(e=t,t=/[\s\S]/g):t?_n(t)?t=sn(L(t),"gi"):Tn(t)&&(t=sn(t.source,R(t,"g"))):t=/[\s\S]/g,n=this.match(t)||[],e)for(r=0,i=n.length;i>r;r++)n[r]=e.call(this,n[r],r,n)||n[r];return n},shift:function(t){var e="";return t=t||0,this.codes(function(n){e+=ln.fromCharCode(n+t)}),e},codes:function(t){var e,n,r=[];for(e=0,n=this.length;n>e;e++){var i=this.charCodeAt(e);r.push(i),t&&t.call(this,i,e)}return r},chars:function(t){return this.each(t)},words:function(t){return this.trim().each(/\S+/g,t)},lines:function(t){return this.trim().each(/^.*$/gm,t)},paragraphs:function(t){var e=this.trim().split(/[\r\n]{2,}/);return e=e.map(function(e){if(t)var n=t.call(e);return n?n:e})},isBlank:function(){return 0===this.trim().length},has:function(t){return-1!==this.search(Tn(t)?t:L(t))},add:function(t,e){return e=d(e)?this.length:e,this.slice(0,e)+t+this.slice(e)},remove:function(t){return this.replace(t,"")},reverse:function(){return this.split("").reverse().join("")},compact:function(){return this.trim().replace(/([\r\n\s\u3000])+/g,function(t,e){return"\u3000"===e?e:" "})},at:function(){return H(this,arguments,!0)},from:function(t){return this.slice(nn(this,t,!0))},to:function(t){return d(t)&&(t=this.length),this.slice(0,nn(this,t))},dasherize:function(){return this.underscore().replace(/_/g,"-")},underscore:function(){return this.replace(/[-\s]+/g,"_").replace(ln.Inflector&&ln.Inflector.acronymRegExp,function(t,e){return(e>0?"_":"")+t.toLowerCase()}).replace(/([A-Z\d]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").toLowerCase()},camelize:function(t){return this.underscore().replace(/(^|_)([^_]+)/g,function(e,n,r,i){return e=(e=ln.Inflector)&&e.acronyms[r],e=_n(e)?e:void 0,i=!1!==t||i>0,e?i?e:e.toLowerCase():i?r.capitalize():r})},spacify:function(){return this.underscore().replace(/_/g," ")},stripTags:function(){var t=this;return c(0<arguments.length?arguments:[""],function(e){t=t.replace(sn("</?"+L(e)+"[^<>]*>","gi"),"")}),t},removeTags:function(){var t=this;return c(0<arguments.length?arguments:["\\S+"],function(e){e=sn("<("+e+")[^<>]*(?:\\/>|>.*?<\\/\\1>)","gi"),t=t.replace(e,"")}),t},truncate:function(t,e,n){return tn(this,t,e,n)},truncateOnWord:function(t,e,n){return tn(this,t,e,n,!0)},pad:function(t,e){var n,r;return t=Je(t),n=In(0,t-this.length)/2,r=Mn(n),n=Ln(n),Ze(r,e)+this+Ze(n,e)},padLeft:function(t,e){return t=Je(t),Ze(In(0,t-this.length),e)+this},padRight:function(t,e){return t=Je(t),this+Ze(In(0,t-this.length),e)},first:function(t){return d(t)&&(t=1),this.substr(0,t)},last:function(t){return d(t)&&(t=1),this.substr(0>this.length-t?0:this.length-t)},toNumber:function(t){return A(this,t)},capitalize:function(t){var e;return this.toLowerCase().replace(t?/[^']/g:/^\S/,function(t){var n,r=t.toUpperCase();return n=e?t:r,e=r!==t,n})},assign:function(){var t={};return c(arguments,function(e,n){g(e)?w(t,e):t[n+1]=e}),this.replace(/\{([^{]+?)\}/g,function(e,n){return f(t,n)?t[n]:e})}}),i(ln,!0,!0,{insert:ln.prototype.add}),function(t){if(pn.btoa)fr=pn.btoa,gr=pn.atob;else{var e=/[^A-Za-z0-9\+\/\=]/g;fr=function(e){var n,r,i,o,s,a,l="",u=0;do n=e.charCodeAt(u++),r=e.charCodeAt(u++),i=e.charCodeAt(u++),o=n>>2,n=(3&n)<<4|r>>4,s=(15&r)<<2|i>>6,a=63&i,isNaN(r)?s=a=64:isNaN(i)&&(a=64),l=l+t.charAt(o)+t.charAt(n)+t.charAt(s)+t.charAt(a);while(u<e.length);return l},gr=function(n){var r,i,o,s,a,l="",u=0;if(n.match(e))throw Error("String contains invalid base64 characters");n=n.replace(/[^A-Za-z0-9\+\/\=]/g,"");do r=t.indexOf(n.charAt(u++)),i=t.indexOf(n.charAt(u++)),s=t.indexOf(n.charAt(u++)),a=t.indexOf(n.charAt(u++)),r=r<<2|i>>4,i=(15&i)<<4|s>>2,o=(3&s)<<6|a,l+=ln.fromCharCode(r),64!=s&&(l+=ln.fromCharCode(i)),64!=a&&(l+=ln.fromCharCode(o));while(u<n.length);return l}}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=")}(),$(function(){window.currentPlayer={id:-1};var t="",e=0;if(void 0!==window.customcharsheet_translation&&(i18n.translator.add(JSON.parse(BASE64.decode(window.customcharsheet_translation))),console.log("Custom Sheet Translation")),void 0!==window.customcharsheet_html){d20.journal.useCustomSheets=!0,d20.journal.customSheets={};var n=function(t,e,n){n||void 0===e||(t=html_sanitize(t,function(t){var e=t.toString(),n="https://s3.amazonaws.com/files.d20.io";return e.substring(0,n.length)===n?e:/^https?:\/\//.test(e)?"http://imgsrv.roll20.net/?src="+escape(e.replace("http://","").replace("https://","")):""},function(t){var e=t.split(" ");return _.each(e,function(t,n){e[n]="attr_"===t.substring(0,5)||"sheet-"===t.substring(0,6)||"repeating_"===t.substring(0,10)||"roll_"===t.substring(0,5)||"tokenaction"===t?t:"sheet-"+t}),e.join(" ")})),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var r=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(i,"").replace(r,function(t,n){return e.indexOf("<"+n.toLowerCase()+">")>-1?t:""})};console.log("Compiling sheet..."),d20.journal.customSheets.rollTemplates={};var r=BASE64.decode(customcharsheet_html),i=/(<rolltemplate [^>]+>)([\s\S]*?)(<\/rolltemplate>)/gi,o=/(class=\"sheet-rolltemplate-)([^\"]+)(\">)/i;r=r.replace(i,function(t){var e=o.exec(t);if(e&&e.length>3){console.log("Found rolltemplate: "+e[2]);var r=e[2],i=arguments[2];i=n(i,"<br><input><textarea><div><span><label><hr><img><b><i><strong><em><h1><h2><h3><h4><h5><h6><p><hr><table><tr><td><tbody><thead><th><tfoot><select><option><fieldset><button><ul><li><ol><caption>"),d20.journal.customSheets.rollTemplates[r]=i}return""}),d20.journal.customSheets.layouthtml=n(r,"<br><input><textarea><div><span><label><hr><img><b><i><strong><em><h1><h2><h3><h4><h5><h6><p><hr><table><tr><td><tbody><thead><th><tfoot><select><option><fieldset><button><ul><li><ol><caption>");var s=$("<div class='root'>"+d20.journal.customSheets.layouthtml+"</div>");console.log("Finding sheet rolls..."),d20.journal.customSheets.availableRolls={},d20.journal.customSheets.availableAttributes={},d20.journal.customSheets.reservedAttributes={},d20.journal.customSheets.tokenActions=[],d20.journal.customSheets.attrDeps={};var a=/@{[^}]+}/g;d20.journal.updateSheetDeps=function(t,e){var n=e.match(a);if(!n)return!0;for(var r=0;r<n.length;r++){var i=n[r].substring(2,n[r].length-1).toLowerCase();d20.journal.customSheets.attrDeps[i]||(d20.journal.customSheets.attrDeps[i]=[]),-1===d20.journal.customSheets.attrDeps[i].indexOf(t.toLowerCase())&&d20.journal.customSheets.attrDeps[i].push(t.toLowerCase())}},s.find("button[type=roll]").each(function(){var t=$(this),e=t.parents("fieldset").length>0?!1:!0;e&&void 0!==t.attr("name")&&(d20.journal.customSheets.availableRolls[t.attr("name").substring(5,t.attr("name").length).toLowerCase()]=t.attr("value").split("\\n").join("\n"),t.hasClass("tokenaction")&&d20.journal.customSheets.tokenActions.push(t.attr("name").substring(5,t.attr("name").length).toLowerCase())),t.addClass("btn")}),d20.journal.customSheets.tokenActions=_.sortBy(d20.journal.customSheets.tokenActions,function(t){return t}),s.find('*[name^="attr_"]').each(function(){var t=$(this),e=t.parents("fieldset"),n="";if(e.length>0){var r,i=e[0].classList;_.each(i,function(t){return"repeating_"===t.substring(0,10)?(r=t.toLowerCase().replace("'","&quot;"),!1):void 0}),r&&(n=r+"_")}var o=n+t.attr("name").substring(5,t.attr("name").length).toLowerCase();if("input"===this.tagName.toLowerCase()&&"checkbox"===t.attr("type")&&void 0!==t.attr("value"))d20.journal.customSheets.availableAttributes[o]=t.attr("checked")?t.attr("value")||"":"0";else if("input"===this.tagName.toLowerCase()&&"radio"===t.attr("type")&&void 0!==t.attr("value"))t.attr("checked")&&(d20.journal.customSheets.availableAttributes[o]=t.attr("value")||"");else if(t.attr("disabled")){if(!this.attributes.value)return console.log("SHEET ERROR: Specified a disabled input without a valid formula in the value attribute."),!0;d20.journal.customSheets.availableAttributes[o]=this.attributes.value.nodeValue||"",d20.journal.updateSheetDeps(o,d20.journal.customSheets.availableAttributes[o]),t.attr("data-formula",this.attributes.value.nodeValue),d20.journal.customSheets.reservedAttributes[o]=!0}else d20.journal.customSheets.availableAttributes[o]=t.attr("value")||"";t.attr("disabled")||"string"!=typeof t.attr("value")||-1===t.attr("value").indexOf("@{")||d20.journal.updateSheetDeps(o,t.attr("value"))}),d20.journal.customSheets.layouthtml=s.html(),n=function(t,e){t=t.replace(/\/\*[^\*]+\*\//g,""),t=t.replace(/([^{]+){[^}]*}/gi,function(t,e){e=$.trim(e);for(var n=e.split(","),r="",i=0;i<n.length;i++)n[i]=$.trim(n[i]),"#"===n[i].substring(0,1)&&(n[i]=n[i].replace("#",".")),".charsheet "!==n[i].substring(0,11)&&".charsheet"!==n[i]&&"@font-face"!==n[i]&&".sheet-rolltemplate-"!==n[i].substring(0,20)&&(n[i]=".charsheet "+n[i]);return r=n.join(","),t=t.replace(e,r)});for(var n=[/(\bdata:\b|eval|cookie|\bwindow\b|\bparent\b|\bthis\b)/i,/behaviou?r|expression|moz-binding|@import|@charset|javascript|vbscript|[\<]|\\\w/i,/[\x7f-\xff]/,/[\x00-\x08\x0B\x0C\x0E-\x1F]/,/&\#/],r=0;r<n.length;r++)t.match(n[r])&&(console.log(t.match(n[r])),console.error("Potential CSS security violation; character sheet template styling thrown out."),t="");t=t.replace(/url[\s]*\([^\)]+\)/gi,function(t){t=t.replace(/\s/gi,""),t=t.replace("url(","");var e=t.split(")");t=e[e.length-2],t=t.replace(/'/gi,""),t=t.replace(/"/gi,"");var n="https://s3.amazonaws.com/files.d20.io";return t.substring(0,n.length)===n?"url('"+t+"')":/^https?:\/\//.test(t)?"url('http://imgsrv.roll20.net/?src="+escape($.trim(t.replace("http://","").replace("https://","")))+"')":""}),e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var i=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,o=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return t.replace(o,"").replace(i,function(t,n){return e.indexOf("<"+n.toLowerCase()+">")>-1?t:""})};var l,u=document.head||document.getElementsByTagName("head")[0],c=document.createElement("style");l=n(BASE64.decode(customcharsheet_css)),c.type="text/css",c.styleSheet?c.styleSheet.cssText=l:c.appendChild(document.createTextNode(l)),u.appendChild(c),d20.journal.customSheets.styleel=c}var p=function(n){var r=n.type;if("gmrollresult"==n.type){if(!window.is_gm&&n.playerid!=window.currentPlayer.id)return console.log("ignoring message, not gm, and not original player."),"";r="rollresult"}if("whisper"==n.type){if(1==window.NOWHISPERS)return"";if(n.playerid==window.currentPlayer.id)r="whispersent";else{if(r="whisperreceived","gm"==n.target){if(!window.is_gm)return""}else if(n.target!=window.currentPlayer.id)return"";lastWhisperReceived=n}}"rollresult"==r&&n.origRoll?(r="newroll",n.htmlcontent=d20.dice_formatter.getHtmlForResult(JSON.parse(n.content)),n.sanitizedOrigRoll=d20.dice_formatter.replaceInlineRolls(n.origRoll,n)):"rollresult"==r&&"object"==typeof n.content&&(n.content=n.content.origformula+"|"+n.content.formula+"|"+n.content.total),n.rolltemplate||"rollresult"==r||"newroll"==r||"tokenroll"==r||"direct"==r||(n.content=Markdown.parse(n.content+"").autoLink());var i=$("#tmpl_chatmessage_"+r);if((n.who!==t||e>5)&&(n.showname=!0,e=0),n.rolltemplate){for(var o,s={},a=/{{([\s\S]*?}?)}}/gi;null!=(o=a.exec(n.content));){o.index===a.lastIndex&&a.lastIndex++;var l=o[1]+"",u=l.split("=");s[u[0]]=l.substring(u[0].length+1,l.length)}$.each(s,function(t,e){s[t]=e.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,'<span style="color: red;">['+e+"]</span>")});var n=t.replace(/\^{([^}]+)}/g,function(t,e){return e=$.trim(e),i18n(e,"["+e+"]")});n!==t&&(s[n]=s[t],delete s[t])}),s["rollWasCrit()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==s[i]&&"string"==typeof s[i]){var o=s[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"crit"))return e(t)}}catch(a){console.log("Error while checking for crit in roll...")}return null}},s["rollWasFumble()"]=function(){return function(t,e,r){try{var i=r.join(" ");if(void 0!==s[i]&&"string"==typeof s[i]){var o=s[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[o]&&d20.dice_formatter.checkForCrits(n.inlinerolls[o].results.rolls,"fumble"))return e(t)}}catch(a){console.log("Error while checking for fumble in roll...")}return null}},s["rollTotal()"]=function(){return function(t,e,r){try{var i=r[0],o=r[1];if(void 0!==s[i]&&"string"==typeof s[i]){var a=s[i].split("$[[")[1].split("]]")[0];if(n.inlinerolls[a]&&n.inlinerolls[a].results.total===parseInt(o,10))return e(t)}}catch(l){console.log("Error while checking for roll total...")}return null}},s["allprops()"]=function(){return function(t,e,n){try{var r="";for(var i in s)"name"!==i&&-1===n.indexOf(i)&&"function"!=typeof s[i]&&(r+=e(t.replace("{{key}}",ucfirst(i)).replace("{{value}}",s[i])));return r}catch(o){console.log("Error enumerating all properties")}return null}};var c="";if(d20.journal&&d20.journal.customSheets&&d20.journal.customSheets.rollTemplates[n.rolltemplate])c="<div class='sheet-rolltemplate-"+n.rolltemplate+"'>"+d20.journal.customSheets.rollTemplates[n.rolltemplate]+"</div>";else{var p=$("#sheet-rolltemplate-"+n.rolltemplate);0===p.length?console.error("Didn't find a roll template called '"+n.rolltemplate+"'"):c="<div class='"+p.attr("id")+"'>"+p.html()+"</div>"}n.content=Mustache.render(c,s),n.content=Markdown.parse(n.content),n.content=d20.utils.htmlTranslator(n.content,!0)}var h=i.jqote(n);return t="emote"==n.type||"gmrollresult"==n.type||"whisper"==n.type?"":n.who,e++,h},h=function(){function t(){return console.log("autograv"),$(this).hasClass("tipsy-w")?"w":$(this).hasClass("tipsy-e")?"e":$(this).hasClass("tipsy-n")?"n":$(this).hasClass("tipsy-s")?"s":$(this).hasClass("tipsy-side")?$(this).offset().left>$(document).scrollLeft()+$(window).width()/2?"e":"w":$(this).offset().top>$(document).scrollTop()+$(window).height()/2?"s":"n"}for(var e="",n=[],r=[],i=BASE64.decode(msgdata),o=JSON.parse(i),s=0;s<o.length;s++)for(var a in o[s]){if(o[s][a].timestamp=o[s][a][".priority"],o[s][a].timestamp){var l=o[s][a].timestamp,u=Date.create(l),c=(new Date).getTime();o[s][a].timestamp=u.format(864e5>c-l?"{h}:{mm}{TT}":"{{Month}} {{dd}}, {{yyyy}} {h}:{mm}{TT}")}else o[s][a].timestamp="";o[s][a].id=a,void 0!==o[s][a][".priority"]?r.push(o[s][a]):n.push(o[s][a])}n=_.sortBy(n,function(t){return t.id}),r=_.sortBy(r,function(t){return t[".priority"]});for(var s=0;s<n.length;s++)try{e+=p(n[s])}catch(h){console.log("ERROR with message "+n[s].id),console.log(h)}for(var s=0;s<r.length;s++)try{e+=p(r[s])}catch(h){console.log("ERROR with message "+r[s].id),console.log(h)}$("#textchat .content").html(e),$(".showtip").tipsy({live:!0,gravity:t,opacity:1,html:!0})};h()}),function(t){function e(e,n){this.$element=t(e),this.options=n,this.enabled=!0,this.fixTitle()}e.prototype={show:function(){var e=this.getTitle();if("noshow"!=e&&e&&this.enabled){var n=this.tip(),r=t("body"),i=0,o=0;this.$element.parents("#editor-wrapper").length>0&&(r=t("#editor-wrapper"),i=r.scrollTop(),o=r.scrollLeft());var s=this.$element.parents("body");s.hasClass("popoutwindow")&&(r=s),this.options.filterhtml&&(e=d20ext.utils.strip_tags(e,"<span><br><strong><em>")),n.find(".tipsy-inner")[this.options.html?"html":"text"](e),n[0].className="tipsy",n.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).appendTo(r);var a=t.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight});a.top=a.top+i,a.left=a.left+o;var l,u=n[0].offsetWidth,c=n[0].offsetHeight,p="function"==typeof this.options.gravity?this.options.gravity.call(this.$element[0]):this.options.gravity;switch(p.charAt(0)){case"n":l={top:a.top+a.height+this.options.offset,left:a.left+a.width/2-u/2};break;case"s":l={top:a.top-c-this.options.offset,left:a.left+a.width/2-u/2};break;case"e":l={top:a.top+a.height/2-c/2,left:a.left-u-this.options.offset};break;case"w":l={top:a.top+a.height/2-c/2,left:a.left+a.width+this.options.offset}}2==p.length&&(l.left="w"==p.charAt(1)?a.left+a.width/2-15:a.left+a.width/2-u+15),n.css(l).addClass("tipsy-"+p),this.options.fade?n.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):n.css({visibility:"visible",opacity:this.options.opacity}),n.on("mousedown",".noshow",function(){var e=t(this).attr("data-tutorial");return window.ignore_tutorials.push(e),t(".tipsy").remove(),t.post("/editor/disable_tutorial/"+e),!1})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){t(this).remove()}):this.tip().remove()},fixTitle:function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("original-title"))&&t.attr("original-title",t.attr("title")||"").removeAttr("title")},getTitle:function(){var t,e=this.$element,n=this.options;this.fixTitle();var t,n=this.options;return"string"==typeof n.title?t=e.attr("title"==n.title?"original-title":n.title):"function"==typeof n.title&&(t=n.title.call(e[0])),t=(""+t).replace(/(^\s*|\s*$)/,""),t||n.fallback},tip:function(){return this.$tip||(this.$tip=t('<div class="tipsy"></div>').html(this.options.userscript?'<div class="tipsy-arrow"></div><div class="tipsy-inner userscript-tipsy-inner"></div><div class="tipsy-userscript-warning">API or player-generated content</div>':'<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},t.fn.tipsy=function(n){function r(r){var i=t.data(r,"tipsy");return i||(i=new e(r,t.fn.tipsy.elementOptions(r,n)),t.data(r,"tipsy",i)),i}function i(){var t=r(this);t.hoverState="in",0==n.delayIn?t.show():(t.fixTitle(),setTimeout(function(){"in"==t.hoverState&&t.show()},n.delayIn))}function o(){var t=r(this);t.hoverState="out",0==n.delayOut?t.hide():setTimeout(function(){"out"==t.hoverState&&t.hide()},n.delayOut)}if(n===!0)return this.data("tipsy");if("string"==typeof n){var s=this.data("tipsy");return s&&s[n](),this}if(n=t.extend({},t.fn.tipsy.defaults,n),n.live||this.each(function(){r(this)}),"manual"!=n.trigger){var a=n.live?"live":"bind",l="hover"==n.trigger?"mouseenter":"focus",u="hover"==n.trigger?"mouseleave":"blur";this[a](l,i)[a](u,o)}return this},t.fn.tipsy.defaults={delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.9,title:"title",trigger:"hover",conatinerel:!1},t.fn.tipsy.elementOptions=function(e,n){return t.metadata?t.extend({},n,t(e).metadata()):n},t.fn.tipsy.autoNS=function(){return t(this).offset().top>t(document).scrollTop()+t(window).height()/2?"s":"n"},t.fn.tipsy.autoWE=function(){return t(this).offset().left>t(document).scrollLeft()+t(window).width()/2?"e":"w"}}(jQuery);